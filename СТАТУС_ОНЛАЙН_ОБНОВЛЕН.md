# ‚úÖ –°–¢–ê–¢–£–° –û–ù–õ–ê–ô–ù –û–ë–ù–û–í–õ–ï–ù –ù–ê 40 –°–ï–ö–£–ù–î

**–î–∞—Ç–∞:** 20 –æ–∫—Ç—è–±—Ä—è 2025, 22:00  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–û–ë–ù–û–í–õ–ï–ù–û**

---

## üéØ –ß–¢–û –ò–ó–ú–ï–ù–ï–ù–û

### –¢–∞–π–º–∞—É—Ç offline —Å—Ç–∞—Ç—É—Å–∞: 30 ‚Üí 40 —Å–µ–∫—É–Ω–¥

–¢–µ–ø–µ—Ä—å —É–∑–µ–ª –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ **offline** —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ **40 —Å–µ–∫—É–Ω–¥** –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è (—Ä–∞–Ω—å—à–µ –±—ã–ª–æ 30 —Å–µ–∫—É–Ω–¥).

---

## üìù –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

### 1. `server/backend/config/hydro.php`

**–ë—ã–ª–æ:**
```php
'node_offline_timeout' => env('NODE_OFFLINE_TIMEOUT', 30),
```

**–°—Ç–∞–ª–æ:**
```php
'node_offline_timeout' => env('NODE_OFFLINE_TIMEOUT', 40),
```

---

### 2. `server/backend/app/Models/Node.php`

#### a) –ú–µ—Ç–æ–¥ `isOnline()`:

**–ë—ã–ª–æ:**
```php
/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∑–µ–ª –æ–Ω–ª–∞–π–Ω?
 * –°—á–∏—Ç–∞–µ—Ç—Å—è –æ–Ω–ª–∞–π–Ω –µ—Å–ª–∏ last_seen_at < 30 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 */
public function isOnline(): bool
{
    $timeout = config('hydro.node_offline_timeout', 30);
    return $this->last_seen_at->diffInSeconds(now()) < $timeout;
}
```

**–°—Ç–∞–ª–æ:**
```php
/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∑–µ–ª –æ–Ω–ª–∞–π–Ω?
 * –°—á–∏—Ç–∞–µ—Ç—Å—è –æ–Ω–ª–∞–π–Ω –µ—Å–ª–∏ last_seen_at < 40 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
 */
public function isOnline(): bool
{
    $timeout = config('hydro.node_offline_timeout', 40);
    return $this->last_seen_at->diffInSeconds(now()) < $timeout;
}
```

---

#### b) –ú–µ—Ç–æ–¥ `getStatusColorAttribute()`:

**–ë—ã–ª–æ:**
```php
if ($seconds < 30) return 'green';  // –ó–µ–ª–µ–Ω—ã–π
if ($seconds < 60) return 'orange'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
return 'red';                        // –ö—Ä–∞—Å–Ω—ã–π
```

**–°—Ç–∞–ª–æ:**
```php
if ($seconds < 40) return 'green';  // –û–Ω–ª–∞–π–Ω: < 40 —Å–µ–∫—É–Ω–¥
if ($seconds < 80) return 'orange'; // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: 40-80 —Å–µ–∫—É–Ω–¥  
return 'red';                        // –û—Ñ–ª–∞–π–Ω: > 80 —Å–µ–∫—É–Ω–¥
```

**–õ–æ–≥–∏–∫–∞ —Ü–≤–µ—Ç–æ–≤:**
- üü¢ **–ó–µ–ª–µ–Ω—ã–π** (online): –ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å < 40 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
- üü† **–û—Ä–∞–Ω–∂–µ–≤—ã–π** (warning): –ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 40-80 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
- üî¥ **–ö—Ä–∞—Å–Ω—ã–π** (offline): –ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å > 80 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥

---

#### c) Scope `scopeOnline()`:

**–ë—ã–ª–æ:**
```php
public function scopeOnline($query)
{
    $timeout = config('hydro.node_offline_timeout', 30);
    return $query->where('last_seen_at', '>', now()->subSeconds($timeout));
}
```

**–°—Ç–∞–ª–æ:**
```php
public function scopeOnline($query)
{
    $timeout = config('hydro.node_offline_timeout', 40);
    return $query->where('last_seen_at', '>', now()->subSeconds($timeout));
}
```

---

#### d) Scope `scopeOffline()`:

**–ë—ã–ª–æ:**
```php
public function scopeOffline($query)
{
    $timeout = config('hydro.node_offline_timeout', 30);
    // ...
}
```

**–°—Ç–∞–ª–æ:**
```php
public function scopeOffline($query)
{
    $timeout = config('hydro.node_offline_timeout', 40);
    // ...
}
```

---

### 3. `server/backend/app/Console/Commands/CheckNodesStatusCommand.php`

**–ë—ã–ª–æ:**
```php
$timeout = config('hydro.node_offline_timeout', 30);
```

**–°—Ç–∞–ª–æ:**
```php
$timeout = config('hydro.node_offline_timeout', 40);
```

---

## üìä –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£–∑–µ–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ

```
T=0s:   –£–∑–µ–ª –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é ‚Üí last_seen_at = now()
        –°—Ç–∞—Ç—É—Å: üü¢ ONLINE (–∑–µ–ª–µ–Ω—ã–π)

T=20s:  –ü—Ä–æ—à–ª–æ 20 —Å–µ–∫—É–Ω–¥
        –°—Ç–∞—Ç—É—Å: üü¢ ONLINE (–∑–µ–ª–µ–Ω—ã–π, < 40 —Å–µ–∫)

T=39s:  –ü—Ä–æ—à–ª–æ 39 —Å–µ–∫—É–Ω–¥
        –°—Ç–∞—Ç—É—Å: üü¢ ONLINE (–∑–µ–ª–µ–Ω—ã–π, < 40 —Å–µ–∫)

T=40s:  –ü—Ä–æ—à–ª–æ 40 —Å–µ–∫—É–Ω–¥
        –°—Ç–∞—Ç—É—Å: üü† WARNING (–æ—Ä–∞–Ω–∂–µ–≤—ã–π, 40-80 —Å–µ–∫)

T=79s:  –ü—Ä–æ—à–ª–æ 79 —Å–µ–∫—É–Ω–¥
        –°—Ç–∞—Ç—É—Å: üü† WARNING (–æ—Ä–∞–Ω–∂–µ–≤—ã–π, 40-80 —Å–µ–∫)

T=80s:  –ü—Ä–æ—à–ª–æ 80 —Å–µ–∫—É–Ω–¥
        –°—Ç–∞—Ç—É—Å: üî¥ OFFLINE (–∫—Ä–∞—Å–Ω—ã–π, > 80 —Å–µ–∫)
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–∏–ª–æ—Å—å

```
T=0s:   –£–∑–µ–ª –æ—Ç–ø—Ä–∞–≤–∏–ª –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é
        last_seen_at = "2025-10-20 22:00:00"
        –°—Ç–∞—Ç—É—Å: üü¢ ONLINE

T=40s:  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–∏–ª–æ—Å—å, –ø—Ä–æ—à–ª–æ 40 —Å–µ–∫—É–Ω–¥
        Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: last_seen_at < 40 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥? ‚ùå –ù–ï–¢
        –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è: üü† WARNING (–æ—Ä–∞–Ω–∂–µ–≤—ã–π)
        
        –í API: online = false (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ offline, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∞–Ω–∂–µ–≤—ã–º)

T=80s:  –ü—Ä–æ—à–ª–æ 80 —Å–µ–∫—É–Ω–¥
        –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è: üî¥ OFFLINE (–∫—Ä–∞—Å–Ω—ã–π)
```

---

## üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê

### Scheduled Task: `nodes:check-status`

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É** –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ —É–∑–ª—ã:

```php
// routes/console.php
Schedule::command('nodes:check-status --notify')
    ->everyMinute()
    ->withoutOverlapping();
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —É–∑–ª—ã –∏–∑ –ë–î
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `$node->isOnline()`
3. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ `online` –≤ –ë–î
4. –ï—Å–ª–∏ —É–∑–µ–ª —Å—Ç–∞–ª offline ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ (event)
5. –ï—Å–ª–∏ —Ñ–ª–∞–≥ `--notify` ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´

### 1. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
docker exec hydro_backend php artisan tinker

# –í tinker:
config('hydro.node_offline_timeout')
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: 40
```

---

### 2. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å —É–∑–ª–∞:

```bash
docker exec hydro_backend php artisan tinker

# –í tinker:
$node = \App\Models\Node::first();
$node->last_seen_at;          // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
$node->isOnline();            // true/false
$node->status_color;          // 'green'/'orange'/'red'/'grey'
```

---

### 3. –ü—Ä–æ–≤–µ—Ä—å —á–µ—Ä–µ–∑ API:

```bash
curl http://localhost:8000/api/nodes
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "data": [
    {
      "node_id": "root_98a316f5fde8",
      "online": true,
      "last_seen_at": "2025-10-20T22:00:00.000000Z",
      "status_color": "green"
    }
  ]
}
```

---

### 4. –ü—Ä–æ–≤–µ—Ä—å scheduled task:

```bash
docker exec hydro_backend php artisan nodes:check-status

# –î–æ–ª–∂–µ–Ω –≤—ã–≤–µ—Å—Ç–∏:
# Checking nodes status...
# ‚úÖ root_98a316f5fde8 - ONLINE
# ...
```

---

## üìà –¢–ê–ô–ú–õ–ê–ô–ù –°–¢–ê–¢–£–°–û–í

| –í—Ä–µ–º—è | –¶–≤–µ—Ç | –°—Ç–∞—Ç—É—Å | online | status_color |
|-------|------|--------|--------|--------------|
| 0-39s | üü¢ | Online | true | green |
| 40-79s | üü† | Warning | false | orange |
| 80s+ | üî¥ | Offline | false | red |
| –ù–∏–∫–æ–≥–¥–∞ | ‚ö™ | Unknown | false | grey |

---

## üéØ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô

### Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω:

```bash
docker-compose restart backend mqtt_listener
```

**–°—Ç–∞—Ç—É—Å:**
- ‚úÖ `hydro_backend` - –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- ‚úÖ `hydro_mqtt_listener` - –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω

–ù–æ–≤—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û

### –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ .env:

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –±–µ–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞, –¥–æ–±–∞–≤—å –≤ `.env`:

```env
NODE_OFFLINE_TIMEOUT=40
```

–¢–æ–≥–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `.env` –±—É–¥–µ—Ç –∏–º–µ—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∑–Ω–∞—á–µ–Ω–∏–µ–º –≤ `config/hydro.php`.

---

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:

–û—Ç–∫—Ä–æ–π –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:3000

**–ß—Ç–æ —É–≤–∏–¥–∏—à—å:**
- üü¢ –ó–µ–ª–µ–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∑–ª–∞ = online (< 40 —Å–µ–∫—É–Ω–¥)
- üü† –û—Ä–∞–Ω–∂–µ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∑–ª–∞ = warning (40-80 —Å–µ–∫—É–Ω–¥)
- üî¥ –ö—Ä–∞—Å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∑–ª–∞ = offline (> 80 —Å–µ–∫—É–Ω–¥)

**–ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
- –ß–µ—Ä–µ–∑ 40 —Å–µ–∫—É–Ω–¥ ‚Üí –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞–Ω–µ—Ç –æ—Ä–∞–Ω–∂–µ–≤–æ–π
- –ß–µ—Ä–µ–∑ 80 —Å–µ–∫—É–Ω–¥ ‚Üí –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞–Ω–µ—Ç –∫—Ä–∞—Å–Ω–æ–π

---

## ‚úÖ –ò–¢–û–ì

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–æ | –ü–æ—Å–ª–µ |
|----------|-----|--------|
| **–¢–∞–π–º–∞—É—Ç online** | 30 —Å–µ–∫ | 40 —Å–µ–∫ ‚úÖ |
| **–ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç** | < 30 —Å–µ–∫ | < 40 —Å–µ–∫ ‚úÖ |
| **–û—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç** | 30-60 —Å–µ–∫ | 40-80 —Å–µ–∫ ‚úÖ |
| **–ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç** | > 60 —Å–µ–∫ | > 80 —Å–µ–∫ ‚úÖ |

**–í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´ –ò –†–ê–ë–û–¢–ê–Æ–¢!** ‚úÖ

–¢–µ–ø–µ—Ä—å —É–∑–µ–ª –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ offline —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 40 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

---

**–ê–≤—Ç–æ—Ä:** AI Assistant (Claude Sonnet 4.5)  
**–î–∞—Ç–∞:** 20.10.2025 22:00  
**–í–µ—Ä—Å–∏—è:** Timeout Update v1.0

