# 📐 ПРОСТАЯ АРХИТЕКТУРА

**Как все работает (просто и понятно)**

---

## 🎯 ДВЕ ЧАСТИ СИСТЕМЫ

### 1️⃣ СЕРВЕР (на ПК) - 🐳 В DOCKER

```
┌─────────────────────────────────────┐
│     ВАШ ПК / СЕРВЕР                 │
│                                     │
│  ╔═══════════════════════════════╗ │
│  ║       DOCKER                  ║ │
│  ║                               ║ │
│  ║  📡 Mosquitto MQTT :1883      ║ │
│  ║  🔧 Laravel API :8000          ║ │
│  ║      └─ SQLite БД             ║ │
│  ║  📊 Vue.js Web :3000           ║ │
│  ║                               ║ │
│  ╚═══════════════════════════════╝ │
│                                     │
└─────────────────────────────────────┘
           ↕ WiFi + MQTT
┌─────────────────────────────────────┐
│       ТЕПЛИЦА                       │
│                                     │
│  🔌 ESP32-S3 ROOT                   │
│      ↓ mesh                         │
│  🌡️  ESP32 Climate                  │
│  🧪 ESP32-S3 pH/EC                  │
│  🪟 ESP32 Relay                     │
│                                     │
└─────────────────────────────────────┘
```

---

## 📦 ЧТО ГДЕ НАХОДИТСЯ

### 🐳 В DOCKER (сервер):

| Компонент | Что делает | Порт |
|-----------|------------|------|
| **Mosquitto** | MQTT broker (принимает от ESP32) | 1883 |
| **Laravel** | Backend API (обработка данных) | 8000 |
| **SQLite** | База данных (внутри backend, файл) | - |
| **MQTT Listener** | Слушает MQTT (сохраняет в БД) | - |
| **Vue.js** | Веб-интерфейс (графики, управление) | 3000 |

**Запуск:**
```cmd
docker-start.bat
```

---

### 🔌 НА ESP32 (железо):

| Узел | Что делает | Прошивка |
|------|------------|----------|
| **ROOT** | Координатор mesh + MQTT клиент | `cd root_node` → `idf.py flash` |
| **Climate** | Датчики (temp, humidity, CO2, lux) | `cd node_climate` → `idf.py flash` |
| **pH/EC** | pH/EC датчики + 5 насосов | `cd node_ph_ec` → `idf.py flash` |
| **Relay** | Форточки, вентиляция, свет | `cd node_relay` → `idf.py flash` |
| **Display** | TFT дисплей с информацией | `cd node_display` → `idf.py flash` |
| **Water** | Полив (насосы + клапаны) | `cd node_water` → `idf.py flash` |

**Это физические устройства в теплице!**

---

## 🔗 КАК ОНИ СВЯЗАНЫ

### Поток данных:

```
1. NODE Climate читает датчики
   └─ Temp: 24.5°C, Humidity: 65%, CO2: 450ppm

2. Отправка через mesh на ROOT
   └─ mesh_manager_send_to_root(data)

3. ROOT получает и отправляет в MQTT
   └─ mqtt_publish("hydro/telemetry", data)

4. MQTT в Docker получает
   └─ Mosquitto :1883

5. MQTT Listener (PHP) обрабатывает
   └─ Сохранение в SQLite

6. Frontend показывает
   └─ http://localhost:3000 (графики)
```

---

## ⚙️ НАСТРОЙКА

### 1. Запустите Docker на ПК:

```cmd
cd server
docker-start.bat
```

**Проверьте:** http://localhost:3000

### 2. Узнайте IP вашего ПК:

```cmd
ipconfig
# Пример: 192.168.1.100
```

### 3. Настройте ROOT узел:

**Файл:** `root_node/components/mqtt_client/mqtt_client_manager.c`

```c
#define MQTT_BROKER_URI "mqtt://192.168.1.100:1883"
//                              ↑↑↑
//                         ВАШ IP ЗДЕСЬ!
```

### 4. Прошейте ROOT:

```bash
cd root_node
idf.py build flash monitor
```

**В логах должно быть:**
```
I mqtt_manager: MQTT connected to broker
```

### 5. Прошейте другие узлы:

```bash
cd node_climate
idf.py build flash
```

**Готово! Данные пойдут в веб-интерфейс!**

---

## 🎯 ПРОСТОЕ ОБЪЯСНЕНИЕ

### Docker:
- **Сервер на вашем ПК**
- **Веб-сайт для просмотра данных**
- **База данных для хранения**
- **MQTT для приема от ESP32**

### ESP32:
- **Микроконтроллеры в теплице**
- **Читают датчики**
- **Управляют насосами/форточками**
- **Отправляют данные на сервер**

### Связь:
- **WiFi** (ESP32 → роутер → ПК)
- **MQTT** (протокол обмена)

---

## ✅ ВСЕ ЯСНО!

**Docker = сервер (ПК)**  
**ESP32 = железо (теплица)**  
**Связь = WiFi + MQTT**

**Запуск:**
1. `docker-start.bat` - запуск сервера
2. `idf.py flash` - прошивка ESP32
3. ESP32 подключится автоматически

🎉 **Система работает!**

---

**Дата:** 2025-10-18

