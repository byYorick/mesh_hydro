<template>
  <v-card>
    <v-card-title class="bg-telegram">
      <v-icon icon="mdi-telegram" class="mr-2"></v-icon>
      –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      
      <v-spacer></v-spacer>
      
      <v-chip :color="isConfigured ? 'success' : 'warning'" variant="elevated">
        <v-icon :icon="isConfigured ? 'mdi-check-circle' : 'mdi-alert-circle'" start></v-icon>
        {{ isConfigured ? '–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ' : '–¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏' }}
      </v-chip>
    </v-card-title>

    <v-card-text class="pa-0">
      <v-stepper v-model="currentStep" alt-labels>
        <v-stepper-header>
          <v-stepper-item
            :complete="currentStep > 1"
            :value="1"
            title="–°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞"
            icon="mdi-robot"
          ></v-stepper-item>

          <v-divider></v-divider>

          <v-stepper-item
            :complete="currentStep > 2"
            :value="2"
            title="–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω"
            icon="mdi-key"
          ></v-stepper-item>

          <v-divider></v-divider>

          <v-stepper-item
            :complete="currentStep > 3"
            :value="3"
            title="Chat ID"
            icon="mdi-account"
          ></v-stepper-item>

          <v-divider></v-divider>

          <v-stepper-item
            :complete="currentStep > 4"
            :value="4"
            title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å"
            icon="mdi-cog"
          ></v-stepper-item>

          <v-divider></v-divider>

          <v-stepper-item
            :value="5"
            title="–ì–æ—Ç–æ–≤–æ"
            icon="mdi-check-bold"
          ></v-stepper-item>
        </v-stepper-header>

        <v-stepper-window>
          <!-- –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞ -->
          <v-stepper-window-item :value="1">
            <v-card flat>
              <v-card-text>
                <div class="text-h6 mb-4">–®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Telegram –±–æ—Ç–∞</div>

                <v-list lines="two">
                  <v-list-item>
                    <template #prepend>
                      <v-avatar color="blue">1</v-avatar>
                    </template>
                    <v-list-item-title>–û—Ç–∫—Ä–æ–π—Ç–µ Telegram</v-list-item-title>
                    <v-list-item-subtitle>–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏–ª–∏ –≤ –¥–µ—Å–∫—Ç–æ–ø –≤–µ—Ä—Å–∏–∏</v-list-item-subtitle>
                  </v-list-item>

                  <v-list-item>
                    <template #prepend>
                      <v-avatar color="blue">2</v-avatar>
                    </template>
                    <v-list-item-title>–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ @BotFather</v-list-item-title>
                    <v-list-item-subtitle>
                      –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–æ–≤
                      <v-btn
                        size="x-small"
                        variant="tonal"
                        class="ml-2"
                        @click="copyToClipboard('@BotFather')"
                      >
                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                      </v-btn>
                    </v-list-item-subtitle>
                  </v-list-item>

                  <v-list-item>
                    <template #prepend>
                      <v-avatar color="blue">3</v-avatar>
                    </template>
                    <v-list-item-title>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /newbot</v-list-item-title>
                    <v-list-item-subtitle>
                      –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å BotFather
                    </v-list-item-subtitle>
                  </v-list-item>

                  <v-list-item>
                    <template #prepend>
                      <v-avatar color="blue">4</v-avatar>
                    </template>
                    <v-list-item-title>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞</v-list-item-title>
                    <v-list-item-subtitle>
                      –ù–∞–ø—Ä–∏–º–µ—Ä: <code>Hydro Mesh Bot</code>
                    </v-list-item-subtitle>
                  </v-list-item>

                  <v-list-item>
                    <template #prepend>
                      <v-avatar color="blue">5</v-avatar>
                    </template>
                    <v-list-item-title>–í–≤–µ–¥–∏—Ç–µ username –±–æ—Ç–∞</v-list-item-title>
                    <v-list-item-subtitle>
                      –ù–∞–ø—Ä–∏–º–µ—Ä: <code>hydro_mesh_bot</code> (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ _bot)
                    </v-list-item-subtitle>
                  </v-list-item>
                </v-list>

                <v-alert type="success" variant="tonal" class="mt-4">
                  <v-icon icon="mdi-lightbulb-on" class="mr-2"></v-icon>
                  –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞!
                </v-alert>
              </v-card-text>

              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn color="primary" @click="currentStep = 2">
                  –î–∞–ª–µ–µ
                  <v-icon end>mdi-chevron-right</v-icon>
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-stepper-window-item>

          <!-- –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω -->
          <v-stepper-window-item :value="2">
            <v-card flat>
              <v-card-text>
                <div class="text-h6 mb-4">–®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞</div>

                <v-alert type="info" variant="tonal" class="mb-4">
                  BotFather –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–æ–∫–µ–Ω–æ–º
                </v-alert>

                <div class="mb-4">
                  <div class="text-subtitle-2 mb-2">–¢–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:</div>
                  <v-sheet color="grey-lighten-4" class="pa-3 rounded">
                    <code>123456789:ABCdefGHIjklMNOpqrsTUVwxyz</code>
                  </v-sheet>
                </div>

                <v-text-field
                  v-model="botToken"
                  label="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞"
                  placeholder="123456789:ABCdef..."
                  variant="outlined"
                  persistent-hint
                  hint="–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è BotFather"
                >
                  <template #append-inner>
                    <v-icon
                      v-if="botToken"
                      icon="mdi-check-circle"
                      color="success"
                    ></v-icon>
                  </template>
                </v-text-field>

                <v-alert type="warning" variant="tonal" class="mt-4">
                  <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç–æ–∫–µ–Ω –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–º –ª—é–¥—è–º!
                </v-alert>
              </v-card-text>

              <v-card-actions>
                <v-btn @click="currentStep = 1">
                  <v-icon start>mdi-chevron-left</v-icon>
                  –ù–∞–∑–∞–¥
                </v-btn>
                <v-spacer></v-spacer>
                <v-btn
                  color="primary"
                  :disabled="!botToken"
                  @click="currentStep = 3"
                >
                  –î–∞–ª–µ–µ
                  <v-icon end>mdi-chevron-right</v-icon>
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-stepper-window-item>

          <!-- –®–∞–≥ 3: –ü–æ–ª—É—á–∏—Ç—å Chat ID -->
          <v-stepper-window-item :value="3">
            <v-card flat>
              <v-card-text>
                <div class="text-h6 mb-4">–®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ Chat ID</div>

                <v-tabs v-model="chatIdMethod" color="primary" class="mb-4">
                  <v-tab value="simple">–ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±</v-tab>
                  <v-tab value="manual">–†—É—á–Ω–æ–π —Å–ø–æ—Å–æ–±</v-tab>
                </v-tabs>

                <v-window v-model="chatIdMethod">
                  <!-- –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± -->
                  <v-window-item value="simple">
                    <v-list>
                      <v-list-item>
                        <template #prepend>
                          <v-avatar color="green">1</v-avatar>
                        </template>
                        <v-list-item-title>–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ @userinfobot</v-list-item-title>
                        <v-list-item-subtitle>
                          <v-btn
                            size="small"
                            variant="tonal"
                            class="mt-1"
                            @click="copyToClipboard('@userinfobot')"
                          >
                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å @userinfobot
                          </v-btn>
                        </v-list-item-subtitle>
                      </v-list-item>

                      <v-list-item>
                        <template #prepend>
                          <v-avatar color="green">2</v-avatar>
                        </template>
                        <v-list-item-title>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É /start</v-list-item-title>
                      </v-list-item>

                      <v-list-item>
                        <template #prepend>
                          <v-avatar color="green">3</v-avatar>
                        </template>
                        <v-list-item-title>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à ID</v-list-item-title>
                        <v-list-item-subtitle>
                          –ë–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç: <code>Id: 987654321</code>
                        </v-list-item-subtitle>
                      </v-list-item>
                    </v-list>
                  </v-window-item>

                  <!-- –†—É—á–Ω–æ–π —Å–ø–æ—Å–æ–± -->
                  <v-window-item value="manual">
                    <v-list>
                      <v-list-item>
                        <template #prepend>
                          <v-avatar color="orange">1</v-avatar>
                        </template>
                        <v-list-item-title>–û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –≤–∞—à–µ–º—É –±–æ—Ç—É</v-list-item-title>
                      </v-list-item>

                      <v-list-item>
                        <template #prepend>
                          <v-avatar color="orange">2</v-avatar>
                        </template>
                        <v-list-item-title>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ:</v-list-item-title>
                        <v-list-item-subtitle class="mt-2">
                          <v-sheet color="grey-lighten-4" class="pa-2 rounded">
                            <code style="font-size: 0.8em; word-break: break-all;">
                              https://api.telegram.org/bot{{ botToken || 'YOUR_TOKEN' }}/getUpdates
                            </code>
                          </v-sheet>
                          <v-btn
                            v-if="botToken"
                            size="small"
                            variant="tonal"
                            class="mt-2"
                            @click="openGetUpdatesUrl"
                          >
                            –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                          </v-btn>
                        </v-list-item-subtitle>
                      </v-list-item>

                      <v-list-item>
                        <template #prepend>
                          <v-avatar color="orange">3</v-avatar>
                        </template>
                        <v-list-item-title>–ù–∞–π–¥–∏—Ç–µ –≤ JSON: "chat":{"id":...</v-list-item-title>
                      </v-list-item>
                    </v-list>
                  </v-window-item>
                </v-window>

                <v-text-field
                  v-model="chatId"
                  label="–í–≤–µ–¥–∏—Ç–µ Chat ID"
                  placeholder="987654321"
                  variant="outlined"
                  type="number"
                  class="mt-4"
                  persistent-hint
                  hint="–≠—Ç–æ –≤–∞—à ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram"
                >
                  <template #append-inner>
                    <v-icon
                      v-if="chatId"
                      icon="mdi-check-circle"
                      color="success"
                    ></v-icon>
                  </template>
                </v-text-field>
              </v-card-text>

              <v-card-actions>
                <v-btn @click="currentStep = 2">
                  <v-icon start>mdi-chevron-left</v-icon>
                  –ù–∞–∑–∞–¥
                </v-btn>
                <v-spacer></v-spacer>
                <v-btn
                  color="primary"
                  :disabled="!chatId"
                  @click="currentStep = 4"
                >
                  –î–∞–ª–µ–µ
                  <v-icon end>mdi-chevron-right</v-icon>
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-stepper-window-item>

          <!-- –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ -->
          <v-stepper-window-item :value="4">
            <v-card flat>
              <v-card-text>
                <div class="text-h6 mb-4">–®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã</div>

                <v-alert type="info" variant="tonal" class="mb-4">
                  –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª <code>.env</code> –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                </v-alert>

                <v-sheet color="grey-darken-4" class="pa-4 rounded">
                  <pre style="color: white; margin: 0;">TELEGRAM_ENABLED=true
TELEGRAM_BOT_TOKEN={{ botToken || 'YOUR_BOT_TOKEN' }}
TELEGRAM_CHAT_ID={{ chatId || 'YOUR_CHAT_ID' }}
TELEGRAM_NOTIFY_WARNINGS=true
TELEGRAM_NOTIFY_INFO=false</pre>
                </v-sheet>

                <v-btn
                  color="primary"
                  variant="tonal"
                  prepend-icon="mdi-content-copy"
                  class="mt-3"
                  @click="copyEnvSettings"
                >
                  –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </v-btn>

                <v-divider class="my-6"></v-divider>

                <div class="text-subtitle-2 mb-3">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</div>

                <v-switch
                  v-model="notifyCritical"
                  label="–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è"
                  color="error"
                  hide-details
                  class="mb-2"
                ></v-switch>

                <v-switch
                  v-model="notifyWarnings"
                  label="–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è"
                  color="warning"
                  hide-details
                  class="mb-2"
                ></v-switch>

                <v-switch
                  v-model="notifyInfo"
                  label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"
                  color="info"
                  hide-details
                  class="mb-4"
                ></v-switch>

                <v-alert type="warning" variant="tonal">
                  <strong>‚ö†Ô∏è –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è .env —Ñ–∞–π–ª–∞:</strong>
                  <ul class="mt-2">
                    <li>–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend: <code>docker-compose restart backend</code></li>
                    <li>–ò–ª–∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à: <code>php artisan config:clear</code></li>
                  </ul>
                </v-alert>
              </v-card-text>

              <v-card-actions>
                <v-btn @click="currentStep = 3">
                  <v-icon start>mdi-chevron-left</v-icon>
                  –ù–∞–∑–∞–¥
                </v-btn>
                <v-spacer></v-spacer>
                <v-btn color="primary" @click="currentStep = 5">
                  –î–∞–ª–µ–µ
                  <v-icon end>mdi-chevron-right</v-icon>
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-stepper-window-item>

          <!-- –®–∞–≥ 5: –ì–æ—Ç–æ–≤–æ -->
          <v-stepper-window-item :value="5">
            <v-card flat>
              <v-card-text>
                <div class="text-center py-8">
                  <v-icon icon="mdi-check-circle" color="success" size="80" class="mb-4"></v-icon>
                  
                  <div class="text-h5 mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ</div>

                  <v-alert type="success" variant="tonal" class="mb-4">
                    –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏:
                    <ul class="mt-2 text-left">
                      <li>üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö (pH/EC –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞)</li>
                      <li>üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è—Ö (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)</li>
                      <li>‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–µ –Ω–∞—Å–æ—Å–æ–≤ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)</li>
                      <li>‚ö†Ô∏è –ö–æ–≥–¥–∞ –Ω–æ–¥–∞ —É—Ö–æ–¥–∏—Ç –≤ offline</li>
                    </ul>
                  </v-alert>

                  <div class="text-subtitle-1 mb-4">–ß—Ç–æ –¥–∞–ª—å—à–µ?</div>

                  <v-list lines="two">
                    <v-list-item>
                      <template #prepend>
                        <v-icon icon="mdi-test-tube" color="primary"></v-icon>
                      </template>
                      <v-list-item-title>–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</v-list-item-title>
                      <v-list-item-subtitle>
                        <v-btn
                          size="small"
                          variant="outlined"
                          class="mt-2"
                          :loading="testing"
                          @click="sendTestMessage"
                        >
                          –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        </v-btn>
                      </v-list-item-subtitle>
                    </v-list-item>

                    <v-list-item>
                      <template #prepend>
                        <v-icon icon="mdi-book-open" color="primary"></v-icon>
                      </template>
                      <v-list-item-title>–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é</v-list-item-title>
                      <v-list-item-subtitle>
                        –§–∞–π–ª: <code>–ö–ê–ö_–ù–ê–°–¢–†–û–ò–¢–¨_TELEGRAM.md</code>
                      </v-list-item-subtitle>
                    </v-list-item>

                    <v-list-item>
                      <template #prepend>
                        <v-icon icon="mdi-restart" color="primary"></v-icon>
                      </template>
                      <v-list-item-title>–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã</v-list-item-title>
                      <v-list-item-subtitle>
                        –ß—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É
                      </v-list-item-subtitle>
                    </v-list-item>
                  </v-list>
                </div>
              </v-card-text>

              <v-card-actions>
                <v-btn @click="currentStep = 4">
                  <v-icon start>mdi-chevron-left</v-icon>
                  –ù–∞–∑–∞–¥
                </v-btn>
                <v-spacer></v-spacer>
                <v-btn color="success" variant="elevated" @click="closeDialog">
                  –ó–∞–≤–µ—Ä—à–∏—Ç—å
                  <v-icon end>mdi-check</v-icon>
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-stepper-window-item>
        </v-stepper-window>
      </v-stepper>
    </v-card-text>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <v-expansion-panels class="mt-4">
      <v-expansion-panel>
        <v-expansion-panel-title>
          <v-icon icon="mdi-help-circle" class="mr-2"></v-icon>
          –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        </v-expansion-panel-title>
        <v-expansion-panel-text>
          <v-list>
            <v-list-item>
              <v-list-item-title class="font-weight-bold">
                –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π?
              </v-list-item-title>
              <v-list-item-subtitle>
                –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã TELEGRAM_NOTIFY_* –≤ .env —Ñ–∞–π–ª–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend
              </v-list-item-subtitle>
            </v-list-item>

            <v-list-item>
              <v-list-item-title class="font-weight-bold">
                –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Ç–æ–≤?
              </v-list-item-title>
              <v-list-item-subtitle>
                –ü–æ–∫–∞ –Ω–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å TelegramService –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö chat_id
              </v-list-item-subtitle>
            </v-list-item>

            <v-list-item>
              <v-list-item-title class="font-weight-bold">
                –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç?
              </v-list-item-title>
              <v-list-item-subtitle>
                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: 1) –¢–æ–∫–µ–Ω –∏ Chat ID –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, 2) –û—Ç–ø—Ä–∞–≤–∏–ª–∏ /start –±–æ—Ç—É, 3) TELEGRAM_ENABLED=true, 4) –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏ backend
              </v-list-item-subtitle>
            </v-list-item>

            <v-list-item>
              <v-list-item-title class="font-weight-bold">
                –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?
              </v-list-item-title>
              <v-list-item-subtitle>
                –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ TELEGRAM_ENABLED=false –≤ .env –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend
              </v-list-item-subtitle>
            </v-list-item>
          </v-list>
        </v-expansion-panel-text>
      </v-expansion-panel>

      <v-expansion-panel>
        <v-expansion-panel-title>
          <v-icon icon="mdi-script-text" class="mr-2"></v-icon>
          –ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
        </v-expansion-panel-title>
        <v-expansion-panel-text>
          <v-sheet color="grey-lighten-4" class="pa-4 rounded">
            <div style="font-family: monospace; white-space: pre-line;">
üî¥ <strong>[CRITICAL]</strong> 19:30

<strong>–£–∑–µ–ª:</strong> ph_001
<strong>–°–æ–±—ã—Ç–∏–µ:</strong> pH critically low
<strong>–í—Ä–µ–º—è:</strong> 21.10.2025 19:30:15

<strong>–î–∞–Ω–Ω—ã–µ:</strong>
‚Ä¢ ph: 4.2
‚Ä¢ ph_target: 6.0
‚Ä¢ ph_min: 5.5
‚Ä¢ ph_max: 6.5
            </div>
          </v-sheet>
        </v-expansion-panel-text>
      </v-expansion-panel>
    </v-expansion-panels>
  </v-card>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useToast } from 'vue-toastification'
import axios from 'axios'

const toast = useToast()

const currentStep = ref(1)
const botToken = ref('')
const chatId = ref('')
const chatIdMethod = ref('simple')
const notifyWarnings = ref(true)
const notifyInfo = ref(false)
const notifyCritical = ref(true)
const enabled = ref(false)
const loading = ref(false)
const testing = ref(false)
const hasToken = ref(false)
const tokenMasked = ref('')
const availableChats = ref([])
const loadingChats = ref(false)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const isConfigured = computed(() => {
  return (hasToken.value || botToken.value) && chatId.value && enabled.value
})

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –ë–î
const loadSettings = async () => {
  loading.value = true
  try {
    const response = await axios.get('/api/settings/telegram')
    if (response.data.success) {
      const settings = response.data.telegram
      enabled.value = settings.enabled || false
      chatId.value = settings.chat_id || ''
      notifyCritical.value = settings.notify_critical !== false
      notifyWarnings.value = settings.notify_warnings !== false
      notifyInfo.value = settings.notify_info || false
      hasToken.value = settings.has_token || false
      tokenMasked.value = settings.bot_token_masked || ''
      
      // –ï—Å–ª–∏ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥
      if (isConfigured.value) {
        currentStep.value = 5
      }
    }
  } catch (error) {
    console.error('Failed to load Telegram settings:', error)
  } finally {
    loading.value = false
  }
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ë–î
const saveSettings = async () => {
  loading.value = true
  try {
    const data = {
      enabled: enabled.value,
      notify_critical: notifyCritical.value,
      notify_warnings: notifyWarnings.value,
      notify_info: notifyInfo.value,
    }

    // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω
    if (botToken.value) {
      data.bot_token = botToken.value
    }

    // –î–æ–±–∞–≤–∏—Ç—å chat_id —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω
    if (chatId.value) {
      data.chat_id = chatId.value
    }

    const response = await axios.post('/api/settings/telegram', data)
    
    if (response.data.success) {
      toast.success('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î!')
      await loadSettings()
      return true
    }
  } catch (error) {
    const errorMsg = error.response?.data?.error || error.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'
    toast.error(errorMsg)
    return false
  } finally {
    loading.value = false
  }
}

// –ü–æ–ª—É—á–∏—Ç—å Chat ID –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
const getChatIdAuto = async () => {
  // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–≤–µ–¥–µ–Ω –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–Ω–∞—á–∞–ª–∞
  if (botToken.value && !hasToken.value) {
    const saved = await saveSettings()
    if (!saved) return
  }

  if (!hasToken.value && !botToken.value) {
    toast.warning('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞')
    return
  }

  loadingChats.value = true
  try {
    const response = await axios.get('/api/settings/telegram/chat-id')
    if (response.data.success && response.data.chats.length > 0) {
      availableChats.value = response.data.chats
      toast.success(`–ù–∞–π–¥–µ–Ω–æ ${response.data.count} —á–∞—Ç(–æ–≤)`)
    } else {
      toast.warning(response.data.error || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É /start')
    }
  } catch (error) {
    toast.error(error.response?.data?.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è Chat ID')
  } finally {
    loadingChats.value = false
  }
}

// –í—ã–±—Ä–∞—Ç—å Chat ID –∏–∑ —Å–ø–∏—Å–∫–∞
const selectChatId = (chat) => {
  chatId.value = chat.chat_id.toString()
  toast.success(`Chat ID –≤—ã–±—Ä–∞–Ω: ${chat.title}`)
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
const sendTestMessage = async () => {
  // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  const saved = await saveSettings()
  if (!saved) return

  testing.value = true
  try {
    const response = await axios.post('/api/settings/telegram/test')
    
    if (response.data.success) {
      toast.success('üéâ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.')
    } else {
      toast.error(response.data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏')
    }
  } catch (error) {
    toast.error(error.response?.data?.error || '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞')
  } finally {
    testing.value = false
  }
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
const closeDialog = async () => {
  enabled.value = true
  const saved = await saveSettings()
  
  if (saved) {
    toast.success('‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!')
  }
}

// –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä
const copyToClipboard = (text) => {
  navigator.clipboard.writeText(text)
  toast.success(`–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ${text}`)
}

// –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ .env
const copyEnvSettings = () => {
  const envText = `TELEGRAM_ENABLED=${enabled.value}
TELEGRAM_BOT_TOKEN=${botToken.value || '[—Å–º. –≤ –ë–î]'}
TELEGRAM_CHAT_ID=${chatId.value}
TELEGRAM_NOTIFY_CRITICAL=${notifyCritical.value}
TELEGRAM_NOTIFY_WARNINGS=${notifyWarnings.value}
TELEGRAM_NOTIFY_INFO=${notifyInfo.value}`

  navigator.clipboard.writeText(envText)
  toast.success('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞')
}

// –û—Ç–∫—Ä—ã—Ç—å getUpdates URL
const openGetUpdatesUrl = () => {
  const url = `https://api.telegram.org/bot${botToken.value}/getUpdates`
  window.open(url, '_blank')
}

// –ü—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
onMounted(() => {
  loadSettings()
})
</script>

<style scoped>
.bg-telegram {
  background: linear-gradient(135deg, #0088cc 0%, #00a8e8 100%);
  color: white;
}

code {
  background: rgba(0, 0, 0, 0.05);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
}
</style>

