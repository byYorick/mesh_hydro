# ‚úÖ MAC –ê–î–†–ï–° –î–û–ë–ê–í–õ–ï–ù –í HEARTBEAT

**–î–∞—Ç–∞:** 19 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** MAC –∞–¥—Ä–µ—Å –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –¥–µ—Ç–∞–ª—è—Ö —É–∑–ª–∞

---

## üêõ –ü–†–û–ë–õ–ï–ú–ê

### –ü—Ä–∏—á–∏–Ω–∞:
1. –£–∑–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç Discovery **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
2. –£–∑–ª—ã –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ Heartbeat (–±–µ–∑ MAC)
3. MAC –ø—Ä–∏—Ö–æ–¥–∏–ª —Ç–æ–ª—å–∫–æ –≤ Discovery, –Ω–æ backend –µ–≥–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
```sql
SELECT node_id, mac_address FROM nodes;

node_id              | mac_address
---------------------|------------------
climate_001          | NULL          ‚ùå
ph_ec_3cfd01         | NULL          ‚ùå
root_98a316f5fde8    | 98:A3:16:F5:FD:E8  ‚úÖ
```

**Frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç:** "–ù–µ —É–∫–∞–∑–∞–Ω"

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –î–æ–±–∞–≤–ª–µ–Ω MAC –∞–¥—Ä–µ—Å –≤ Heartbeat (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)!

–¢–µ–ø–µ—Ä—å —É–∑–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç MAC –Ω–µ —Ç–æ–ª—å–∫–æ –≤ Discovery, –Ω–æ –∏ **–≤ –∫–∞–∂–¥–æ–º Heartbeat**.

---

## üîß –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 1. Climate —É–∑–µ–ª - climate_controller.c (—Å—Ç—Ä–æ–∫–∏ 301-328):

**–ë–´–õ–û:**
```c
static void send_heartbeat(void) {
    // ...
    snprintf(heartbeat_msg, sizeof(heartbeat_msg),
            "{\"type\":\"heartbeat\","
            "\"node_id\":\"%s\","
            "\"uptime\":%lu,"
            "\"heap_free\":%lu,"
            "\"rssi_to_parent\":%d}",
            // –ë–ï–ó MAC! ‚ùå
            s_config->base.node_id,
            (unsigned long)uptime,
            (unsigned long)heap_free,
            rssi);
}
```

**–°–¢–ê–õ–û:**
```c
static void send_heartbeat(void) {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ MAC –∞–¥—Ä–µ—Å–∞
    uint8_t mac[6];
    mesh_manager_get_mac(mac);
    
    // ...
    snprintf(heartbeat_msg, sizeof(heartbeat_msg),
            "{\"type\":\"heartbeat\","
            "\"node_id\":\"%s\","
            "\"mac_address\":\"%02X:%02X:%02X:%02X:%02X:%02X\","  ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
            "\"uptime\":%lu,"
            "\"heap_free\":%lu,"
            "\"rssi_to_parent\":%d}",
            s_config->base.node_id,
            mac[0], mac[1], mac[2], mac[3], mac[4], mac[5],  ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
            (unsigned long)uptime,
            (unsigned long)heap_free,
            rssi);
}
```

---

### 2. pH/EC —É–∑–µ–ª - ph_ec_manager.c (—Å—Ç—Ä–æ–∫–∏ 429-454):

**–¢–∞–∫–æ–µ –∂–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ!**

MAC –∞–¥—Ä–µ—Å —Ç–µ–ø–µ—Ä—å –≤ –∫–∞–∂–¥–æ–º heartbeat.

---

### 3. Backend - MqttService.php (—Å—Ç—Ä–æ–∫–∏ 358-374):

**–ë–´–õ–û:**
```php
} else {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É–∑–ª–∞
    $metadata = $node->metadata ?? [];
    
    // heap_free, rssi, uptime
    // ...
    
    $node->update([
        'online' => true,
        'last_seen_at' => now(),
        'metadata' => $metadata,
    ]);
    // –ë–ï–ó mac_address! ‚ùå
}
```

**–°–¢–ê–õ–û:**
```php
} else {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É–∑–ª–∞
    $metadata = $node->metadata ?? [];
    
    // heap_free, rssi, uptime, MAC
    // ...
    
    // –û–±–Ω–æ–≤–ª—è–µ–º MAC –∞–¥—Ä–µ—Å (–µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –≤ heartbeat)
    if (isset($data['mac_address']) || isset($data['mac'])) {
        $metadata['mac_address'] = $data['mac_address'] ?? $data['mac'];
    }
    
    $updateData = [
        'online' => true,
        'last_seen_at' => now(),
        'metadata' => $metadata,
    ];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ –ø–æ–ª–µ mac_address –≤ —Ç–∞–±–ª–∏—Ü–µ nodes (–µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ)
    if (isset($data['mac_address']) || isset($data['mac'])) {
        $updateData['mac_address'] = $data['mac_address'] ?? $data['mac'];  ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
    }
    
    $node->update($updateData);
}
```

---

## üìä –ù–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê HEARTBEAT

### –¢–µ–ø–µ—Ä—å Heartbeat —Å–æ–¥–µ—Ä–∂–∏—Ç:

```json
{
  "type": "heartbeat",
  "node_id": "climate_001",
  "mac_address": "00:4B:12:37:D5:A4",  ‚Üê –ù–û–í–û–ï!
  "uptime": 120,
  "heap_free": 143004,
  "rssi_to_parent": -45
}
```

**–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥!**

---

## üöÄ –î–ï–ô–°–¢–í–ò–Ø

### –ß—Ç–æ –∑–∞–ø—É—â–µ–Ω–æ:

1. ‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (—É–∂–µ –≥–æ—Ç–æ–≤!)
2. ‚è≥ Climate —É–∑–µ–ª –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –∏ –ø—Ä–æ—à–∏–≤–∞–µ—Ç—Å—è (COM10)
3. ‚è≥ pH/EC —É–∑–µ–ª –Ω—É–∂–Ω–æ –ø—Ä–æ—à–∏—Ç—å (COM9)

---

## üß™ –ü–†–û–í–ï–†–ö–ê –ß–ï–†–ï–ó 3-5 –ú–ò–ù–£–¢

### 1. –ü–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏ climate —É–∑–ª–∞:

–ü–æ–¥–æ–∂–¥–∏ 10 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—å –ë–î:

```bash
docker exec hydro_backend php artisan tinker --execute="echo App\Models\Node::where('node_id', 'climate_001')->first()->mac_address;"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
00:4B:12:37:D5:A4  ‚Üê MAC –ø–æ—è–≤–∏—Ç—Å—è!
```

---

### 2. –û—Ç–∫—Ä–æ–π Dashboard ‚Üí –î–µ—Ç–∞–ª–∏ —É–∑–ª–∞:

```
http://localhost:3000
```

–ü–µ—Ä–µ–π–¥–∏ –≤ –¥–µ—Ç–∞–ª–∏ `climate_001` ‚Üí –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–∑–ª–∞

**–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:**
```
üîå MAC –∞–¥—Ä–µ—Å
   00:4B:12:37:D5:A4
```

---

## ‚è±Ô∏è –ß–ê–°–¢–û–¢–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø

### ESP32 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç MAC:
- **–í Discovery:** 1 —Ä–∞–∑ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- **–í Heartbeat:** –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ ‚Üê –ù–û–í–û–ï!

### Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç MAC:
- **–ü—Ä–∏ –∫–∞–∂–¥–æ–º Heartbeat —Å MAC** ‚úÖ

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
**MAC –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 5-10 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏!**

---

## üìã –°–¢–ê–¢–£–° –ü–†–û–®–ò–í–û–ö

### ‚úÖ Backend:
- –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- –ì–æ—Ç–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å MAC –∏–∑ heartbeat

### ‚è≥ Climate (COM10):
- –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
- –ë—É–¥–µ—Ç –ø—Ä–æ—à–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏ MAC –ø–æ—è–≤–∏—Ç—Å—è –≤ –ë–î —á–µ—Ä–µ–∑ 5-10 —Å–µ–∫—É–Ω–¥

### ‚è≥ pH/EC (COM9):
- –ù—É–∂–Ω–æ –ø—Ä–æ—à–∏—Ç—å –ø–æ—Å–ª–µ climate
- –ö–æ–¥ —É–∂–µ –∏–∑–º–µ–Ω—ë–Ω (MAC –≤ heartbeat –¥–æ–±–∞–≤–ª–µ–Ω)

---

**–ü–û–î–û–ñ–î–ò 3-5 –ú–ò–ù–£–¢ –ü–û–ö–ê –ö–û–ú–ü–ò–õ–Ø–¶–ò–Ø –ó–ê–í–ï–†–®–ò–¢–°–Ø!** ‚è≥üîå

**–ü–û–°–õ–ï –ü–†–û–®–ò–í–ö–ò MAC –ê–î–†–ï–°–ê –ü–û–Ø–í–Ø–¢–°–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò!** ‚úÖ

