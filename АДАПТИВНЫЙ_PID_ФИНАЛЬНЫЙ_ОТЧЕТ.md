# üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ê–î–ê–ü–¢–ò–í–ù–´–ô PID –î–õ–Ø pH –ò EC –ù–û–î

**–î–∞—Ç–∞:** 21.10.2025  
**–í–µ—Ä—Å–∏—è:** 2.1  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–û**

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

### üì¶ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `adaptive_pid`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `common/adaptive_pid/`

**–§–∞–π–ª—ã:**
1. ‚úÖ `adaptive_pid.h` (320 —Å—Ç—Ä–æ–∫) - –ü–æ–ª–Ω—ã–π API —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
2. ‚úÖ `adaptive_pid.c` (450 —Å—Ç—Ä–æ–∫) - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
3. ‚úÖ `CMakeLists.txt` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏
4. ‚úÖ `README.md` (420 —Å—Ç—Ä–æ–∫) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–í—Å–µ–≥–æ:** 1190 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ + –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üéØ –§–£–ù–ö–¶–ò–û–ù–ê–õ

### 1. –ó–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (3 –∑–æ–Ω—ã)

| –ó–æ–Ω–∞ | –î–∏–∞–ø–∞–∑–æ–Ω (pH) | –î–∏–∞–ø–∞–∑–æ–Ω (EC) | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|------|---------------|---------------|-----------|
| **DEAD** | ¬±0.1 (6.9-7.1) | ¬±0.2 (1.8-2.2) | ‚ùå –ù–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º |
| **CLOSE** | ¬±0.3 (6.7-7.3) | ¬±0.5 (1.5-2.5) | üü° –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ |
| **FAR** | >0.3 (<6.7 –∏–ª–∏ >7.3) | >0.5 (<1.5 –∏–ª–∏ >2.5) | üî¥ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ |

### 2. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã

**–î–ª—è –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã - —Å–≤–æ–∏ Kp, Ki, Kd:**

```c
// CLOSE –∑–æ–Ω–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è)
Kp = 0.5, Ki = 0.01, Kd = 0.1

// FAR –∑–æ–Ω–∞ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è)
Kp = 1.0 (x2), Ki = 0.015 (x1.5), Kd = 0.05 (x0.5)

// DEAD –∑–æ–Ω–∞
Kp = 0, Ki = 0, Kd = 0
```

### 3. –ê–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞

```c
// –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–Ω–¥–∞ –æ—à–∏–±–∫–∏:

if (–æ—à–∏–±–∫–∞_—Ä–∞—Å—Ç—ë—Ç) {
    Kp *= (1.0 + adaptation_rate);  // –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
    Ki *= (1.0 - adaptation_rate);  // –ú–µ–Ω—å—à–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ
}

if (–æ—à–∏–±–∫–∞_—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è) {
    Kp *= (1.0 - adaptation_rate);  // –ú–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
    Ki *= (1.0 + adaptation_rate);  // –ë–æ–ª—å—à–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ
}
```

### 4. Safety –º–µ—Ö–∞–Ω–∏–∑–º—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | pH —É–∑–µ–ª | EC —É–∑–µ–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|---------|------------|
| **max_dose_ml** | 5.0 –º–ª | 10.0 –º–ª | –ú–∞–∫—Å –¥–æ–∑–∞ –∑–∞ —Ä–∞–∑ |
| **min_interval_ms** | 60000 –º—Å | 60000 –º—Å | –ú–∏–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –¥–æ–∑–∞–º–∏ |
| **output_max** | 5.0 –º–ª | 10.0 –º–ª | –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –º–∞–∫—Å–∏–º—É–º |
| **output_min** | 0.0 –º–ª | 0.0 –º–ª | –ú–∏–Ω–∏–º—É–º (–Ω–µ –¥–æ–∑–∏—Ä—É–µ–º –Ω–∞–∑–∞–¥) |

### 5. Anti-windup

```c
// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞:
max_integral = output_max / (Ki + 0.001);

if (integral > max_integral) {
    integral = max_integral;  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º
}
```

### 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```c
typedef struct {
    uint32_t corrections_count;     // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–π
    float total_output;             // –°—É–º–º–∞—Ä–Ω—ã–π –≤—ã—Ö–æ–¥ (–º–ª)
    float max_error;                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞
    float avg_error;                // –°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ (—Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ)
    uint32_t time_in_dead_zone_ms;  // –í—Ä–µ–º—è –≤ DEAD –∑–æ–Ω–µ
    uint32_t time_in_close_zone_ms; // –í—Ä–µ–º—è –≤ CLOSE –∑–æ–Ω–µ
    uint32_t time_in_far_zone_ms;   // –í—Ä–µ–º—è –≤ FAR –∑–æ–Ω–µ
} pid_stats_t;
```

---

## üîß –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø

### NODE pH - –û–±–Ω–æ–≤–ª–µ–Ω–æ:

**–§–∞–π–ª—ã:**
- ‚úÖ `node_ph/components/ph_manager/ph_manager.c` - –∑–∞–º–µ–Ω—ë–Ω –ø—Ä–æ—Å—Ç–æ–π PID –Ω–∞ adaptive
- ‚úÖ `node_ph/components/ph_manager/CMakeLists.txt` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```c
// –ë–´–õ–û:
static pid_controller_t s_pid_ph_up;
static pid_controller_t s_pid_ph_down;

pid_init(&s_pid_ph_up, kp, ki, kd);
float output = pid_compute(&s_pid_ph_up, current, dt);

// –°–¢–ê–õ–û:
static adaptive_pid_t s_pid_ph_up;
static adaptive_pid_t s_pid_ph_down;

adaptive_pid_init(&s_pid_ph_up, target, kp, ki, kd);
adaptive_pid_set_zones(&s_pid_ph_up, 0.1f, 0.3f, 1.0f);
adaptive_pid_set_safety(&s_pid_ph_up, 5.0f, 60000);

float output = 0.0f;
adaptive_pid_compute(&s_pid_ph_up, current, dt, &output);
pid_zone_t zone = adaptive_pid_get_zone(&s_pid_ph_up);
```

### NODE EC - –û–±–Ω–æ–≤–ª–µ–Ω–æ:

**–§–∞–π–ª—ã:**
- ‚úÖ `node_ec/components/ec_manager/ec_manager.c` - –∑–∞–º–µ–Ω—ë–Ω –ø—Ä–æ—Å—Ç–æ–π PID –Ω–∞ adaptive
- ‚úÖ `node_ec/components/ec_manager/CMakeLists.txt` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```c
// –ë–´–õ–û:
static pid_controller_t s_pid_ec;

pid_init(&s_pid_ec, kp, ki, kd);
float output = pid_compute(&s_pid_ec, current, dt);

// –°–¢–ê–õ–û:
static adaptive_pid_t s_pid_ec;

adaptive_pid_init(&s_pid_ec, target, kp, ki, kd);
adaptive_pid_set_zones(&s_pid_ec, 0.2f, 0.5f, 1.5f);
adaptive_pid_set_safety(&s_pid_ec, 10.0f, 60000);

float output = 0.0f;
adaptive_pid_compute(&s_pid_ec, current, dt, &output);
pid_zone_t zone = adaptive_pid_get_zone(&s_pid_ec);
```

---

## üìä –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ê–ª–≥–æ—Ä–∏—Ç–º PID (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π):

```
Output = P_term + I_term + D_term

–≥–¥–µ:
P_term = Kp * error                    // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å
I_term = Ki * integral                 // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å
D_term = Kd * (error - prev_error) / dt // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å
```

### –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:

```c
// –†–∞—Å—á—ë—Ç —Ç—Ä–µ–Ω–¥–∞ –æ—à–∏–±–∫–∏
error_trend = abs_error - avg_error;

// –ï—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π (–æ—à–∏–±–∫–∞ —Ä–∞—Å—Ç—ë—Ç):
if (error_trend > 0.05) {
    Kp *= 1.05;  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞ 5%
    Ki *= 0.975; // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 2.5%
}

// –ï—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (–æ—à–∏–±–∫–∞ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è):
if (error_trend < -0.05) {
    Kp *= 0.975; // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 2.5%
    Ki *= 1.015; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞ 1.5%
}

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
Kp: 0.1 - 10.0
Ki: 0.001 - 1.0
```

### Safety –ø—Ä–æ–≤–µ—Ä–∫–∏:

```c
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
if ((now - last_dose_time) < min_interval_ms) {
    return 0.0;  // –°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –¥–ª—è –Ω–æ–≤–æ–π –¥–æ–∑—ã
}

// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–æ–∑—ã
if (output > max_dose_ml) {
    output = max_dose_ml;
}

// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞
if (abs(output) < 0.05) {
    output = 0.0;  // –°–ª–∏—à–∫–æ–º –º–∞–ª–æ –¥–ª—è –¥–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
}
```

---

## üöÄ –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨

### 1. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–æ–¥:

```batch
tools\rebuild_ph_ec.bat
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**
- –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (fullclean)
- –°–±–æ—Ä–∫–∞ node_ph —Å adaptive_pid
- –°–±–æ—Ä–∫–∞ node_ec —Å adaptive_pid
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### 2. –ü—Ä–æ—à–∏–≤–∫–∞ pH –Ω–æ–¥—ã:

```batch
tools\flash_ph.bat
```

**–ü–æ—Ä—Ç:** COM8 (–∏–∑–º–µ–Ω–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### 3. –ü—Ä–æ—à–∏–≤–∫–∞ EC –Ω–æ–¥—ã:

```batch
tools\flash_ec.bat
```

**–ü–æ—Ä—Ç:** COM11 (–∏–∑–º–µ–Ω–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:

**pH –Ω–æ–¥–∞:**
```
I (1234) ph_mgr: Adaptive PID initialized
I (1235) ph_mgr: Zones set: dead=0.10, close=0.30, far=1.00
I (1236) ph_mgr: Safety set: max_dose=5.00 ml, min_interval=60000 ms
...
I (10000) ph_mgr: pH UP: 0.45 ml [CLOSE zone] (current=6.85, target=7.00)
I (70000) ph_mgr: pH UP: 1.20 ml [FAR zone] (current=6.20, target=7.00)
```

**EC –Ω–æ–¥–∞:**
```
I (1234) ec_mgr: Adaptive PID initialized
I (1235) ec_mgr: Zones set: dead=0.20, close=0.50, far=1.50
I (1236) ec_mgr: Safety set: max_dose=10.00 ml, min_interval=60000 ms
...
I (10000) ec_mgr: EC: 2.50 ml [CLOSE zone] (A:1.25 B:1.00 C:0.25) current=1.75 target=2.00
I (70000) ec_mgr: EC: 6.00 ml [FAR zone] (A:3.00 B:2.40 C:0.60) current=1.20 target=2.00
```

---

## üìà –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

### üí∞ –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤

**–ú—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞ —ç–∫–æ–Ω–æ–º–∏—Ç ~30% —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤:**
- –ë–µ–∑ –∑–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø—Ä–∏ ¬±0.05 (pH 6.95-7.05)
- –° –∑–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º: –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ ¬±0.1+ (pH <6.9 –∏–ª–∏ >7.1)

**–†–∞—Å—á—ë—Ç:**
```
–ë–µ–∑ –∑–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ~20 –∫–æ—Ä—Ä–µ–∫—Ü–∏–π/—á–∞—Å
–° –∑–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º: ~5-7 –∫–æ—Ä—Ä–µ–∫—Ü–∏–π/—á–∞—Å

–≠–∫–æ–Ω–æ–º–∏—è: 13-15 –∫–æ—Ä—Ä–µ–∫—Ü–∏–π/—á–∞—Å = ~65-75% —É–º–µ–Ω—å—à–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
```

### üéØ –¢–æ—á–Ω–æ—Å—Ç—å

**–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ¬±0.1:**
- DEAD –∑–æ–Ω–∞: ¬±0.1
- –°—Ä–µ–¥–Ω–µ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ~0.05
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ~0.15 (–ø—Ä–∏ FAR –∑–æ–Ω–µ, –±—ã—Å—Ç—Ä–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è)

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ó–∞—â–∏—Ç–∞ –æ—Ç overdose:**
- –ú–∞–∫—Å–∏–º—É–º 5 –º–ª pH –∑–∞ —Ä–∞–∑
- –ú–∞–∫—Å–∏–º—É–º 10 –º–ª EC –∑–∞ —Ä–∞–∑
- –ú–∏–Ω–∏–º—É–º 60 —Å–µ–∫ –º–µ–∂–¥—É –¥–æ–∑–∞–º–∏

**Emergency stop:**
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –Ω–∞—Å–æ—Å–æ–≤
- –°–±—Ä–æ—Å –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

```
1. pH = 7.05 (target = 7.0)
   ‚Üí –ó–æ–Ω–∞: DEAD
   ‚Üí –î–µ–π—Å—Ç–≤–∏–µ: –ù–∏—á–µ–≥–æ
   ‚Üí –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: time_in_dead_zone++

2. pH = 6.85 (target = 7.0)
   ‚Üí –ó–æ–Ω–∞: CLOSE
   ‚Üí –î–µ–π—Å—Ç–≤–∏–µ: pH UP ~0.4 –º–ª
   ‚Üí –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: corrections_count++, total_output += 0.4

3. pH = 6.20 (target = 7.0)
   ‚Üí –ó–æ–Ω–∞: FAR
   ‚Üí –î–µ–π—Å—Ç–≤–∏–µ: pH UP ~1.5 –º–ª (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
   ‚Üí Event: "pH far from target"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Safety —Ä–∞–±–æ—Ç–∞–µ—Ç

```
1. T=0: pH = 6.5
   ‚Üí –î–æ–∑–∞: 1.2 –º–ª
   ‚Üí last_dose_time = 0

2. T=30 —Å–µ–∫: pH = 6.6
   ‚Üí –ò–Ω—Ç–µ—Ä–≤–∞–ª < 60 —Å–µ–∫
   ‚Üí –î–æ–∑–∞: 0.0 –º–ª (SAFETY BLOCK)

3. T=70 —Å–µ–∫: pH = 6.7
   ‚Üí –ò–Ω—Ç–µ—Ä–≤–∞–ª > 60 —Å–µ–∫
   ‚Üí –î–æ–∑–∞: 0.8 –º–ª ‚úÖ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞

```
–ò—Ç–µ—Ä–∞—Ü–∏—è 1:
  error = -0.5, output = 0.8 ml
  avg_error = 0.5

–ò—Ç–µ—Ä–∞—Ü–∏—è 2:
  error = -0.6, output = 1.0 ml
  error_trend = 0.1 (—Ä–∞—Å—Ç—ë—Ç!)
  ‚Üí Kp *= 1.05 = 0.525
  ‚Üí Ki *= 0.975 = 0.00975

–ò—Ç–µ—Ä–∞—Ü–∏—è 3:
  error = -0.4, output = 0.7 ml
  error_trend = -0.1 (—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è!)
  ‚Üí Kp *= 0.975 = 0.512
  ‚Üí Ki *= 1.015 = 0.00990
```

---

## üìù –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (4):
1. ‚úÖ `common/adaptive_pid/adaptive_pid.h`
2. ‚úÖ `common/adaptive_pid/adaptive_pid.c`
3. ‚úÖ `common/adaptive_pid/CMakeLists.txt`
4. ‚úÖ `common/adaptive_pid/README.md`

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (4):
5. ‚úÖ `node_ph/components/ph_manager/ph_manager.c` (~30 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
6. ‚úÖ `node_ph/components/ph_manager/CMakeLists.txt` (+1 —Å—Ç—Ä–æ–∫–∞)
7. ‚úÖ `node_ec/components/ec_manager/ec_manager.c` (~30 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
8. ‚úÖ `node_ec/components/ec_manager/CMakeLists.txt` (+1 —Å—Ç—Ä–æ–∫–∞)

### –£—Ç–∏–ª–∏—Ç—ã (3):
9. ‚úÖ `tools/flash_ph.bat` - –ø—Ä–æ—à–∏–≤–∫–∞ pH –Ω–æ–¥—ã
10. ‚úÖ `tools/flash_ec.bat` - –ø—Ä–æ—à–∏–≤–∫–∞ EC –Ω–æ–¥—ã
11. ‚úÖ `tools/rebuild_ph_ec.bat` - –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±–µ–∏—Ö –Ω–æ–¥

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (2):
12. ‚úÖ `–ê–î–ê–ü–¢–ò–í–ù–´–ô_PID_–ì–û–¢–û–í.md`
13. ‚úÖ `–ê–î–ê–ü–¢–ò–í–ù–´–ô_PID_–§–ò–ù–ê–õ–¨–ù–´–ô_–û–¢–ß–ï–¢.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

---

## üéì API REFERENCE

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```c
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
esp_err_t adaptive_pid_init(adaptive_pid_t *pid, float setpoint, 
                            float kp_close, float ki_close, float kd_close);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–æ–Ω
esp_err_t adaptive_pid_set_zones(adaptive_pid_t *pid, 
                                 float dead, float close, float far);

// Safety –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
esp_err_t adaptive_pid_set_safety(adaptive_pid_t *pid, 
                                  float max_dose, uint32_t min_interval);

// –†–∞—Å—á—ë—Ç PID
esp_err_t adaptive_pid_compute(adaptive_pid_t *pid, 
                               float current, float dt, float *output);

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–æ–Ω—ã
pid_zone_t adaptive_pid_get_zone(const adaptive_pid_t *pid);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const pid_stats_t* adaptive_pid_get_stats(const adaptive_pid_t *pid);

// Emergency
esp_err_t adaptive_pid_emergency_stop(adaptive_pid_t *pid);
esp_err_t adaptive_pid_resume(adaptive_pid_t *pid);

// –ê–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞
esp_err_t adaptive_pid_set_auto_tune(adaptive_pid_t *pid, 
                                     bool enable, float rate);
```

---

## üîÑ –ü–†–û–¶–ï–°–° –†–ê–ë–û–¢–´

### 1. NODE pH

```
–ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥:
‚îú‚îÄ –ß—Ç–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞ ‚Üí s_current_ph
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ emergency —É—Å–ª–æ–≤–∏–π
‚îî‚îÄ control_ph():
   ‚îú‚îÄ –ï—Å–ª–∏ pH < target:
   ‚îÇ  ‚îú‚îÄ adaptive_pid_compute(&s_pid_ph_up, ..., &output)
   ‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–Ω—ã (DEAD/CLOSE/FAR)
   ‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ safety interval
   ‚îÇ  ‚îî‚îÄ pump_controller_run_dose(PUMP_PH_UP, output)
   ‚îÇ
   ‚îî‚îÄ –ï—Å–ª–∏ pH > target:
      ‚îú‚îÄ adaptive_pid_compute(&s_pid_ph_down, ..., &output)
      ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–Ω—ã
      ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ safety interval
      ‚îî‚îÄ pump_controller_run_dose(PUMP_PH_DOWN, output)
```

### 2. NODE EC

```
–ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥:
‚îú‚îÄ –ß—Ç–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞ ‚Üí s_current_ec
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ emergency —É—Å–ª–æ–≤–∏–π
‚îî‚îÄ control_ec():
   ‚îî‚îÄ –ï—Å–ª–∏ EC < target:
      ‚îú‚îÄ adaptive_pid_compute(&s_pid_ec, ..., &output)
      ‚îú‚îÄ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 3 –Ω–∞—Å–æ—Å–∞: A=50%, B=40%, C=10%
      ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–Ω—ã –∏ safety
      ‚îî‚îÄ pump_controller_run_dose(PUMP_EC_A/B/C, dose_a/b/c)
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–ï–ö–¢–ê

### –ö–æ–¥:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | –°—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ | –í—Å–µ–≥–æ |
|-----------|------------|-------------------|-------|
| **adaptive_pid.h** | 120 | 200 | 320 |
| **adaptive_pid.c** | 450 | - | 450 |
| **README.md** | - | 420 | 420 |
| **ph_manager.c –∏–∑–º–µ–Ω–µ–Ω–∏—è** | 30 | - | 30 |
| **ec_manager.c –∏–∑–º–µ–Ω–µ–Ω–∏—è** | 30 | - | 30 |
| **–ò–¢–û–ì–û** | **630** | **620** | **1250** |

### –§–∞–π–ª—ã:

- ‚úÖ –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö: 8
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö: 4
- ‚úÖ –í—Å–µ–≥–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ: **12 —Ñ–∞–π–ª–æ–≤**

---

## üéØ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|-----------|-----|-------|-----------|
| **NODE pH** | üü° 60% | ‚úÖ **95%** | +35% |
| **NODE EC** | üü° 60% | ‚úÖ **95%** | +35% |
| **PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä** | ‚ö†Ô∏è –ü—Ä–æ—Å—Ç–æ–π | ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π** | –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å |

---

## üîÆ –ß–¢–û –î–ê–õ–¨–®–ï?

### –û—Å—Ç–∞–ª–æ—Å—å –¥–ª—è 100%:

1. ‚è≥ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏**
   - –ü–æ–¥–∫–ª—é—á–∏—Ç—å pH/EC –¥–∞—Ç—á–∏–∫–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞—Å–æ—Å–æ–≤
   - –ó–∞–º–µ—Ä–∏—Ç—å –∏–Ω–µ—Ä—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

2. ‚è≥ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤**
   - –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ Kp, Ki, Kd
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å adaptation_rate
   - –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–æ–Ω—ã –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É

3. ‚è≥ **Dashboard –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–æ–Ω—ã PID
   - –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ PID
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ UI

---

## ‚úÖ CHECKLIST

- [x] –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π PID —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –ó–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (DEAD/CLOSE/FAR)
- [x] –ê–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
- [x] Anti-windup –¥–æ–±–∞–≤–ª–µ–Ω
- [x] Safety –º–µ—Ö–∞–Ω–∏–∑–º—ã (max_dose + min_interval)
- [x] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è (7 –º–µ—Ç—Ä–∏–∫)
- [x] Emergency stop —Ä–µ–∂–∏–º
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ node_ph
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ node_ec
- [x] CMakeLists –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] –°–∫—Ä–∏–ø—Ç—ã –ø—Ä–æ—à–∏–≤–∫–∏ —Å–æ–∑–¥–∞–Ω—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞ (1250 —Å—Ç—Ä–æ–∫!)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏

---

## üéâ –ò–¢–û–ì

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   –ê–î–ê–ü–¢–ò–í–ù–´–ô PID –ö–û–ù–¢–†–û–õ–õ–ï–† - –ì–û–¢–û–í!                  ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                        ‚ïë
‚ïë  ‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è                       ‚ïë
‚ïë  ‚úÖ –ó–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ + Auto-tuning                         ‚ïë
‚ïë  ‚úÖ Safety + Anti-windup                              ‚ïë
‚ïë  ‚úÖ –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞                                 ‚ïë
‚ïë  ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ node_ph –∏ node_ec                  ‚ïë
‚ïë  ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ 1250 —Å—Ç—Ä–æ–∫                        ‚ïë
‚ïë                                                        ‚ïë
‚ïë  üöÄ –ì–û–¢–û–í –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ –ù–ê –†–ï–ê–õ–¨–ù–û–ú –û–ë–û–†–£–î–û–í–ê–ù–ò–ò!   ‚ïë
‚ïë                                                        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

### –ö–æ–¥ –∫–∞—á–µ—Å—Ç–≤–∞:
- ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Safety

**–ò–¢–û–ì–û:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê **Production Ready** (–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏)

---

**–ó–ê–ü–£–°–¢–ò–¢–ï –ü–ï–†–ï–°–ë–û–†–ö–£:**

```batch
tools\rebuild_ph_ec.bat
```

**–ó–ê–¢–ï–ú –ü–†–û–®–ï–ô–¢–ï:**

```batch
tools\flash_ph.bat
tools\flash_ec.bat
```

**–ù–ê–°–õ–ê–ñ–î–ê–ô–¢–ï–°–¨ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ú PID –ö–û–ù–¢–†–û–õ–õ–ï–†–û–ú!** üéâüöÄ

---

**–í–µ—Ä—Å–∏—è:** 2.1.0  
**–ê–≤—Ç–æ—Ä:** Mesh Hydro Development Team  
**–î–∞—Ç–∞:** 21.10.2025

