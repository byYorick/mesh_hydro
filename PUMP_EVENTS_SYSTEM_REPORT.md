# üö∞ –û—Ç—á–µ—Ç: –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ PID

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–æ–≤ pH/EC —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤. –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏, –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –∏ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö –Ω–∞—Å–æ—Å–æ–≤.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

1. **`pump_events`** - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π
2. **`pump_controller`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º –Ω–∞—Å–æ—Å–æ–≤
3. **`ph_ec_manager`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PID —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**

```c
typedef struct {
    pump_event_type_t type;         // –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
    pump_id_t pump_id;              // ID –Ω–∞—Å–æ—Å–∞
    uint32_t timestamp;             // –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
    uint32_t duration_ms;           // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
    float dose_ml;                  // –î–æ–∑–∞ –≤ –º–ª
    float ml_per_second;            // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    pump_event_pid_data_t pid_data; // –î–∞–Ω–Ω—ã–µ PID
    float current_ph;               // –¢–µ–∫—É—â–∏–π pH
    float current_ec;               // –¢–µ–∫—É—â–∏–π EC
    float ph_target;                // –¶–µ–ª–µ–≤–æ–π pH
    float ec_target;                // –¶–µ–ª–µ–≤–æ–π EC
    bool emergency_mode;            // –†–µ–∂–∏–º –∞–≤–∞—Ä–∏–∏
    bool autonomous_mode;           // –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º
    int8_t rssi;                    // RSSI –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É —É–∑–ª—É
} pump_event_t;
```

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### **1. –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:**
- `PUMP_EVENT_START` - –ù–∞—Å–æ—Å –≤–∫–ª—é—á–µ–Ω
- `PUMP_EVENT_STOP` - –ù–∞—Å–æ—Å –≤—ã–∫–ª—é—á–µ–Ω
- `PUMP_EVENT_EMERGENCY_STOP` - –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
- `PUMP_EVENT_TIMEOUT` - –¢–∞–π–º–∞—É—Ç —Ä–∞–±–æ—Ç—ã
- `PUMP_EVENT_CALIBRATION_START` - –ù–∞—á–∞–ª–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
- `PUMP_EVENT_CALIBRATION_END` - –ö–æ–Ω–µ—Ü –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏

### **2. –î–∞–Ω–Ω—ã–µ PID –≤ —Å–æ–±—ã—Ç–∏—è—Ö:**
```c
typedef struct {
    float kp;           // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    float ki;           // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    float kd;           // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    float setpoint;     // –ó–∞–¥–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    float current_value; // –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    float error;        // –û—à–∏–±–∫–∞ (setpoint - current)
    float output;       // –í—ã—Ö–æ–¥ PID
    float integral;     // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è
    float derivative;   // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è
    bool enabled;       // –í–∫–ª—é—á–µ–Ω –ª–∏ PID
} pump_event_pid_data_t;
```

### **3. API —Ñ—É–Ω–∫—Ü–∏–∏:**

#### **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
```c
esp_err_t pump_events_init(void);
```

#### **–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π:**
```c
esp_err_t pump_events_send_start_event(
    pump_id_t pump_id,
    uint32_t duration_ms,
    float dose_ml,
    const pump_event_pid_data_t *pid_data,
    float ph, float ec,
    float ph_target, float ec_target,
    bool emergency_mode, bool autonomous_mode,
    int8_t rssi
);

esp_err_t pump_events_send_stop_event(
    pump_id_t pump_id,
    uint32_t duration_ms,
    float dose_ml,
    const pump_event_pid_data_t *pid_data,
    float ph, float ec,
    float ph_target, float ec_target,
    bool emergency_mode, bool autonomous_mode,
    int8_t rssi
);

esp_err_t pump_events_send_emergency_stop_event(
    pump_id_t pump_id,
    const char *reason,
    float ph, float ec,
    float ph_target, float ec_target,
    bool emergency_mode, bool autonomous_mode,
    int8_t rssi
);
```

#### **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö PID:**
```c
esp_err_t pump_events_get_pid_data(
    const pid_controller_t *pid,
    float current_value,
    pump_event_pid_data_t *pid_data
);
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### **1. pump_controller.c:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞—Å–æ—Å–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞—Å–æ—Å–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —Å–æ–±—ã—Ç–∏–π

### **2. ph_ec_manager.c:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `control_ph_ec()` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ PID
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö pH/EC –∏ PID –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞—Å–æ—Å–∞ —á–µ—Ä–µ–∑ PID

### **3. CMakeLists.txt:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è `pump_events`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## üìä –§–æ—Ä–º–∞—Ç JSON —Å–æ–±—ã—Ç–∏–π

### **–ü—Ä–∏–º–µ—Ä —Å–æ–±—ã—Ç–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Å–æ—Å–∞:**
```json
{
  "type": "event",
  "node_id": "ph_ec_001",
  "node_type": "ph_ec",
  "timestamp": 1703123456,
  "level": "info",
  "data": {
    "event_type": "pump_start",
    "pump_id": 0,
    "duration_ms": 5000,
    "dose_ml": 2.5,
    "ml_per_second": 2.0,
    "pid_data": {
      "kp": 1.2,
      "ki": 0.1,
      "kd": 0.5,
      "setpoint": 6.5,
      "current_value": 6.0,
      "error": 0.5,
      "output": 2.5,
      "integral": 0.0,
      "derivative": 0.0,
      "enabled": true
    },
    "current_ph": 6.0,
    "current_ec": 1.2,
    "ph_target": 6.5,
    "ec_target": 1.5,
    "emergency_mode": false,
    "autonomous_mode": false,
    "rssi": -45
  }
}
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

### **1. –ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- üìà –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Å–æ—Å–∞
- üîç –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ PID –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- ‚è±Ô∏è –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:**
- üêõ –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å PID –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- üì° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∏ (RSSI)
- üö® –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
- üîß –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º:**
- üåê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- üì± Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- üìä –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- üîî –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `test_pump_events.json` - –ü—Ä–∏–º–µ—Ä—ã —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### **–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. **–ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞:** –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–≤ —á–µ—Ä–µ–∑ PID
2. **–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞:** –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ pH/EC
3. **–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º:** –†–∞–±–æ—Ç–∞ –±–µ–∑ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
4. **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞:** –°–æ–±—ã—Ç–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –Ω–∞—Å–æ—Å–æ–≤

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### **‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- [x] –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ MQTT
- [x] –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π

### **üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –û–Ω–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∏.

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é! üéâ**
