# üîó –û—Ç—á–µ—Ç: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤

## üìã –û–±–∑–æ—Ä

–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ –æ—Ç –Ω–æ–¥ –¥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö.

## üîÑ –ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö

### **1. –ù–æ–¥–∞ ‚Üí ROOT ‚Üí MQTT ‚Üí –°–µ—Ä–≤–µ—Ä ‚Üí –ë–î ‚Üí –§—Ä–æ–Ω—Ç**

```
üì± NODE (pH/EC/ph_ec)
  ‚Üì mesh_manager_send_to_root()
üîÑ ROOT NODE (data_router)
  ‚Üì mqtt_client_manager_publish()
üì° MQTT Broker (Mosquitto)
  ‚Üì MQTT subscribe
üñ•Ô∏è Laravel MqttService
  ‚Üì Event::create()
üóÑÔ∏è PostgreSQL (events table)
  ‚Üì Laravel Broadcasting
üåê WebSocket (Reverb)
  ‚Üì WebSocket client
üíª Vue.js Frontend
  ‚Üì Real-time update
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### **1. –ù–æ–¥—ã (ESP32):**
- ‚úÖ **node_ph** - –°–æ–±—ã—Ç–∏—è –Ω–∞—Å–æ—Å–æ–≤ pH UP/DOWN
- ‚úÖ **node_ec** - –°–æ–±—ã—Ç–∏—è –Ω–∞—Å–æ—Å–æ–≤ EC A/B/C  
- ‚úÖ **node_ph_ec** - –°–æ–±—ã—Ç–∏—è –≤—Å–µ—Ö –Ω–∞—Å–æ—Å–æ–≤
- ‚úÖ **pump_events** - –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏ PID
- ‚úÖ **mesh_manager** - –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ mesh —Å–µ—Ç—å

### **2. ROOT –Ω–æ–¥–∞:**
- ‚úÖ **data_router** - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è mesh ‚Üí MQTT
- ‚úÖ **mqtt_client_manager** - –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ MQTT
- ‚úÖ **mesh_protocol** - –ü–∞—Ä—Å–∏–Ω–≥ JSON —Å–æ–æ–±—â–µ–Ω–∏–π

### **3. MQTT Broker:**
- ‚úÖ **Mosquitto** - –ü—Ä–∏–µ–º –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ **–¢–æ–ø–∏–∫–∏:** `hydro/event/{node_id}`
- ‚úÖ **QoS:** 1 (at least once delivery)

### **4. –°–µ—Ä–≤–µ—Ä (Laravel):**
- ‚úÖ **MqttService** - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤
- ‚úÖ **Event Model** - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
- ‚úÖ **EventCreated** - Broadcast —á–µ—Ä–µ–∑ WebSocket
- ‚úÖ **–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –ü–µ—Ä–µ–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞—Å–æ—Å–æ–≤

### **5. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL):**
- ‚úÖ **events table** - –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ **JSONB –ø–æ–ª–µ** - –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã** - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **GIN –∏–Ω–¥–µ–∫—Å** - –ü–æ–∏—Å–∫ –ø–æ JSON –¥–∞–Ω–Ω—ã–º

### **6. –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Vue.js):**
- ‚úÖ **Events.vue** - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ **EventLog.vue** - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ª–æ–≥–∞ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ **events store** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- ‚úÖ **WebSocket** - Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### **1. MqttService.php:**
```php
// –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤
if (isset($data['data']['event_type']) && strpos($data['data']['event_type'], 'pump_') === 0) {
    $message = $this->translatePumpEventMessage($data['data']);
    $level = $this->getPumpEventLevel($data['data']);
}
```

### **2. –ü–µ—Ä–µ–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞—Å–æ—Å–æ–≤:**
- üö∞ **pump_start** ‚Üí "–ù–∞—Å–æ—Å {name} –∑–∞–ø—É—â–µ–Ω: {dose} –º–ª ({duration} –º—Å)"
- üõë **pump_stop** ‚Üí "–ù–∞—Å–æ—Å {name} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {dose} –º–ª ({duration} –º—Å)"
- üö® **pump_emergency_stop** ‚Üí "–ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ {name}"
- ‚è∞ **pump_timeout** ‚Üí "–¢–∞–π–º–∞—É—Ç –Ω–∞—Å–æ—Å–∞ {name}"
- üîß **pump_calibration_*** ‚Üí "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ {name}"

### **3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π —Å–æ–±—ã—Ç–∏–π:**
- **INFO** - pump_start, pump_stop, pump_calibration_*
- **WARNING** - pump_timeout
- **CRITICAL** - pump_emergency_stop

### **4. –ù–∞–∑–≤–∞–Ω–∏—è –Ω–∞—Å–æ—Å–æ–≤ –ø–æ —Ç–∏–ø–∞–º –Ω–æ–¥:**
- **pH –Ω–æ–¥–∞:** pH UP (0), pH DOWN (1)
- **EC –Ω–æ–¥–∞:** EC A (0), EC B (1), EC C (2)
- **ph_ec –Ω–æ–¥–∞:** pH UP (0), pH DOWN (1), EC A (2), EC B (3), EC C (4)

## üìä –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏—è –≤ PostgreSQL:**
```sql
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    node_id VARCHAR NOT NULL,
    level VARCHAR NOT NULL, -- 'info', 'warning', 'critical', 'emergency'
    message TEXT NOT NULL,
    data JSONB, -- –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    resolved_at TIMESTAMP NULL,
    resolved_by VARCHAR NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### **–ü—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è:**
```json
{
  "id": 123,
  "node_id": "ph_001",
  "level": "info",
  "message": "üö∞ –ù–∞—Å–æ—Å pH UP –∑–∞–ø—É—â–µ–Ω: 1.5 –º–ª (3000 –º—Å)",
  "data": {
    "event_type": "pump_start",
    "pump_id": 0,
    "duration_ms": 3000,
    "dose_ml": 1.5,
    "ml_per_second": 2.0,
    "pid_data": {
      "kp": 1.5,
      "ki": 0.2,
      "kd": 0.8,
      "setpoint": 6.5,
      "current_value": 6.0,
      "error": 0.5,
      "output": 1.5,
      "integral": 0.0,
      "derivative": 0.0,
      "enabled": true
    },
    "current_ph": 6.0,
    "ph_target": 6.5,
    "emergency_mode": false,
    "autonomous_mode": false,
    "rssi": -45
  },
  "resolved_at": null,
  "resolved_by": null,
  "created_at": "2024-01-01 12:00:00",
  "updated_at": "2024-01-01 12:00:00"
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. **pH –Ω–æ–¥–∞** - –°–æ–±—ã—Ç–∏—è –Ω–∞—Å–æ—Å–æ–≤ pH UP/DOWN
2. **EC –Ω–æ–¥–∞** - –°–æ–±—ã—Ç–∏—è –Ω–∞—Å–æ—Å–æ–≤ EC A/B/C
3. **ph_ec –Ω–æ–¥–∞** - –°–æ–±—ã—Ç–∏—è –≤—Å–µ—Ö –Ω–∞—Å–æ—Å–æ–≤
4. **–ê–≤–∞—Ä–∏–π–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
5. **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–æ–≤** - –°–æ–±—ã—Ç–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏

### **–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `test_full_chain_pump_events.json` - –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã —Ü–µ–ø–æ—á–∫–∏
- `test_ph_pump_events.json` - –¢–µ—Å—Ç—ã pH –Ω–æ–¥—ã
- `test_ec_pump_events.json` - –¢–µ—Å—Ç—ã EC –Ω–æ–¥—ã
- `test_pump_events.json` - –¢–µ—Å—Ç—ã ph_ec –Ω–æ–¥—ã

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### **‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç –Ω–æ–¥
- [x] –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ ROOT –Ω–æ–¥—É
- [x] –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ MQTT
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [x] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
- [x] Broadcast —á–µ—Ä–µ–∑ WebSocket
- [x] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- [x] Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### **üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- [x] –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤
- [x] –ü–µ—Ä–µ–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- [x] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ —Å–æ–±—ã—Ç–∏–π
- [x] –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ PID –≤ JSONB
- [x] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ –æ—Ç –Ω–æ–¥ –¥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- **–ü–æ–ª–Ω—É—é —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å** —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–æ–≤
- **–î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ PID** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- **–ü—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é** —Å–æ–±—ã—Ç–∏–π
- **–£–¥–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ**
