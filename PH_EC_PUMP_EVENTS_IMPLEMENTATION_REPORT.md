# üö∞ –û—Ç—á–µ—Ç: –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ –¥–ª—è –Ω–æ–¥ pH –∏ EC

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –Ω–æ–¥ `node_ph` –∏ `node_ec` —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤. –ö–∞–∂–¥–∞—è –Ω–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏/–≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Å–≤–æ–∏—Ö –Ω–∞—Å–æ—Å–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è node_ph:**
- **`node_ph/components/pump_events/`** - –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è pH –Ω–∞—Å–æ—Å–æ–≤
- **`ph_manager`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å pH –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞—Å–æ—Å–æ–≤:** PH_UP, PH_DOWN

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è node_ec:**
- **`node_ec/components/pump_events/`** - –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è EC –Ω–∞—Å–æ—Å–æ–≤  
- **`ec_manager`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EC –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞—Å–æ—Å–æ–≤:** EC_A, EC_B, EC_C

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### **1. –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è node_ph:**

#### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏—è pH:**
```c
typedef struct {
    pump_event_type_t type;         // –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
    pump_id_t pump_id;              // ID –Ω–∞—Å–æ—Å–∞ (PH_UP –∏–ª–∏ PH_DOWN)
    uint32_t timestamp;             // –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
    uint32_t duration_ms;           // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
    float dose_ml;                  // –î–æ–∑–∞ –≤ –º–ª
    float ml_per_second;            // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    pump_event_pid_data_t pid_data; // –î–∞–Ω–Ω—ã–µ PID
    float current_ph;               // –¢–µ–∫—É—â–∏–π pH
    float ph_target;                // –¶–µ–ª–µ–≤–æ–π pH
    bool emergency_mode;            // –†–µ–∂–∏–º –∞–≤–∞—Ä–∏–∏
    bool autonomous_mode;           // –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º
    int8_t rssi;                    // RSSI –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É —É–∑–ª—É
} pump_event_t;
```

#### **API —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è pH:**
```c
esp_err_t pump_events_send_start_event(
    pump_id_t pump_id,              // PH_UP –∏–ª–∏ PH_DOWN
    uint32_t duration_ms,
    float dose_ml,
    const pump_event_pid_data_t *pid_data,
    float ph,
    float ph_target,
    bool emergency_mode, bool autonomous_mode,
    int8_t rssi
);

esp_err_t pump_events_send_stop_event(
    pump_id_t pump_id,
    uint32_t duration_ms,
    float dose_ml,
    const pump_event_pid_data_t *pid_data,
    float ph,
    float ph_target,
    bool emergency_mode, bool autonomous_mode,
    int8_t rssi
);
```

### **2. –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è node_ec:**

#### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏—è EC:**
```c
typedef struct {
    pump_event_type_t type;         // –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
    pump_id_t pump_id;              // ID –Ω–∞—Å–æ—Å–∞ (EC_A, EC_B, EC_C)
    uint32_t timestamp;             // –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
    uint32_t duration_ms;           // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
    float dose_ml;                  // –î–æ–∑–∞ –≤ –º–ª
    float ml_per_second;            // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    pump_event_pid_data_t pid_data; // –î–∞–Ω–Ω—ã–µ PID
    float current_ec;               // –¢–µ–∫—É—â–∏–π EC
    float ec_target;                // –¶–µ–ª–µ–≤–æ–π EC
    bool emergency_mode;            // –†–µ–∂–∏–º –∞–≤–∞—Ä–∏–∏
    bool autonomous_mode;           // –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º
    int8_t rssi;                    // RSSI –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É —É–∑–ª—É
} pump_event_t;
```

#### **API —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è EC:**
```c
esp_err_t pump_events_send_start_event(
    pump_id_t pump_id,              // EC_A, EC_B –∏–ª–∏ EC_C
    uint32_t duration_ms,
    float dose_ml,
    const pump_event_pid_data_t *pid_data,
    float ec,
    float ec_target,
    bool emergency_mode, bool autonomous_mode,
    int8_t rssi
);
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏

### **1. ph_manager.c:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω include `pump_events.h`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `control_ph()` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ PH_UP –∏ PH_DOWN –Ω–∞—Å–æ—Å–æ–≤
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö PID –∏–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω CMakeLists.txt —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é `pump_events`

### **2. ec_manager.c:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω include `pump_events.h`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `control_ec()` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—Å–µ—Ö 3 –Ω–∞—Å–æ—Å–æ–≤ EC (A, B, C)
- ‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–∑: A=50%, B=40%, C=10%
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö PID –∏–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω CMakeLists.txt —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é `pump_events`

## üìä –§–æ—Ä–º–∞—Ç JSON —Å–æ–±—ã—Ç–∏–π

### **–ü—Ä–∏–º–µ—Ä —Å–æ–±—ã—Ç–∏—è pH –Ω–∞—Å–æ—Å–∞:**
```json
{
  "type": "event",
  "node_id": "ph_001",
  "node_type": "ph",
  "timestamp": 1703123456,
  "level": "info",
  "data": {
    "event_type": "pump_start",
    "pump_id": 0,
    "duration_ms": 3000,
    "dose_ml": 1.5,
    "ml_per_second": 2.0,
    "pid_data": {
      "kp": 1.5,
      "ki": 0.2,
      "kd": 0.8,
      "setpoint": 6.5,
      "current_value": 6.0,
      "error": 0.5,
      "output": 1.5,
      "integral": 0.0,
      "derivative": 0.0,
      "enabled": true
    },
    "current_ph": 6.0,
    "ph_target": 6.5,
    "emergency_mode": false,
    "autonomous_mode": false,
    "rssi": -45
  }
}
```

### **–ü—Ä–∏–º–µ—Ä —Å–æ–±—ã—Ç–∏—è EC –Ω–∞—Å–æ—Å–∞:**
```json
{
  "type": "event",
  "node_id": "ec_001",
  "node_type": "ec",
  "timestamp": 1703123456,
  "level": "info",
  "data": {
    "event_type": "pump_start",
    "pump_id": 0,
    "duration_ms": 2000,
    "dose_ml": 2.5,
    "ml_per_second": 2.0,
    "pid_data": {
      "kp": 1.2,
      "ki": 0.15,
      "kd": 0.6,
      "setpoint": 1.5,
      "current_value": 1.2,
      "error": 0.3,
      "output": 2.5,
      "integral": 0.0,
      "derivative": 0.0,
      "enabled": true
    },
    "current_ec": 1.2,
    "ec_target": 1.5,
    "emergency_mode": false,
    "autonomous_mode": false,
    "rssi": -45
  }
}
```

## üéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### **1. node_ph (pH –Ω–æ–¥–∞):**
- üîÑ **2 –Ω–∞—Å–æ—Å–∞:** PH_UP –∏ PH_DOWN
- üìä **PID –¥–∞–Ω–Ω—ã–µ:** –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π PID —Å –∑–æ–Ω–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- üéØ **–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:** pH target
- üìà **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –¢–µ–∫—É—â–∏–π pH vs —Ü–µ–ª–µ–≤–æ–π pH

### **2. node_ec (EC –Ω–æ–¥–∞):**
- üîÑ **3 –Ω–∞—Å–æ—Å–∞:** EC_A, EC_B, EC_C
- üìä **PID –¥–∞–Ω–Ω—ã–µ:** –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π PID —Å –∑–æ–Ω–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- üéØ **–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:** EC target
- üìà **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –¢–µ–∫—É—â–∏–π EC vs —Ü–µ–ª–µ–≤–æ–π EC
- ‚öñÔ∏è **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–∑:** A=50%, B=40%, C=10%

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `test_ph_pump_events.json` - –ü—Ä–∏–º–µ—Ä—ã —Å–æ–±—ã—Ç–∏–π pH –Ω–æ–¥—ã
- `test_ec_pump_events.json` - –ü—Ä–∏–º–µ—Ä—ã —Å–æ–±—ã—Ç–∏–π EC –Ω–æ–¥—ã

### **–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. **pH –Ω–æ–¥–∞:** –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ PH_UP –∏ PH_DOWN –Ω–∞—Å–æ—Å–æ–≤
2. **EC –Ω–æ–¥–∞:** –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö 3 –Ω–∞—Å–æ—Å–æ–≤ EC
3. **–ê–≤–∞—Ä–∏–π–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:** –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
4. **–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º:** –†–∞–±–æ—Ç–∞ –±–µ–∑ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### **node_ph:**
- `node_ph/components/pump_events/pump_events.h`
- `node_ph/components/pump_events/pump_events.c`
- `node_ph/components/pump_events/CMakeLists.txt`

### **node_ec:**
- `node_ec/components/pump_events/pump_events.h`
- `node_ec/components/pump_events/pump_events.c`
- `node_ec/components/pump_events/CMakeLists.txt`

### **–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `test_ph_pump_events.json`
- `test_ec_pump_events.json`

### **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `node_ph/components/ph_manager/ph_manager.c`
- `node_ph/components/ph_manager/CMakeLists.txt`
- `node_ec/components/ec_manager/ec_manager.c`
- `node_ec/components/ec_manager/CMakeLists.txt`

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### **‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- [x] –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è node_ph
- [x] –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è node_ec
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ph_manager
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ec_manager
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ MQTT
- [x] –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ PID
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π

### **üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ pH –∏ EC –Ω–æ–¥
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–ª—è –Ω–æ–¥ pH –∏ EC. –ö–∞–∂–¥–∞—è –Ω–æ–¥–∞ —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –Ω–∞—Å–æ—Å–æ–≤ —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∏.

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é! üéâ**
