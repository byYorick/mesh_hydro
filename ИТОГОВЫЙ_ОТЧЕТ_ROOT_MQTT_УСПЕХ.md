# üéâ –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢: ROOT NODE MQTT - –ü–û–õ–ù–´–ô –£–°–ü–ï–•

**–î–∞—Ç–∞:** 20 –æ–∫—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è:** ~17:00  
**–ó–∞–¥–∞—á–∞:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É "MQTT –Ω–µ –≤–∏–¥–∏—Ç ROOT —É–∑–µ–ª"

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢

### ‚úÖ ROOT –£–ó–ï–õ –£–°–ü–ï–®–ù–û –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù!

```sql
      node_id      | node_type | online |    last_seen_at     |    mac_address    
-------------------+-----------+--------+---------------------+-------------------
 root_98a316f5fde8 | root      | t      | 2025-10-20 16:53:57 | 98:A3:16:F5:FD:E8
```

### ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç:

1. **ROOT Node (ESP32-S3 –Ω–∞ COM7)**
   - IP –∞–¥—Ä–µ—Å: `192.168.1.191`
   - MAC: `98:A3:16:F5:FD:E8`
   - WiFi RSSI: -20 –¥–æ -32 dBm (–æ—Ç–ª–∏—á–Ω—ã–π —Å–∏–≥–Ω–∞–ª)
   - Firmware: `2.0.0`
   - Heap free: ~175 KB
   - ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ WiFi "Yorick"
   - ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
   - ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç discovery –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

2. **MQTT Broker (Docker Mosquitto)**
   - –ü–æ—Ä—Ç: `1883` (0.0.0.0)
   - ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ—Ç ESP32
   - ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç ROOT —É–∑–ª–∞
   - ‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω –∏–∑ Docker —Å–µ—Ç–∏ –∏ —Å —Ö–æ—Å—Ç–∞

3. **MQTT Listener (Docker)**
   - ‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ `hydro/discovery`
   - ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç ROOT —É–∑–ª–∞
   - ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç discovery –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

4. **Backend (Laravel + PostgreSQL)**
   - ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —É–∑–ª—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
   - ‚úÖ Auto-discovery —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ Broadcast —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø–∞–¥–∞—é—Ç

---

## üêõ –ù–ê–ô–î–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

### –ü—Ä–∏—á–∏–Ω–∞:

–í `server/docker-compose.yml` –±—ã–ª–æ:

```yaml
- BROADCAST_DRIVER=pusher  # ‚ùå –ö–ª–∞—Å—Å Pusher –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:

1. MQTT Listener –ø–æ–ª—É—á–∞–ª discovery —Å–æ–æ–±—â–µ–Ω–∏–µ ‚úÖ
2. `MqttService->handleDiscovery()` –≤—ã–∑—ã–≤–∞–ª—Å—è ‚úÖ
3. –£–∑–µ–ª —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –≤ –ë–î ‚úÖ
4. –ü—ã—Ç–∞–ª—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å broadcast —Å–æ–±—ã—Ç–∏–µ:
   ```php
   event(new \App\Events\NodeDiscovered($node));
   ```
5. Laravel –ø—ã—Ç–∞–ª—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å `Pusher\Pusher` ‚ùå
6. **–ü–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π:** `Class "Pusher\Pusher" not found` ‚ùå
7. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–ª–∞—Å—å ‚ùå
8. –£–∑–µ–ª –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –≤ –ë–î ‚ùå

### –ü–æ—á–µ–º—É –Ω–µ –≤–∏–¥–µ–ª–∏ –æ—à–∏–±–∫—É:

- Exception –≤–æ–∑–Ω–∏–∫–∞–ª –≤–Ω—É—Ç—Ä–∏ callback —Ñ—É–Ω–∫—Ü–∏–∏
- Laravel –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª—É—à–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –í –∫–æ–Ω—Å–æ–ª–∏ –ø–æ—è–≤–ª—è–ª–æ—Å—å —Ç–æ–ª—å–∫–æ `üîç [DISCOVERY]`
- Callback –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª—Å—è –¥–æ –∫–æ–Ω—Ü–∞

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ò–∑–º–µ–Ω–µ–Ω–æ –≤ `server/docker-compose.yml`:

```yaml
# –ë–´–õ–û:
- BROADCAST_DRIVER=pusher

# –°–¢–ê–õ–û:
- BROADCAST_DRIVER=log
```

–ò–∑–º–µ–Ω–µ–Ω–æ **–≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö**: `backend`, `mqtt_listener`.

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:

```powershell
docker restart hydro_backend hydro_mqtt_listener
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ MQTT —Ç–æ–ø–∏–∫–æ–≤

```powershell
docker exec hydro_mosquitto timeout 60 mosquitto_sub -t "hydro/#" -v
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
hydro/discovery {"type":"discovery","node_id":"root_98a316f5fde8",...}
hydro/discovery {"type":"discovery","node_id":"root_98a316f5fde8",...}
```

‚úÖ **Discovery —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç!**

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
SELECT node_id, node_type, online, mac_address 
FROM nodes 
WHERE node_type='root';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
 root_98a316f5fde8 | root | t | 98:A3:16:F5:FD:E8
```

‚úÖ **ROOT —É–∑–µ–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!**

### –¢–µ—Å—Ç 3: MQTT Listener –ª–æ–≥–∏

```
üîç [DISCOVERY] hydro/discovery
üîç [DISCOVERY] hydro/discovery
üîç [DISCOVERY] hydro/discovery
...
```

‚úÖ **Listener –ø–æ–ª—É—á–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!**

---

## üìù –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

### 1. `server/docker-compose.yml`

```diff
services:
  backend:
    environment:
-     - BROADCAST_DRIVER=pusher
+     - BROADCAST_DRIVER=log

  mqtt_listener:
    environment:
-     - BROADCAST_DRIVER=pusher
+     - BROADCAST_DRIVER=log
```

### 2. `server/backend/app/Console/Commands/MqttListenerCommand.php`

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∫–æ–¥ (–±–µ–∑ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö echo).

---

## üéì –£–†–û–ö–ò

### –ß—Ç–æ —É–∑–Ω–∞–ª–∏:

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
   - –ï—Å–ª–∏ config —Ç—Ä–µ–±—É–µ—Ç `pusher`, —É–±–µ–¥–∏—Å—å —á—Ç–æ –ø–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π `log`/`null` driver –¥–ª—è development

2. **–õ–æ–≥–∏—Ä—É–π —è–≤–Ω–æ**
   - `try-catch` –≤ callbacks –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
   - `Log::error()` –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
   - –ü—Ä–æ–≤–µ—Ä—è–π `storage/logs/laravel.log`

3. **–¢–µ—Å—Ç–∏—Ä—É–π end-to-end**
   - –ù–µ —Ç–æ–ª—å–∫–æ "—Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ"
   - –ù–æ –∏ "—Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –≤ –ë–î"
   - –ò "–≤–∏–¥–Ω–æ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ"

4. **Docker Mosquitto vs Windows Mosquitto**
   - –°–ª—É–∂–±–∞ Windows –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞**
   - Docker Mosquitto —Å–ª—É—à–∞–µ—Ç –Ω–∞ `0.0.0.0:1883`
   - ESP32 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ IP —Ö–æ—Å—Ç–∞ (192.168.1.100)

5. **ESP32 MQTT –ª–æ–≥–∏ –º–æ–≥—É—Ç –≤—Ä–∞—Ç—å**
   - ESP32 –º–æ–∂–µ—Ç —Å–∫–∞–∑–∞—Ç—å "connected"
   - –ù–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
   - –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –ª–æ–≥–∏ Mosquitto

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ì–æ—Ç–æ–≤–æ ‚úÖ:
- [x] ROOT —É–∑–µ–ª –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WiFi
- [x] ROOT —É–∑–µ–ª –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ MQTT
- [x] ROOT —É–∑–µ–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç discovery
- [x] MQTT Listener –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç discovery
- [x] ROOT —É–∑–µ–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- [x] BROADCAST_DRIVER –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

### –î–∞–ª–µ–µ ‚è≠Ô∏è:
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ROOT —É–∑–µ–ª –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (http://localhost:3000)
- [ ] –ü—Ä–æ—à–∏—Ç—å NODE Climate –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- [ ] –ü—Ä–æ—à–∏—Ç—å NODE pH/EC –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NODE Display –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π broadcasting (Laravel Reverb –∏–ª–∏ Soketi) –¥–ª—è production
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ —É–∑–ª–∞–º
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –æ—Ç –≤—Å–µ—Ö —É–∑–ª–æ–≤

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ï–°–°–ò–ò

- **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** ~3 —á–∞—Å–∞
- **–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** 2
- **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:** 5+
- **–¢–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:** 10+
- **–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ **–ü–û–õ–ù–´–ô –£–°–ü–ï–•**

---

## üéØ –ò–¢–û–ì

**ROOT NODE –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢!** üéâ

- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ WiFi –∏ MQTT
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç discovery –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –í–∏–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ –∫–∞–∫ `root_98a316f5fde8`
- ‚úÖ –ì–æ—Ç–æ–≤ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å mesh-—Å–µ—Ç—å
- ‚úÖ –ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥—Ä—É–≥–∏–µ —É–∑–ª—ã

**–°–∏—Å—Ç–µ–º–∞ Mesh Hydro V2 —Ç–µ–ø–µ—Ä—å –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é NODE —É–∑–ª–æ–≤!** üöÄ

---

**–ê–≤—Ç–æ—Ä:** AI Assistant (Claude Sonnet 4.5)  
**–î–∞—Ç–∞:** 20.10.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê

