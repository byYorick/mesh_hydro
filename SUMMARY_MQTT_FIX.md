# üìã –°–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–î–∞—Ç–∞:** 22 –æ–∫—Ç—è–±—Ä—è 2025

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω IP –∞–¥—Ä–µ—Å MQTT –±—Ä–æ–∫–µ—Ä–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
‚ùå –°—Ç–∞—Ä—ã–π IP: 192.168.1.100
‚úÖ –ù–æ–≤—ã–π IP:  192.168.0.167
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `root_node/components/mqtt_client/mqtt_client_manager.c`
  - –£–¥–∞–ª—ë–Ω –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—ã–π IP
  - –î–æ–±–∞–≤–ª–µ–Ω `#include "mesh_config.h"`
  - –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π MQTT_BROKER_URI

- `root_node/components/mqtt_client/CMakeLists.txt`
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `mesh_config` –≤ REQUIRES

- `root_node/README.md`
  - –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã —Å 192.168.1.100 –Ω–∞ 192.168.0.167

### 2. ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:** `common/mesh_config/mesh_config.h`
```c
#define MQTT_BROKER_HOST  "192.168.0.167"
#define MQTT_BROKER_PORT  1883
#define MQTT_BROKER_URI   "mqtt://192.168.0.167:1883"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å–µ —É–∑–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å IP –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

---

## üì° –¢–µ–∫—É—â–∞—è —Å–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | IP/URL | –ü–æ—Ä—Ç | –°—Ç–∞—Ç—É—Å |
|-----------|--------|------|--------|
| MQTT Broker | 192.168.0.167 | 1883 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| Backend API | 192.168.0.167 | 8000 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| Frontend | 192.168.0.167 | 3000 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| WebSocket | 192.168.0.167 | 8080 | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| ROOT Node | 192.168.0.104 | - | üîÑ –ü–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∫–∞ |

**–°–µ—Ç—å:**
- Gateway: 192.168.0.1
- Subnet: 255.255.255.0

---

## üîÑ –°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏

**–ö–æ–º–∞–Ω–¥–∞:** `idf.py build`  
**–ü—Ä–æ–µ–∫—Ç:** root_node  
**–°—Ç–∞—Ç—É—Å:** üîÑ **–í –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**

**–ü—Ä–æ—Ü–µ—Å—Å—ã:**
- ‚úÖ ninja - –∞–∫—Ç–∏–≤–µ–Ω
- ‚úÖ xtensa-esp32s3-elf-gcc - –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç
- ‚úÖ cmake - –Ω–∞—Å—Ç—Ä–æ–∏–ª –ø—Ä–æ–µ–∫—Ç

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
root_node/build/root_node.bin  (–ø—Ä–æ—à–∏–≤–∫–∞)
root_node/build/bootloader/bootloader.bin
root_node/build/partition_table/partition-table.bin
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏:

#### 1. –ü—Ä–æ—à–∏—Ç—å ROOT —É–∑–µ–ª
```bash
cd root_node
idf.py flash monitor
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
```
I (2467) mqtt_manager: Connecting to broker: mqtt://192.168.0.167:1883
I (2500) mqtt_manager: ‚úÖ MQTT connected to broker
I (2505) mqtt_manager: ‚úÖ Subscribed to hydro/command/#
I (2510) mqtt_manager: ‚úÖ Subscribed to hydro/config/#
I (2515) ROOT: MQTT Broker: mqtt://192.168.0.167:1883
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
```
http://192.168.0.167:3000
```

–£–∑–µ–ª **root_001** –¥–æ–ª–∂–µ–Ω:
- –ü–æ—è–≤–∏—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ —É–∑–ª–æ–≤
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å **Online** ‚úÖ
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é

#### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å MQTT —Ç–æ–ø–∏–∫–∏
```bash
# –ù–∞ —Ö–æ—Å—Ç–µ
mosquitto_sub -h 192.168.0.167 -t "hydro/#" -v
```

–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:
```
hydro/discovery {...}
hydro/heartbeat/root_001 {...}
hydro/telemetry/root_001 {...}
```

---

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

1. **`MQTT_FIX_LOG.md`**
   - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
   - –ü—Ä–æ—Ü–µ—Å—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

2. **`root_node/COMPILE_FIX.md`**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CMakeLists.txt

3. **`server/PRODUCTION_SETUP.md`**
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ production –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

4. **`server/SETUP_COMPLETE.md`**
   - –§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ IP –∞–¥—Ä–µ—Å–∞ –≤ –±—É–¥—É—â–µ–º:

**1. –ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ:**
```c
// common/mesh_config/mesh_config.h
#define MQTT_BROKER_HOST  "–ù–û–í–´–ô_IP"
#define MQTT_BROKER_URI   "mqtt://–ù–û–í–´–ô_IP:1883"
```

**2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å–µ —É–∑–ª—ã:**
```bash
cd root_node && idf.py build flash
cd node_climate && idf.py build flash
cd node_ph_ec && idf.py build flash
```

**3. –ù–ï –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–∏–≤–∞—Ç—å IP –≤ –∫–æ–¥–µ!**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mesh_config.h
- ‚ùå –ù–µ –ø–∏—Å–∞—Ç—å IP –Ω–∞–ø—Ä—è–º—É—é –≤ .c —Ñ–∞–π–ª–∞—Ö

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏

### 1. –õ–æ–≥–∏ ROOT —É–∑–ª–∞
```bash
idf.py monitor
```

### 2. –õ–æ–≥–∏ MQTT Listener
```bash
docker logs hydro_mqtt_listener -f
```

### 3. –õ–æ–≥–∏ MQTT –±—Ä–æ–∫–µ—Ä–∞
```bash
docker logs hydro_mosquitto --tail 50
```

### 4. API –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
curl http://192.168.0.167:8000/api/nodes
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã  
**–°–±–æ—Ä–∫–∞:** üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ—à–∏—Ç—å ROOT —É–∑–µ–ª –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏

