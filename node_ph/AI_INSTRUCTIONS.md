# AI INSTRUCTIONS - NODE pH

## üéØ –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –Ω–æ–¥—ã

NODE pH - —ç—Ç–æ **–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —É–∑–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è pH** –≤ —Å–∏—Å—Ç–µ–º–µ Mesh Hydro.

**–ó–∞–¥–∞—á–∏:**
1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ pH –¥–∞—Ç—á–∏–∫–∞ Trema (I2C 0x4D)
2. PID —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2 –Ω–∞—Å–æ—Å–∞–º–∏ (pH UP, pH DOWN)
3. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ mesh —Å–µ—Ç—å (ROOT node)
4. –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏
5. Emergency protection –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **ph_sensor** - –¥—Ä–∞–π–≤–µ—Ä Trema pH (I2C 0x4D)
2. **pump_controller** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2 –Ω–∞—Å–æ—Å–∞–º–∏ (GPIO 2, 3)
3. **pid_controller** - PID –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ pH
4. **ph_manager** - –≥–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —É–∑–ª–∞
5. **oled_display** - OLED SSD1306 –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
6. **connection_monitor** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–≤—è–∑–∏ —Å ROOT
7. **local_storage** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ offline
8. **buzzer_led** - –∑–≤—É–∫–æ–≤–∞—è –∏ —Å–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è

### Common –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∏–∑ ../common/):
- mesh_manager - ESP-MESH API
- mesh_protocol - –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–æ–±—â–µ–Ω–∏–π
- node_config - NVS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- mesh_config - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

---

## üîå –ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### ESP32-C3:
- **I2C**: GPIO8 (SDA), GPIO9 (SCL)
- **–ù–∞—Å–æ—Å—ã**: GPIO2 (pH UP), GPIO3 (pH DOWN)
- **LED**: GPIO4
- **Buzzer**: GPIO5

### I2C —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:
- **pH Sensor**: 0x4D (Trema pH)
- **OLED**: 0x3C (SSD1306 128x64)

---

## üìä PID —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –õ–æ–≥–∏–∫–∞:
- **–¶–µ–ª—å**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å pH = target (–¥–µ—Ñ–æ–ª—Ç 6.5)
- **–ï—Å–ª–∏ pH < target**: –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å pH UP
- **–ï—Å–ª–∏ pH > target**: –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å pH DOWN

### PID –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ):
```c
Kp = 1.0  // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)
Ki = 0.05 // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)
Kd = 0.3  // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)
```

### Safety:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞: 60 —Å–µ–∫
- Cooldown –º–µ–∂–¥—É –≤–∫–ª—é—á–µ–Ω–∏—è–º–∏: 30 —Å–µ–∫
- Emergency stop –ø—Ä–∏ pH < 5.5 –∏–ª–∏ pH > 7.5

---

## üì° Mesh –ø—Ä–æ—Ç–æ–∫–æ–ª

### 1. Discovery (–ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ):
```json
{
  "type": "discovery",
  "node_id": "ph_XXXXXX",
  "node_type": "ph",
  "actuators": ["pump_ph_up", "pump_ph_down"],
  "sensors": ["ph"],
  "heap_free": 234567,
  "wifi_rssi": -45
}
```

### 2. Telemetry (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫):
```json
{
  "type": "telemetry",
  "node_id": "ph_XXXXXX",
  "data": {
    "ph": 6.8,
    "ph_target": 6.5,
    "pump_ph_up_ml": 150.5,
    "pump_ph_down_ml": 75.2,
    "pump_ph_up_total_ml": 5234.5,
    "pump_ph_down_total_ml": 3421.1
  }
}
```

### 3. Heartbeat (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫):
```json
{
  "type": "heartbeat",
  "node_id": "ph_XXXXXX",
  "uptime": 3600,
  "heap_free": 234567,
  "autonomous": false
}
```

### 4. –ö–æ–º–∞–Ω–¥—ã –æ—Ç ROOT:
```json
{
  "type": "command",
  "node_id": "ph_XXXXXX",
  "command": "set_ph_target",
  "params": {"target": 6.0}
}
```

---

## üîê –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞
NODE pH **–í–°–ï–ì–î–ê** —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ ROOT offline.
–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ NVS.

### ‚úÖ Emergency Protection
–ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö (pH < 5.5 –∏–ª–∏ > 7.5):
- –í—Å–µ –Ω–∞—Å–æ—Å—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
- Emergency flag = true
- SOS —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ ROOT (–µ—Å–ª–∏ online)

### ‚úÖ Graceful Degradation
–ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ pH=7.0
- –£–∑–µ–ª **–ù–ï –ø–∞–¥–∞–µ—Ç**
- –õ–æ–≥–∏: WARNING

---

## üõ†Ô∏è –ü—Ä–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥–∞

1. **–ù–ï —É–¥–∞–ª—è–π** –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º
2. **–ù–ï —É–¥–∞–ª—è–π** emergency protection
3. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π** –≤–æ–∑–≤—Ä–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π (esp_err_t)
4. **–õ–æ–≥–∏—Ä—É–π** –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (ESP_LOGI)
5. **–ò—Å–ø–æ–ª—å–∑—É–π** NVS –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Mock —Ä–µ–∂–∏–º:
–í `ph_sensor.c` –µ—Å—Ç—å —Ä–µ–∂–∏–º –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞:
```c
// –ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
*ph = 7.0f;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏:
1. NODE –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç discovery ‚Üí ROOT ‚Üí MQTT ‚Üí Backend ‚Üí Frontend
2. Telemetry: NODE ‚Üí ROOT ‚Üí MQTT ‚Üí Backend ‚Üí WebSocket ‚Üí Frontend
3. Command: Frontend ‚Üí Backend ‚Üí MQTT ‚Üí ROOT ‚Üí NODE

---

**NODE pH - –∫—Ä–∏—Ç–∏—á–Ω—ã–π —É–∑–µ–ª. –ê–≤—Ç–æ–Ω–æ–º–∏—è –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ!** üõ°Ô∏è

