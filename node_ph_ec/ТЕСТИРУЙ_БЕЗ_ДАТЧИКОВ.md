# 🎮 NODE pH/EC - ТЕСТИРОВАНИЕ БЕЗ ДАТЧИКОВ

**Моковый режим для проверки mesh и backend**

---

## ✅ ЧТО АКТИВИРОВАНО

```
🟢 Mesh сеть:        ДА (подключение к ROOT)
🟢 Heartbeat:        ДА (каждые 5 сек)
🟢 Telemetry:        ДА (каждые 10 сек)
🟢 PID контроллер:   ДА (работает с моковыми данными)
🟢 Насосы PWM:       ДА (можно не подключать физические)
🟢 Команды от ROOT:  ДА (обрабатываются)
🟢 Автономный режим: ДА (при offline ROOT)

🔴 I2C датчики:      НЕТ (моковые значения)
🔴 Реальные pH/EC:   НЕТ (симуляция 6.5 / 2.5)
```

---

## 🚀 БЫСТРЫЙ СТАРТ

### 1. Прошивка (3 минуты):

```batch
tools\flash_ph_ec.bat
```

### 2. Ожидаемый лог:

```
I (80) ph_ec_node: ⚠️ I2C ОТКЛЮЧЁН - используются моковые значения!
I (90) ph_ec_node: ⚠️ ДАТЧИКИ ОТКЛЮЧЕНЫ - симуляция данных!
I (105) ph_ec_node: ✅ MOCK MODE активирован - датчики не требуются!
I (275) ph_ec_node: - 5 pumps ready (GPIO 4,5,6,7,15)
I (1205) mesh_manager: NODE mode: will connect to mesh AP 'HYDRO1'
I (5405) mesh_manager: ✓ MESH Parent connected!
I (5410) mesh_manager: Layer: 2
I (11420) ph_ec_mgr: 🔍 Discovery sent to ROOT
D (16000) ph_ec_mgr: 📊 Mock sensors: pH=6.52, EC=2.48
I (16010) ph_ec_mgr: ✓ pH OK (target 6.50), EC OK (target 2.50)
I (16420) ph_ec_mgr: 💓 Heartbeat sent
I (21420) ph_ec_mgr: 📊 Telemetry: pH=6.52, EC=2.48, RSSI=-45
```

### 3. Проверь Dashboard:

http://localhost:3000

**Должен появиться:**
```
┌─────────────────────────────────┐
│ ph_ec_001 (pH/EC)        🟢 ON  │
├─────────────────────────────────┤
│ pH: 6.5 (target 6.5)            │
│ EC: 2.5 (target 2.5)            │
│ Temperature: 22.5°C             │
│ Status: Online                  │
│ Last seen: < 1 sec              │
└─────────────────────────────────┘
```

---

## 🧪 ТЕСТИРОВАНИЕ КОМАНД

### Тест 1: Изменить target значения

```bash
mosquitto_pub -h 192.168.1.100 -t hydro/command/ph_ec_001 -m '{
  "type": "command",
  "node_id": "ph_ec_001",
  "command": "set_targets",
  "params": {"ph_target": 6.2, "ec_target": 2.0}
}'
```

**Ожидаемый лог:**
```
I (50000) ph_ec_node: Message from ROOT: type=1
I (50005) ph_ec_mgr: Command received: set_targets
I (50010) ph_ec_mgr: Targets updated: pH=6.20, EC=2.00
I (50015) node_config: Config saved to NVS (ph_ec_ns)
```

**На Dashboard:**
```
pH: 6.5 (target 6.2) ← target изменился!
```

---

### Тест 2: Ручной запуск насоса

```bash
mosquitto_pub -h 192.168.1.100 -t hydro/command/ph_ec_001 -m '{
  "type": "command",
  "node_id": "ph_ec_001",
  "command": "manual_pump",
  "params": {"pump": "ph_up", "dose_ml": 2.5}
}'
```

**Ожидаемый лог:**
```
I (60000) ph_ec_node: Message from ROOT: type=1
I (60005) ph_ec_mgr: Command received: manual_pump
I (60010) pump_ctrl: Pump pH UP running (dose=2.5 ml, 5000 ms)
I (65015) pump_ctrl: Pump pH UP stopped (total: 2.5 ml)
```

---

### Тест 3: PID автоматическая коррекция

**Сценарий:** Mock pH уходит ниже 6.4 (target 6.5)

**Автоматически произойдёт:**
```
I (20000) ph_ec_mgr: 📊 Mock sensors: pH=6.38, EC=2.48
I (20005) ph_ec_mgr: pH UP: 0.24 ml (current=6.38, target=6.50)
I (20010) pump_ctrl: Pump pH UP running (dose=0.24 ml, 480 ms)
I (20495) pump_ctrl: Pump pH UP stopped (total: 0.24 ml)
```

**На Dashboard:**
```
Pump stats:
  pH UP: 2.74 ml (сегодня)
  pH DOWN: 0 ml
  EC A: 0 ml
  EC B: 0 ml
  EC C: 0 ml
```

---

## 🎯 ЧТО МОЖНО ПРОТЕСТИРОВАТЬ

### ✅ Без датчиков (Mock Mode):

- [x] Mesh подключение (ROOT → NODE)
- [x] Heartbeat отправка
- [x] Telemetry отправка
- [x] Discovery регистрация
- [x] Команды от сервера
- [x] PID расчёт дозировки
- [x] PWM насосы (GPIO активны)
- [x] Статистика насосов
- [x] Автономный режим
- [x] Emergency режим
- [x] Буферизация данных

### ❌ Требует датчиков:

- [ ] Реальные pH/EC значения
- [ ] Калибровка датчиков
- [ ] Температурная компенсация EC
- [ ] Точность PID коррекции

---

## 📊 МОКОВАЯ ТЕЛЕМЕТРИЯ

### Пример JSON (отправляется на Dashboard):

```json
{
  "type": "telemetry",
  "node_id": "ph_ec_001",
  "timestamp": 1729346400,
  "data": {
    "ph": 6.52,
    "ec": 2.48,
    "temperature": 22.5,
    "ph_target": 6.5,
    "ec_target": 2.5,
    "pump_ph_up_ml": 2.74,
    "pump_ph_down_ml": 0.0,
    "pump_ec_a_ml": 0.0,
    "pump_ec_b_ml": 0.0,
    "pump_ec_c_ml": 0.0,
    "mode": "online",
    "emergency": false,
    "autonomous": false,
    "rssi_to_parent": -45
  }
}
```

---

## 💡 ПРИМЕЧАНИЯ

### Mock PID поведение:

**PID будет корректировать моковые значения!**

Если установить `ph_target = 6.2`, а mock pH = 6.5:
```
1. PID видит ошибку: +0.3 (pH выше target)
2. PID активирует pH DOWN насос
3. Pump pH DOWN: 0.6 ml
4. Mock значение НЕ изменится (симуляция статична)
5. НО статистика обновится: ph_down_ml += 0.6
```

**Это нормально для Mock Mode!** В production PID реально изменит pH в растворе.

---

## 🎉 ГОТОВО К ТЕСТИРОВАНИЮ!

**Запусти:**

```batch
tools\flash_ph_ec.bat
```

**Проверь Dashboard через 30 секунд:**

http://localhost:3000

**Должны быть 3 узла ONLINE:**
- ✅ root_98a316f5fde8
- ✅ climate_001
- ✅ ph_ec_001 ← НОВЫЙ!

---

**МОКОВЫЙ РЕЖИМ ПОЗВОЛЯЕТ РАЗРАБАТЫВАТЬ БЕЗ ОБОРУДОВАНИЯ!** 🎮🚀

