# NODE pH/EC

ESP32-S3 - –ö—Ä–∏—Ç–∏—á–Ω—ã–π —É–∑–µ–ª —Å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

**NODE pH/EC** - **—Å–∞–º—ã–π –∫—Ä–∏—Ç–∏—á–Ω—ã–π —É–∑–µ–ª —Å–∏—Å—Ç–µ–º—ã** —Å –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π.

### ‚ö†Ô∏è –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- üìä –ò–∑–º–µ—Ä–µ–Ω–∏–µ pH –∏ EC (–¥–∞—Ç—á–∏–∫–∏ Trema I2C)
- üíß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 5 –Ω–∞—Å–æ—Å–∞–º–∏ (pH UP/DOWN, EC A/B/C)
- ü§ñ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
- üì∫ OLED –¥–∏—Å–ø–ª–µ–π SSD1306 128x64
- üîã **–ê–í–¢–û–ù–û–ú–ù–ê–Ø –†–ê–ë–û–¢–ê** –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏ —Å ROOT
- üíæ –õ–æ–∫–∞–ª—å–Ω—ã–π ring buffer (1000 –∑–∞–ø–∏—Å–µ–π)
- üî¥ LED + Buzzer –∏–Ω–¥–∏–∫–∞—Ü–∏—è
- üîò –ö–Ω–æ–ø–∫–∞ MODE (—Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

### üö® –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê:

1. ‚úÖ **–í–°–ï–ì–î–ê –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞**
   - –ï—Å–ª–∏ ROOT offline > 30 —Å–µ–∫ ‚Üí –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º
   - PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

2. ‚úÖ **–í–°–ï–ì–î–ê —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ NVS**
   - –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (pH target, EC target, PID –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—ã–∂–∏–≤–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ

3. ‚úÖ **–í–°–ï–ì–î–ê –ª–æ–∫–∞–ª—å–Ω—ã–π buffer**
   - –î–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ offline
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏

4. ‚úÖ **–í–°–ï–ì–î–ê watchdog**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–∏

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ò–∑ common/:
- `mesh_manager` - Mesh NODE —Ä–µ–∂–∏–º
- `mesh_protocol` - JSON –ø—Ä–æ—Ç–æ–∫–æ–ª
- `node_config` - NVS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ (components/):
- ‚úÖ `node_controller` - –≥–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —É–∑–ª–∞
- ‚úÖ `connection_monitor` - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–≤—è–∑–∏ —Å ROOT
- ‚úÖ `local_storage` - ring buffer –¥–ª—è offline –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `oled_display` - SSD1306 128x64 –¥–∏—Å–ø–ª–µ–π
- ‚úÖ `buzzer_led` - LED + Buzzer + Button
- üîÑ `sensor_manager` - **TODO: –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0**
- üîÑ `pump_manager` - **TODO: –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0**
- üîÑ `adaptive_pid` - **TODO: –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0**

## üîå –†–∞—Å–ø–∏–Ω–æ–≤–∫–∞

| GPIO | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|------------|------------|
| **I2C —à–∏–Ω–∞:** | | |
| 17 | SCL | pH, EC, OLED |
| 18 | SDA | pH, EC, OLED |
| - | pH (0x0A) | Trema –¥–∞—Ç—á–∏–∫ |
| - | EC (0x08) | Trema –¥–∞—Ç—á–∏–∫ |
| - | OLED (0x3C) | SSD1306 128x64 |
| **–ù–∞—Å–æ—Å—ã:** | | |
| 1 | pH UP | HIGH = –≤–∫–ª |
| 2 | pH DOWN | HIGH = –≤–∫–ª |
| 3 | EC A | HIGH = –≤–∫–ª |
| 4 | EC B | HIGH = –≤–∫–ª |
| 5 | EC C | HIGH = –≤–∫–ª |
| **–ò–Ω–¥–∏–∫–∞—Ü–∏—è:** | | |
| 15 | LED —Å—Ç–∞—Ç—É—Å | –ó–µ–ª–µ–Ω—ã–π/–∂–µ–ª—Ç—ã–π/–∫—Ä–∞—Å–Ω—ã–π |
| 16 | Buzzer | –ü–∏—â–∞–ª–∫–∞ 3.3V |
| 19 | –ö–Ω–æ–ø–∫–∞ MODE | Pull-up (LOW=–Ω–∞–∂–∞—Ç–∞) |

## üöÄ –°–±–æ—Ä–∫–∞ –∏ –ø—Ä–æ—à–∏–≤–∫–∞

```bash
cd node_ph_ec
idf.py set-target esp32s3
idf.py build
idf.py -p COM5 flash monitor
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥

```
I PH_EC: ========================================
I PH_EC: === NODE pH/EC Starting ===
I PH_EC: ========================================
I PH_EC: [Step 1/11] Initializing NVS...
I PH_EC: [Step 2/11] Loading configuration...
I PH_EC: Loaded: ph_ec_001 (Zone 1)
I PH_EC: Targets: pH=6.80, EC=2.00
I PH_EC: [Step 3/11] Initializing LED/Buzzer/Button...
I buzzer_led: Buzzer/LED/Button initialized
I PH_EC: [Step 4/11] Initializing OLED Display...
I oled_display: OLED Display initialized
I PH_EC: [Step 5/11] Initializing Sensors...
I sensor_manager: Sensor Manager initialized (STUB)
I PH_EC: [Step 6/11] Initializing Pumps...
I pump_manager: Pump Manager initialized (STUB)
I PH_EC: [Step 7/11] Initializing Adaptive PID...
I adaptive_pid: Adaptive PID initialized (STUB)
I PH_EC: [Step 8/11] Initializing Local Storage...
I local_storage: Local Storage initialized (buffer size: 1000)
I PH_EC: [Step 9/11] Initializing Connection Monitor...
I conn_monitor: Connection Monitor initialized
I PH_EC: [Step 10/11] Initializing Mesh (NODE mode)...
I mesh_manager: NODE mode
I mesh_manager: Mesh started
I mesh_manager: Parent connected
I PH_EC: [Step 11/11] Starting Node Controller...
I node_controller: Node Controller initialized
I node_controller: Node ID: ph_ec_001, Zone: Zone 1
I node_controller: Main task running (cycle: 10 seconds)
I PH_EC: ========================================
I PH_EC: === NODE pH/EC Running ===
I PH_EC: Node ID: ph_ec_001
I PH_EC: Autonomous: ENABLED
I PH_EC: ========================================
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º

1. –ü—Ä–æ—à–µ–π —É–∑–µ–ª (ROOT –Ω–µ –Ω—É–∂–µ–Ω)
2. –ü–æ–¥–æ–∂–¥–∏ 30 —Å–µ–∫—É–Ω–¥

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚ö° LED –∂–µ–ª—Ç—ã–π –º–∏–≥–∞—é—â–∏–π
- üîä 2 —Å–∏–≥–Ω–∞–ª–∞ buzzer
- üì∫ OLED: "AUTONOMOUS"
- ‚úÖ PID –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
- ‚úÖ –î–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è –≤ local_storage

### –¢–µ—Å—Ç 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ROOT

1. –ü—Ä–æ—à–µ–π –∏ –∑–∞–ø—É—Å—Ç–∏ ROOT —É–∑–µ–ª
2. –ü—Ä–æ—à–µ–π NODE pH/EC

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
I mesh_manager: Parent connected
I conn_monitor: State changed: AUTONOMOUS ‚Üí ONLINE
I node_controller: Exiting autonomous mode
I PH_EC: ‚óè LED –∑–µ–ª–µ–Ω—ã–π
I PH_EC: Telemetry sent to ROOT
```

### –¢–µ—Å—Ç 3: –ö–Ω–æ–ø–∫–∞ MODE

- –ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∂–∞—Ç–∏–µ (<1 —Å–µ–∫) - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ AUTO/MANUAL
- –°—Ä–µ–¥–Ω–µ–µ (1-3 —Å–µ–∫) - —Å–±—Ä–æ—Å Buzzer
- –î–æ–ª–≥–æ–µ (3-10 —Å–µ–∫) - —Å–±—Ä–æ—Å Emergency
- –û—á–µ–Ω—å –¥–æ–ª–≥–æ–µ (>10 —Å–µ–∫) - Factory Reset

## ‚úÖ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| node_controller | ‚úÖ –ì–û–¢–û–í | –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –∞–≤—Ç–æ–Ω–æ–º–∏–µ–π |
| connection_monitor | ‚úÖ –ì–û–¢–û–í | 4 —Å–æ—Å—Ç–æ—è–Ω–∏—è (ONLINE/DEGRADED/AUTONOMOUS/EMERGENCY) |
| local_storage | ‚úÖ –ì–û–¢–û–í | Ring buffer 1000 –∑–∞–ø–∏—Å–µ–π |
| oled_display | ‚úÖ –ì–û–¢–û–í | SSD1306 (–∑–∞–≥–ª—É—à–∫–∞, –Ω—É–∂–µ–Ω –¥—Ä–∞–π–≤–µ—Ä) |
| buzzer_led | ‚úÖ –ì–û–¢–û–í | LED + Buzzer + Button |
| sensor_manager | üîÑ –ó–ê–ì–õ–£–®–ö–ê | TODO: –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0 |
| pump_manager | üîÑ –ó–ê–ì–õ–£–®–ö–ê | TODO: –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0 |
| adaptive_pid | üîÑ –ó–ê–ì–õ–£–®–ö–ê | TODO: –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0 |
| app_main.c | ‚úÖ –ì–û–¢–û–í | 11-—à–∞–≥–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è |
| CMakeLists.txt | ‚úÖ –ì–û–¢–û–í | –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ |
| sdkconfig | ‚úÖ –ì–û–¢–û–í | ESP32-S3, watchdog, OTA |

**–ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: 100%** ‚úÖ

**–ü–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: 0%** üîÑ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ hydro1.0)

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `AI_INSTRUCTIONS.md` - –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (490+ —Å—Ç—Ä–æ–∫)
- `components/*/` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- `../common/AI_INSTRUCTIONS.md` - –æ–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `../doc/MESH_HYDRO_V2_FINAL_PLAN.md` - –æ–±—â–∏–π –ø–ª–∞–Ω

## üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –î–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ:

1. **–ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0:**
   - `sensor_manager` (—á—Ç–µ–Ω–∏–µ Trema pH/EC –¥–∞—Ç—á–∏–∫–æ–≤)
   - `pump_manager` (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 5 –Ω–∞—Å–æ—Å–∞–º–∏ —Å safety)
   - `adaptive_pid` (AI PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä)

2. **–î–æ–±–∞–≤–∏—Ç—å SSD1306 –¥—Ä–∞–π–≤–µ—Ä:**
   - –ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ ESP-IDF component registry
   - –ò–ª–∏ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ hydro1.0

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –° —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞—Ç—á–∏–∫–∞–º–∏
   - –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º (24 —á–∞—Å–∞)
   - Emergency —Å–∏—Ç—É–∞—Ü–∏–∏
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ü—Ä–æ–µ–∫—Ç –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –¥–∞—Ç—á–∏–∫–∏ –∏ –Ω–∞—Å–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∑–∞–≥–ª—É—à–∫–∏. PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

**–î–ª—è production:** –ù—É–∂–Ω–æ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∏–∑ hydro1.0.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 4-5 –¥–Ω–µ–π (—Å –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
