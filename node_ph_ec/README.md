# NODE pH/EC - Critical Control Node

**ESP32-S3 #3** - –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —É–∑–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è pH –∏ —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å—é (EC)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ö—Ä–∏—Ç–∏—á–Ω—ã–π —É–∑–µ–ª —Å–∏—Å—Ç–µ–º—ã Mesh Hydro –¥–ª—è:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ pH –∏ EC –≤ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–º —Ä–∞—Å—Ç–≤–æ—Ä–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ 5 –ø–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Å–æ—Å–æ–≤
- PID —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ê–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏ —Å ROOT
- Emergency protection –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö

---

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| **pH Sensor** | Trema pH (I2C 0x4D) |
| **EC Sensor** | Trema EC (I2C 0x64) |
| **5x Pumps** | –ü–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å–æ—Å—ã (PWM) |
| **PID** | –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –¥–ª—è pH UP/DOWN –∏ EC |
| **Manager** | –ì–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å—é |

---

## üîå –†–∞—Å–ø–∏–Ω–æ–≤–∫–∞ ESP32-S3 #3

| GPIO | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|------------|------------|
| **I2C —à–∏–Ω–∞:** | | |
| 17 | I2C SCL | Clock (100 kHz) |
| 18 | I2C SDA | Data |
| **PWM –Ω–∞—Å–æ—Å—ã:** | | |
| 4 | Pump pH UP | PWM 1000 Hz |
| 5 | Pump pH DOWN | PWM 1000 Hz |
| 6 | Pump EC A | PWM 1000 Hz |
| 7 | Pump EC B | PWM 1000 Hz |
| 15 | Pump EC C | PWM 1000 Hz |

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
node_ph_ec/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ph_sensor/         # –î—Ä–∞–π–≤–µ—Ä pH –¥–∞—Ç—á–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ ec_sensor/         # –î—Ä–∞–π–≤–µ—Ä EC –¥–∞—Ç—á–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ pump_controller/   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 5 –Ω–∞—Å–æ—Å–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ pid_controller/    # PID –∞–ª–≥–æ—Ä–∏—Ç–º
‚îÇ   ‚îî‚îÄ‚îÄ ph_ec_manager/     # –ì–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îú‚îÄ‚îÄ app_main.c         # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ CMakeLists.txt
‚îú‚îÄ‚îÄ CMakeLists.txt         # –ì–ª–∞–≤–Ω—ã–π CMakeLists
‚îú‚îÄ‚îÄ sdkconfig.defaults     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ partitions.csv         # –†–∞–∑–¥–µ–ª—ã flash
‚îî‚îÄ‚îÄ README.md              # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. WiFi –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π `sdkconfig.defaults`:
```
CONFIG_ESP_WIFI_SSID="YourWiFi"
CONFIG_ESP_WIFI_PASSWORD="YourPassword"
```

### 2. –°–±–æ—Ä–∫–∞

```bash
cd node_ph_ec
idf.py set-target esp32s3
idf.py build
```

### 3. –ü—Ä–æ—à–∏–≤–∫–∞

```bash
idf.py -p COM6 flash monitor
```

**‚ö†Ô∏è –ó–∞–º–µ–Ω–∏ COM6 –Ω–∞ —Å–≤–æ–π –ø–æ—Ä—Ç!**

---

## üìä –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```c
pH target: 6.5 (–¥–∏–∞–ø–∞–∑–æ–Ω 5.5-7.5)
EC target: 2.5 (–¥–∏–∞–ø–∞–∑–æ–Ω 1.5-4.0)

PID –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:
  pH UP:   Kp=2.0, Ki=0.1, Kd=0.5
  pH DOWN: Kp=2.0, Ki=0.1, Kd=0.5
  EC A/B/C: Kp=1.5, Ki=0.05, Kd=0.3
```

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ NVS –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ Dashboard.

---

## üîê –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞

NODE pH/EC **–í–°–ï–ì–î–ê** —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏:
- ROOT offline
- MQTT offline
- WiFi offline

**–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ NVS**

### ‚úÖ Emergency Protection

–ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö (pH < 5.5 –∏–ª–∏ pH > 7.5):
- –í—Å–µ –Ω–∞—Å–æ—Å—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è (emergency stop)
- Emergency flag = true –≤ telemetry
- SOS —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ ROOT (–µ—Å–ª–∏ online)

### ‚úÖ Graceful Degradation

–ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã:
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (pH=7.0, EC=2.0)
- –£–∑–µ–ª **–ù–ï –ø–∞–¥–∞–µ—Ç**, –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –õ–æ–≥–∏: `WARNING: Sensor not found - using default values`

---

## üì° Mesh –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è

### Discovery (–ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ):
```json
{
  "type": "discovery",
  "node_id": "ph_ec_xxx",
  "node_type": "ph_ec",
  "actuators": ["pump_ph_up", "pump_ph_down", ...],
  "heap_free": 234567,
  "wifi_rssi": -45
}
```

### Telemetry (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫):
```json
{
  "type": "telemetry",
  "data": {
    "ph": 6.8,
    "ec": 2.3,
    "pump_ph_up_ml": 150.5,
    "rssi_to_parent": -45
  }
}
```

### Heartbeat (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫):
```json
{
  "type": "heartbeat",
  "uptime": 3600,
  "heap_free": 234567,
  "autonomous": false
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞

```bash
idf.py monitor
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- –£–∑–µ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ mesh
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç discovery
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ Dashboard

### –¢–µ—Å—Ç 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ pH

**–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∏–∑–∫–∏–π pH –≤ –∫–æ–¥–µ (–≤—Ä–µ–º–µ–Ω–Ω–æ):**
```c
s_current_ph = 6.0f; // –ù–∏–∂–µ target 6.5
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
I ph_ec_mgr: pH UP: 0.50 ml (current=6.00, target=6.50)
I pump_ctrl: Pump 0 START (250 ms)
I pump_ctrl: Pump 0 STOP (0.50 ml, 250 ms)
```

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö

–°–º. **DATA_CHAIN_VERIFICATION_GUIDE.md**

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `AI_INSTRUCTIONS.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI
- `DATA_CHAIN_VERIFICATION_GUIDE.md` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- `NODE_PH_EC_IMPLEMENTATION_COMPLETE.md` - –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- `doc/MESH_PINOUT_ALL_NODES.md` - –ø–æ–ª–Ω–∞—è —Ä–∞—Å–ø–∏–Ω–æ–≤–∫–∞

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Router credentials** –≤ `sdkconfig.defaults` –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å ROOT node
2. **Mesh ID –∏ –ø–∞—Ä–æ–ª—å** –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å–æ –≤—Å–µ–º–∏ —É–∑–ª–∞–º–∏
3. **I2C –∞–¥—Ä–µ—Å–∞** –¥–∞—Ç—á–∏–∫–æ–≤:
   - pH: 0x4D (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è - –ø—Ä–æ–≤–µ—Ä—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é)
   - EC: 0x64 (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è - –ø—Ä–æ–≤–µ—Ä—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é)
4. **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–æ–≤** (–º–ª/—Å–µ–∫) –Ω—É–∂–Ω–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –¥–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
5. **Emergency –ø–æ—Ä–æ–≥–∏** –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ NVS

---

**NODE pH/EC - –∫—Ä–∏—Ç–∏—á–Ω—ã–π —É–∑–µ–ª. –ê–≤—Ç–æ–Ω–æ–º–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ!** üõ°Ô∏è
