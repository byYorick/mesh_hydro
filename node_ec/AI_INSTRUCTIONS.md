# AI INSTRUCTIONS - NODE EC

## üéØ –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –Ω–æ–¥—ã

NODE EC - —ç—Ç–æ **–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —É–∑–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è EC (—ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å—é)** –≤ —Å–∏—Å—Ç–µ–º–µ Mesh Hydro.

**–ó–∞–¥–∞—á–∏:**
1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ EC –¥–∞—Ç—á–∏–∫–∞ Trema (I2C 0x64)
2. PID —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3 –Ω–∞—Å–æ—Å–∞–º–∏ (EC A, EC B, EC C)
3. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ mesh —Å–µ—Ç—å (ROOT node)
4. –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏
5. Emergency protection –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **ec_sensor** - –¥—Ä–∞–π–≤–µ—Ä Trema EC (I2C 0x64)
2. **pump_controller** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3 –Ω–∞—Å–æ—Å–∞–º–∏ (GPIO 2, 3, 4)
3. **pid_controller** - PID –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ EC
4. **ec_manager** - –≥–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —É–∑–ª–∞
5. **oled_display** - OLED SSD1306 –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
6. **connection_monitor** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–≤—è–∑–∏ —Å ROOT
7. **local_storage** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ offline
8. **buzzer_led** - –∑–≤—É–∫–æ–≤–∞—è –∏ —Å–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è

### Common –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∏–∑ ../common/):
- mesh_manager - ESP-MESH API
- mesh_protocol - –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–æ–±—â–µ–Ω–∏–π
- node_config - NVS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- mesh_config - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

---

## üîå –ê–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### ESP32-C3:
- **I2C**: GPIO8 (SDA), GPIO9 (SCL)
- **–ù–∞—Å–æ—Å—ã**: GPIO2 (EC A), GPIO3 (EC B), GPIO4 (EC C)
- **LED**: GPIO5
- **Buzzer**: GPIO6

### I2C —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:
- **EC Sensor**: 0x64 (Trema EC)
- **OLED**: 0x3C (SSD1306 128x64)

---

## üìä PID —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –õ–æ–≥–∏–∫–∞:
- **–¶–µ–ª—å**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å EC = target (–¥–µ—Ñ–æ–ª—Ç 2.5 mS/cm)
- **–ï—Å–ª–∏ EC < target**: –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å—ã A, B, C (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–≤:
```c
// PID –≤—ã—Ö–æ–¥ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ 3 –Ω–∞—Å–æ—Å–∞:
// A = 50% –æ—Ç –Ω—É–∂–Ω–æ–≥–æ –æ–±—ä–µ–º–∞
// B = 40% –æ—Ç –Ω—É–∂–Ω–æ–≥–æ –æ–±—ä–µ–º–∞
// C = 10% –æ—Ç –Ω—É–∂–Ω–æ–≥–æ –æ–±—ä–µ–º–∞ (–º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã)
```

### PID –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–µ):
```c
Kp = 0.8  // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)
Ki = 0.02 // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)
Kd = 0.2  // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)
```

### Safety:
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞: 60 —Å–µ–∫
- Cooldown –º–µ–∂–¥—É –≤–∫–ª—é—á–µ–Ω–∏—è–º–∏: 30 —Å–µ–∫
- Emergency stop –ø—Ä–∏ EC > 4.0

---

## üì° Mesh –ø—Ä–æ—Ç–æ–∫–æ–ª

### 1. Discovery (–ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ):
```json
{
  "type": "discovery",
  "node_id": "ec_XXXXXX",
  "node_type": "ec",
  "actuators": ["pump_ec_a", "pump_ec_b", "pump_ec_c"],
  "sensors": ["ec"],
  "heap_free": 234567,
  "wifi_rssi": -45
}
```

### 2. Telemetry (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫):
```json
{
  "type": "telemetry",
  "node_id": "ec_XXXXXX",
  "data": {
    "ec": 2.3,
    "ec_target": 2.5,
    "pump_ec_a_ml": 250.5,
    "pump_ec_b_ml": 245.2,
    "pump_ec_c_ml": 50.1,
    "pump_ec_a_total_ml": 15234.5,
    "pump_ec_b_total_ml": 12421.1,
    "pump_ec_c_total_ml": 2134.3
  }
}
```

### 3. Heartbeat (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫):
```json
{
  "type": "heartbeat",
  "node_id": "ec_XXXXXX",
  "uptime": 3600,
  "heap_free": 234567,
  "autonomous": false
}
```

### 4. –ö–æ–º–∞–Ω–¥—ã –æ—Ç ROOT:
```json
{
  "type": "command",
  "node_id": "ec_XXXXXX",
  "command": "set_ec_target",
  "params": {"target": 2.0}
}
```

---

## üîê –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞
NODE EC **–í–°–ï–ì–î–ê** —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ ROOT offline.
–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ NVS.

### ‚úÖ Emergency Protection
–ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö (EC > 4.0):
- –í—Å–µ –Ω–∞—Å–æ—Å—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
- Emergency flag = true
- SOS —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ ROOT (–µ—Å–ª–∏ online)

### ‚úÖ Graceful Degradation
–ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ EC=2.0
- –£–∑–µ–ª **–ù–ï –ø–∞–¥–∞–µ—Ç**
- –õ–æ–≥–∏: WARNING

---

## üõ†Ô∏è –ü—Ä–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥–∞

1. **–ù–ï —É–¥–∞–ª—è–π** –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º
2. **–ù–ï —É–¥–∞–ª—è–π** emergency protection
3. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π** –≤–æ–∑–≤—Ä–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π (esp_err_t)
4. **–õ–æ–≥–∏—Ä—É–π** –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (ESP_LOGI)
5. **–ò—Å–ø–æ–ª—å–∑—É–π** NVS –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Mock —Ä–µ–∂–∏–º:
–í `ec_sensor.c` –µ—Å—Ç—å —Ä–µ–∂–∏–º –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞:
```c
// –ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
*ec = 2.0f;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏:
1. NODE –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç discovery ‚Üí ROOT ‚Üí MQTT ‚Üí Backend ‚Üí Frontend
2. Telemetry: NODE ‚Üí ROOT ‚Üí MQTT ‚Üí Backend ‚Üí WebSocket ‚Üí Frontend
3. Command: Frontend ‚Üí Backend ‚Üí MQTT ‚Üí ROOT ‚Üí NODE

---

**NODE EC - –∫—Ä–∏—Ç–∏—á–Ω—ã–π —É–∑–µ–ª. –ê–≤—Ç–æ–Ω–æ–º–∏—è –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ!** üõ°Ô∏è

