# ü§ñ –ü–û–õ–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ò–ò: NODE Relay

**–£–∑–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–º–∞—Ç–æ–º (–∞–∫—Ç—É–∞—Ç–æ—Ä—ã, –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è, –æ—Å–≤–µ—â–µ–Ω–∏–µ)**

---

## üéØ –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –£–ó–õ–ê

**NODE Relay (ESP32)** - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É–∑–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–º–∞—Ç–æ–º –≤ —Ç–µ–ø–ª–∏—Ü–µ.

### ‚öôÔ∏è –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä—Ç–æ—á–∫–∞–º–∏** - 2 –ª–∏–Ω–µ–π–Ω—ã—Ö –∞–∫—Ç—É–∞—Ç–æ—Ä–∞ (–æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å)
2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–µ–π** - –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä ON/OFF –∏–ª–∏ PWM —Å–∫–æ—Ä–æ—Å—Ç—å
3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ–º** - LED —Å–≤–µ—Ç —Å PWM –¥–∏–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º (0-100%)
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥** - –æ—Ç ROOT/Server (–ù–ï –∞–≤—Ç–æ–Ω–æ–º–Ω–æ!)
5. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–ª–µ

### ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê:

1. ‚ùå **–ù–ï–¢ –î–ê–¢–ß–ò–ö–û–í!** - Relay –ù–ï —á–∏—Ç–∞–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É/–≤–ª–∞–∂–Ω–æ—Å—Ç—å/CO2
2. ‚ùå **–ù–ï–¢ –õ–û–ì–ò–ö–ò!** - Relay –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–π (–∫—Ä–æ–º–µ safety)
3. ‚ùå **–ù–ï–¢ –ê–í–¢–û–ù–û–ú–ò–ò!** - Relay —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –æ—Ç ROOT
4. ‚úÖ **–¢–û–õ–¨–ö–û –ò–°–ü–û–õ–ù–ï–ù–ò–ï** - –ø–æ–ª—É—á–∏–ª –∫–æ–º–∞–Ω–¥—É ‚Üí –≤—ã–ø–æ–ª–Ω–∏–ª ‚Üí –æ—Ç–ø—Ä–∞–≤–∏–ª —Å—Ç–∞—Ç—É—Å
5. ‚úÖ **SAFETY CHECKS** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã –∞–∫—Ç—É–∞—Ç–æ—Ä–æ–≤
6. ‚úÖ **–°–¢–ê–¢–£–° –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

## üì¶ –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ò

### –õ–∏–Ω–µ–π–Ω—ã–µ –∞–∫—Ç—É–∞—Ç–æ—Ä—ã —Ñ–æ—Ä—Ç–æ—á–µ–∫:
| –ê–∫—Ç—É–∞—Ç–æ—Ä | GPIO | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –í—Ä–µ–º—è —Ö–æ–¥–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|------|------------|------------|------------|
| **Window 1** | 1 | Relay (–æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å) | ~30 —Å–µ–∫ | –í–µ—Ä—Ö–Ω—è—è —Ñ–æ—Ä—Ç–æ—á–∫–∞ |
| **Window 2** | 2 | Relay (–æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å) | ~30 —Å–µ–∫ | –ë–æ–∫–æ–≤–∞—è —Ñ–æ—Ä—Ç–æ—á–∫–∞ |

**‚ö†Ô∏è –í–ê–ñ–ù–û:** 
- –ê–∫—Ç—É–∞—Ç–æ—Ä—ã –∏–º–µ—é—Ç –∫–æ–Ω—Ü–µ–≤–∏–∫–∏ (limit switches)
- –ú–∞–∫—Å –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 45 —Å–µ–∫ (–∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è)
- Cooldown –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏: 5 —Å–µ–∫

### –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä:
| –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä | GPIO | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –ú–æ—â–Ω–æ—Å—Ç—å |
|------------|------|------------|----------|
| **Fan** | 3 | ON/OFF –∏–ª–∏ PWM | 0-100% |

### LED –æ—Å–≤–µ—â–µ–Ω–∏–µ:
| –û—Å–≤–µ—â–µ–Ω–∏–µ | GPIO | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –î–∏–∞–ø–∞–∑–æ–Ω |
|-----------|------|------------|----------|
| **LED Grow Light** | 7 | PWM 1000 Hz | 0-100% |

---

## üîå –†–ê–°–ü–ò–ù–û–í–ö–ê ESP32

| GPIO | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –¢–∏–ø | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|------------|-----|------------|
| **–ê–∫—Ç—É–∞—Ç–æ—Ä—ã —Ñ–æ—Ä—Ç–æ—á–µ–∫:** | | | |
| 1 | Window 1 Open | Relay | HIGH=–æ—Ç–∫—Ä—ã—Ç—å |
| 2 | Window 2 Open | Relay | HIGH=–æ—Ç–∫—Ä—ã—Ç—å |
| **–í–µ–Ω—Ç–∏–ª—è—Ü–∏—è –∏ —Å–≤–µ—Ç:** | | | |
| 3 | Fan | Relay/PWM | ON/OFF –∏–ª–∏ PWM —Å–∫–æ—Ä–æ—Å—Ç—å |
| 7 | LED Light | PWM | 0-100% —è—Ä–∫–æ—Å—Ç—å |
| **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è:** | | | |
| 15 | Status LED | GPIO | –ó–µ–ª–µ–Ω—ã–π=OK, –ö—Ä–∞—Å–Ω—ã–π=Error |

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
NODE Relay (ESP32)
‚îÇ
‚îú‚îÄ‚îÄ Actuator Manager
‚îÇ   ‚îú‚îÄ‚îÄ Window 1 controller (linear actuator)
‚îÇ   ‚îú‚îÄ‚îÄ Window 2 controller (linear actuator)
‚îÇ   ‚îú‚îÄ‚îÄ Limit switch monitoring
‚îÇ   ‚îú‚îÄ‚îÄ Timeout protection (45 sec max)
‚îÇ   ‚îî‚îÄ‚îÄ Cooldown logic (5 sec)
‚îÇ
‚îú‚îÄ‚îÄ Fan Controller
‚îÇ   ‚îú‚îÄ‚îÄ ON/OFF control
‚îÇ   ‚îú‚îÄ‚îÄ PWM speed control (optional)
‚îÇ   ‚îî‚îÄ‚îÄ State tracking
‚îÇ
‚îú‚îÄ‚îÄ LED Controller
‚îÇ   ‚îú‚îÄ‚îÄ PWM dimming (0-100%)
‚îÇ   ‚îú‚îÄ‚îÄ Smooth transitions
‚îÇ   ‚îî‚îÄ‚îÄ Daily schedule (optional)
‚îÇ
‚îú‚îÄ‚îÄ Command Handler
‚îÇ   ‚îú‚îÄ‚îÄ –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ –æ—Ç ROOT
‚îÇ   ‚îú‚îÄ‚îÄ Validation parameters
‚îÇ   ‚îú‚îÄ‚îÄ Execution
‚îÇ   ‚îî‚îÄ‚îÄ Status response
‚îÇ
‚îú‚îÄ‚îÄ Mesh Client (NODE mode)
‚îÇ   ‚îú‚îÄ‚îÄ Receive commands ‚Üê ROOT
‚îÇ   ‚îú‚îÄ‚îÄ Send status ‚Üí ROOT
‚îÇ   ‚îú‚îÄ‚îÄ Heartbeat every 10 sec
‚îÇ   ‚îî‚îÄ‚îÄ Emergency events
‚îÇ
‚îî‚îÄ‚îÄ Safety Monitor
    ‚îú‚îÄ‚îÄ Overcurrent protection
    ‚îú‚îÄ‚îÄ Timeout checks
    ‚îî‚îÄ‚îÄ Emergency stop
```

---

## üì® –¢–ò–ü–´ –°–û–û–ë–©–ï–ù–ò–ô

### 1. üì• COMMAND (Server ‚Üí MQTT ‚Üí ROOT ‚Üí NODE)

**–¢–æ–ø–∏–∫:** `hydro/command/relay_001`

#### a) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä—Ç–æ—á–∫–æ–π:
```json
{
  "type": "command",
  "node_id": "relay_001",
  "command": "set_window",
  "params": {
    "window": 1,        // 1 –∏–ª–∏ 2
    "action": "open"    // "open" –∏–ª–∏ "close"
  }
}
```

#### b) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º:
```json
{
  "type": "command",
  "node_id": "relay_001",
  "command": "set_fan",
  "params": {
    "state": "on",      // "on" –∏–ª–∏ "off"
    "speed": 100        // 0-100% (–µ—Å–ª–∏ PWM)
  }
}
```

#### c) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ LED –æ—Å–≤–µ—â–µ–Ω–∏–µ–º:
```json
{
  "type": "command",
  "node_id": "relay_001",
  "command": "set_light",
  "params": {
    "brightness": 75    // 0-100%
  }
}
```

#### d) Emergency stop:
```json
{
  "type": "command",
  "node_id": "relay_001",
  "command": "emergency_stop",
  "params": {}
}
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥:**
```c
void relay_controller_handle_command(const char *command, cJSON *params) {
    ESP_LOGI(TAG, "Command received: %s", command);
    
    if (strcmp(command, "set_window") == 0) {
        cJSON *window_num = cJSON_GetObjectItem(params, "window");
        cJSON *action = cJSON_GetObjectItem(params, "action");
        
        if (window_num && action && cJSON_IsString(action)) {
            int window = window_num->valueint;
            const char *action_str = action->valuestring;
            
            if (strcmp(action_str, "open") == 0) {
                actuator_manager_open_window(window);
            } else if (strcmp(action_str, "close") == 0) {
                actuator_manager_close_window(window);
            }
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            send_status();
        }
    }
    else if (strcmp(command, "set_fan") == 0) {
        cJSON *state = cJSON_GetObjectItem(params, "state");
        cJSON *speed = cJSON_GetObjectItem(params, "speed");
        
        if (state && cJSON_IsString(state)) {
            if (strcmp(state->valuestring, "on") == 0) {
                int fan_speed = speed ? speed->valueint : 100;
                fan_controller_set_speed(fan_speed);
            } else {
                fan_controller_turn_off();
            }
            
            send_status();
        }
    }
    else if (strcmp(command, "set_light") == 0) {
        cJSON *brightness = cJSON_GetObjectItem(params, "brightness");
        
        if (brightness && cJSON_IsNumber(brightness)) {
            int bright = brightness->valueint;
            led_controller_set_brightness(bright);
            
            send_status();
        }
    }
    else if (strcmp(command, "emergency_stop") == 0) {
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –í–°–ï–• –∞–∫—Ç—É–∞—Ç–æ—Ä–æ–≤
        actuator_manager_emergency_stop();
        fan_controller_turn_off();
        led_controller_set_brightness(0);
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ emergency event
        send_emergency_event("Emergency stop activated");
    }
}
```

---

### 2. üì§ STATUS (–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã)

**NODE ‚Üí ROOT ‚Üí MQTT ‚Üí Server**

```json
{
  "type": "telemetry",
  "node_id": "relay_001",
  "timestamp": 1729346400,
  "data": {
    "window_1": "open",      // "open"/"close"/"moving"
    "window_2": "closed",
    "fan": "on",
    "fan_speed": 100,
    "led_brightness": 75,
    "rssi_to_parent": -50
  }
}
```

**–ö–æ–¥:**
```c
static void send_status(void) {
    cJSON *data = cJSON_CreateObject();
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä—Ç–æ—á–µ–∫
    cJSON_AddStringToObject(data, "window_1", actuator_manager_get_state(1));
    cJSON_AddStringToObject(data, "window_2", actuator_manager_get_state(2));
    
    // –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä
    cJSON_AddStringToObject(data, "fan", fan_controller_is_on() ? "on" : "off");
    cJSON_AddNumberToObject(data, "fan_speed", fan_controller_get_speed());
    
    // LED —Å–≤–µ—Ç
    cJSON_AddNumberToObject(data, "led_brightness", led_controller_get_brightness());
    
    // RSSI
    cJSON_AddNumberToObject(data, "rssi_to_parent", mesh_manager_get_parent_rssi());
    
    char json_buf[512];
    mesh_protocol_create_telemetry(s_config->base.node_id, data, json_buf, sizeof(json_buf));
    mesh_manager_send_to_root((uint8_t *)json_buf, strlen(json_buf));
    
    cJSON_Delete(data);
}
```

---

### 3. üíì HEARTBEAT (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫)

```json
{
  "type": "heartbeat",
  "node_id": "relay_001",
  "uptime": 3600,
  "heap_free": 190000,
  "rssi_to_parent": -50
}
```

---

### 4. üîî EVENT (–∞–≤–∞—Ä–∏–∏)

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å:**
- –ê–∫—Ç—É–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç > 45 —Å–µ–∫ (timeout)
- –ö–æ–Ω—Ü–µ–≤–∏–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
- Overcurrent detected
- Emergency stop –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω

```json
{
  "type": "event",
  "node_id": "relay_001",
  "timestamp": 1729346400,
  "level": "critical",
  "message": "Window actuator timeout",
  "data": {
    "window": 1,
    "action": "open",
    "duration_sec": 50
  }
}
```

---

## üíª –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê

### app_main.c (—Å mesh callback):

```c
#include "mesh_manager.h"
#include "mesh_protocol.h"
#include "node_config.h"
#include "relay_controller.h"

static relay_node_config_t g_config;

// Callback –¥–ª—è –∫–æ–º–∞–Ω–¥ –æ—Ç ROOT
static void on_mesh_data_received(const uint8_t *src, const uint8_t *data, size_t len) {
    char *data_copy = malloc(len + 1);
    if (!data_copy) return;
    memcpy(data_copy, data, len);
    data_copy[len] = '\0';
    
    mesh_message_t msg;
    if (!mesh_protocol_parse(data_copy, &msg)) {
        free(data_copy);
        return;
    }
    
    if (strcmp(msg.node_id, g_config.base.node_id) != 0) {
        free(data_copy);
        mesh_protocol_free_message(&msg);
        return;
    }

    switch (msg.type) {
        case MESH_MSG_COMMAND: {
            cJSON *cmd = cJSON_GetObjectItem(msg.data, "command");
            if (cmd && cJSON_IsString(cmd)) {
                relay_controller_handle_command(cmd->valuestring, msg.data);
            }
            break;
        }

        case MESH_MSG_CONFIG:
            relay_controller_handle_config_update(msg.data);
            break;

        default:
            ESP_LOGW(TAG, "Unknown message type: %d", msg.type);
            break;
    }

    free(data_copy);
    mesh_protocol_free_message(&msg);
}

void app_main(void) {
    // === –®–∞–≥ 1: NVS ===
    nvs_flash_init();
    
    // === –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ===
    node_config_load(&g_config, sizeof(g_config), "relay_ns");
    
    // === –®–∞–≥ 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GPIO ===
    // –ê–∫—Ç—É–∞—Ç–æ—Ä—ã (Relay)
    gpio_config_t actuator_conf = {
        .pin_bit_mask = (1ULL << 1) | (1ULL << 2),
        .mode = GPIO_MODE_OUTPUT,
        .pull_up_en = GPIO_PULLUP_DISABLE,
        .pull_down_en = GPIO_PULLDOWN_DISABLE,
        .intr_type = GPIO_INTR_DISABLE
    };
    gpio_config(&actuator_conf);
    
    // –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä (Relay –∏–ª–∏ PWM)
    gpio_config_t fan_conf = {
        .pin_bit_mask = (1ULL << 3),
        .mode = GPIO_MODE_OUTPUT,
        .pull_up_en = GPIO_PULLUP_DISABLE,
        .pull_down_en = GPIO_PULLDOWN_DISABLE,
        .intr_type = GPIO_INTR_DISABLE
    };
    gpio_config(&fan_conf);
    
    // LED —Å–≤–µ—Ç (PWM)
    ledc_timer_config_t ledc_timer = {
        .speed_mode = LEDC_LOW_SPEED_MODE,
        .timer_num = LEDC_TIMER_0,
        .duty_resolution = LEDC_TIMER_8_BIT,
        .freq_hz = 1000,
        .clk_cfg = LEDC_AUTO_CLK
    };
    ledc_timer_config(&ledc_timer);
    
    ledc_channel_config_t ledc_channel = {
        .speed_mode = LEDC_LOW_SPEED_MODE,
        .channel = LEDC_CHANNEL_0,
        .timer_sel = LEDC_TIMER_0,
        .intr_type = LEDC_INTR_DISABLE,
        .gpio_num = 7,
        .duty = 0,
        .hpoint = 0
    };
    ledc_channel_config(&ledc_channel);
    
    // === –®–∞–≥ 4: Mesh (NODE —Ä–µ–∂–∏–º) ===
    mesh_manager_config_t mesh_config = {
        .mode = MESH_MODE_NODE,
        .mesh_id = MESH_NETWORK_ID,
        .mesh_password = MESH_NETWORK_PASSWORD,
        .channel = MESH_NETWORK_CHANNEL,
        .max_connection = 6,
        .router_ssid = MESH_ROUTER_SSID,
        .router_password = MESH_ROUTER_PASSWORD,
        .router_bssid = NULL
    };
    mesh_manager_init(&mesh_config);
    mesh_manager_register_recv_cb(on_mesh_data_received);  // ‚Üê Callback!
    mesh_manager_start();
    
    // === –®–∞–≥ 5: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ ===
    relay_controller_init(&g_config);
    relay_controller_start();
}
```

---

## ‚öôÔ∏è –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ö–¢–£–ê–¢–û–†–ê–ú–ò

### –õ–æ–≥–∏–∫–∞ –∞–∫—Ç—É–∞—Ç–æ—Ä–æ–≤ —Ñ–æ—Ä—Ç–æ—á–µ–∫:

```c
typedef enum {
    WINDOW_CLOSED = 0,
    WINDOW_OPENING,
    WINDOW_OPEN,
    WINDOW_CLOSING,
    WINDOW_ERROR
} window_state_t;

esp_err_t actuator_open_window(int window_num) {
    if (window_num < 1 || window_num > 2) {
        return ESP_ERR_INVALID_ARG;
    }
    
    int gpio = (window_num == 1) ? 1 : 2;
    window_state_t *state = &s_window_states[window_num - 1];
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if (*state == WINDOW_OPEN) {
        ESP_LOGI(TAG, "Window %d already open", window_num);
        return ESP_OK;
    }
    
    if (*state == WINDOW_OPENING || *state == WINDOW_CLOSING) {
        ESP_LOGW(TAG, "Window %d is moving", window_num);
        return ESP_ERR_INVALID_STATE;
    }
    
    // –ó–∞–ø—É—Å–∫ –∞–∫—Ç—É–∞—Ç–æ—Ä–∞
    *state = WINDOW_OPENING;
    gpio_set_level(gpio, 1);
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ timeout (45 —Å–µ–∫)
    xTaskCreate(window_timeout_task, "win_timeout", 2048, (void *)(intptr_t)window_num, 5, NULL);
    
    ESP_LOGI(TAG, "Window %d opening...", window_num);
    return ESP_OK;
}

// Timeout task:
static void window_timeout_task(void *arg) {
    int window_num = (int)(intptr_t)arg;
    
    // –ñ–¥–µ–º 45 —Å–µ–∫
    vTaskDelay(pdMS_TO_TICKS(45000));
    
    // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è - timeout!
    window_state_t state = s_window_states[window_num - 1];
    if (state == WINDOW_OPENING || state == WINDOW_CLOSING) {
        ESP_LOGE(TAG, "Window %d TIMEOUT!", window_num);
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞
        int gpio = (window_num == 1) ? 1 : 2;
        gpio_set_level(gpio, 0);
        s_window_states[window_num - 1] = WINDOW_ERROR;
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ emergency event
        send_emergency_event("Window actuator timeout");
    }
    
    vTaskDelete(NULL);
}

// Callback –æ—Ç –∫–æ–Ω—Ü–µ–≤–∏–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å):
void IRAM_ATTR window_limit_switch_isr(void *arg) {
    int window_num = (int)(intptr_t)arg;
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç—É–∞—Ç–æ—Ä–∞
    int gpio = (window_num == 1) ? 1 : 2;
    gpio_set_level(gpio, 0);
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if (s_window_states[window_num - 1] == WINDOW_OPENING) {
        s_window_states[window_num - 1] = WINDOW_OPEN;
    } else if (s_window_states[window_num - 1] == WINDOW_CLOSING) {
        s_window_states[window_num - 1] = WINDOW_CLOSED;
    }
    
    ESP_LOGI(TAG, "Window %d limit switch triggered", window_num);
}
```

---

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º:

```c
esp_err_t fan_controller_set_speed(uint8_t speed_percent) {
    if (speed_percent > 100) {
        speed_percent = 100;
    }
    
    if (speed_percent == 0) {
        // –í—ã–∫–ª—é—á–∏—Ç—å
        gpio_set_level(FAN_GPIO, 0);
        s_fan_state = false;
        s_fan_speed = 0;
    } else if (speed_percent == 100) {
        // –ü–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å (ON/OFF)
        gpio_set_level(FAN_GPIO, 1);
        s_fan_state = true;
        s_fan_speed = 100;
    } else {
        // PWM (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        uint32_t duty = (speed_percent * 255) / 100;
        ledc_set_duty(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_1, duty);
        ledc_update_duty(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_1);
        s_fan_state = true;
        s_fan_speed = speed_percent;
    }
    
    ESP_LOGI(TAG, "Fan: %s (speed=%d%%)", s_fan_state ? "ON" : "OFF", s_fan_speed);
    return ESP_OK;
}
```

---

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ LED —Å–≤–µ—Ç–æ–º:

```c
esp_err_t led_controller_set_brightness(uint8_t brightness_percent) {
    if (brightness_percent > 100) {
        brightness_percent = 100;
    }
    
    // PWM duty cycle (0-255)
    uint32_t duty = (brightness_percent * 255) / 100;
    
    ledc_set_duty(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_0, duty);
    ledc_update_duty(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_0);
    
    s_led_brightness = brightness_percent;
    
    ESP_LOGI(TAG, "LED brightness: %d%%", brightness_percent);
    return ESP_OK;
}
```

---

## üåê MESH INTEGRATION

### –ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ (–¥–ª—è heartbeat –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞):

```c
static void relay_main_task(void *arg) {
    ESP_LOGI(TAG, "Main task running (heartbeat every 10 sec)");
    
    while (1) {
        // 1. –û—Ç–ø—Ä–∞–≤–∫–∞ heartbeat
        if (mesh_manager_is_connected()) {
            send_heartbeat();
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ timeout –∞–∫—Ç—É–∞—Ç–æ—Ä–æ–≤ (–µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ü–µ–≤–∏–∫–æ–≤)
        check_actuator_timeouts();
        
        // 3. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫)
        static int counter = 0;
        if (counter % 6 == 0) {  // –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫
            send_status();
        }
        counter++;
        
        vTaskDelay(pdMS_TO_TICKS(10000));  // 10 —Å–µ–∫
    }
}
```

---

## ‚ùå –ß–¢–û –ù–ï –î–ï–õ–ê–¢–¨

### 1. ‚ùå –ù–ï –ø—Ä–∏–Ω–∏–º–∞–π —Ä–µ—à–µ–Ω–∏–π —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ

```c
// –ü–õ–û–•–û ‚ùå
void check_temperature(float temp) {
    if (temp > 28.0f) {
        fan_controller_turn_on();  // ‚ùå Relay –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–π!
    }
}

// –•–û–†–û–®–û ‚úÖ
// Relay –¢–û–õ–¨–ö–û –∏—Å–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç ROOT
// ROOT –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç climate NODE –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ
```

### 2. ‚ùå –ù–ï —Ä–∞–±–æ—Ç–∞–π –±–µ–∑ –∫–æ–º–∞–Ω–¥ –æ—Ç ROOT

```c
// –ü–õ–û–•–û ‚ùå
void app_main(void) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
    if (hour >= 6 && hour <= 20) {
        led_controller_set_brightness(100);  // ‚ùå –ù–µ—Ç –∞–≤—Ç–æ–Ω–æ–º–∏–∏!
    }
}

// –•–û–†–û–®–û ‚úÖ
// –ñ–¥—ë–º –∫–æ–º–∞–Ω–¥—É –æ—Ç ROOT/Server:
// "set_light" —Å brightness=100
```

### 3. ‚ùå –ù–ï –∏–≥–Ω–æ—Ä–∏—Ä—É–π safety checks

```c
// –ü–õ–û–•–û ‚ùå
gpio_set_level(WINDOW_1_GPIO, 1);  // ‚ùå –ë–µ–∑ timeout!
vTaskDelay(pdMS_TO_TICKS(60000));  // ‚ùå 60 —Å–µ–∫ - —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ!
gpio_set_level(WINDOW_1_GPIO, 0);

// –•–û–†–û–®–û ‚úÖ
actuator_open_window(1);  // ‚úÖ –° timeout 45 —Å–µ–∫ –∏ –∫–æ–Ω—Ü–µ–≤–∏–∫–∞–º–∏
```

---

## üîß –ö–û–ú–ü–û–ù–ï–ù–¢–´ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

### components/actuator_manager/:
```c
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–µ–π–Ω—ã–º–∏ –∞–∫—Ç—É–∞—Ç–æ—Ä–∞–º–∏
esp_err_t actuator_manager_init(void);
esp_err_t actuator_manager_open_window(int window_num);
esp_err_t actuator_manager_close_window(int window_num);
window_state_t actuator_manager_get_state(int window_num);
void actuator_manager_emergency_stop(void);
```

### components/fan_controller/:
```c
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º
esp_err_t fan_controller_init(void);
esp_err_t fan_controller_turn_on(void);
esp_err_t fan_controller_turn_off(void);
esp_err_t fan_controller_set_speed(uint8_t speed_percent);
bool fan_controller_is_on(void);
uint8_t fan_controller_get_speed(void);
```

### components/led_controller/:
```c
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ LED –æ—Å–≤–µ—â–µ–Ω–∏–µ–º
esp_err_t led_controller_init(void);
esp_err_t led_controller_set_brightness(uint8_t brightness_percent);
uint8_t led_controller_get_brightness(void);
esp_err_t led_controller_smooth_transition(uint8_t from, uint8_t to, uint32_t duration_ms);
```

### components/relay_controller/:
```c
// –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
esp_err_t relay_controller_init(relay_node_config_t *config);
esp_err_t relay_controller_start(void);
void relay_controller_handle_command(const char *command, cJSON *params);
void relay_controller_handle_config_update(cJSON *config_json);
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä—Ç–æ—á–∫—É:

```bash
mosquitto_pub -h 192.168.1.100 -t hydro/command/relay_001 -m '{
  "type": "command",
  "node_id": "relay_001",
  "command": "set_window",
  "params": {"window": 1, "action": "open"}
}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –ª–æ–≥:**
```
I (5000) relay_ctrl: Command received: set_window
I (5000) actuator_mgr: Window 1 opening...
I (35000) actuator_mgr: Window 1 OPEN (limit switch triggered)
I (35010) relay_ctrl: Status sent to ROOT
```

### –¢–µ—Å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º:

```bash
mosquitto_pub -h 192.168.1.100 -t hydro/command/relay_001 -m '{
  "type": "command",
  "node_id": "relay_001",
  "command": "set_fan",
  "params": {"state": "on", "speed": 75}
}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –ª–æ–≥:**
```
I (10000) relay_ctrl: Command received: set_fan
I (10000) fan_ctrl: Fan: ON (speed=75%)
I (10010) relay_ctrl: Status sent to ROOT
```

---

## üìä –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï –° –î–†–£–ì–ò–ú–ò –£–ó–õ–ê–ú–ò

### –¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:

```
1. climate_001 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:
   {"temperature": 29.5, "humidity": 70} ‚Üí ROOT

2. ROOT (climate_logic) –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ:
   "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã—Å–æ–∫–∞—è ‚Üí –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä—Ç–æ—á–∫—É + –≤–∫–ª—é—á–∏—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä"

3. ROOT –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã:
   hydro/command/relay_001 ‚Üí "set_window" window=1 action=open
   hydro/command/relay_001 ‚Üí "set_fan" state=on speed=100

4. relay_001 –∏—Å–ø–æ–ª–Ω—è–µ—Ç:
   ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä—Ç–æ—á–∫—É 1
   ‚úÖ –í–∫–ª—é—á–∞–µ—Ç –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –Ω–∞ 100%
   ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ ROOT

5. ROOT –≤–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å:
   {"window_1": "open", "fan": "on"}
   ‚úÖ –î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
```

---

## üîê SAFETY FEATURES

### 1. Timeout protection:
```c
#define ACTUATOR_MAX_TIME_SEC   45  // –ú–∞–∫—Å –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
#define ACTUATOR_COOLDOWN_SEC   5   // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
```

### 2. Emergency stop:
```c
void relay_controller_emergency_stop(void) {
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –í–°–ï–• –∞–∫—Ç—É–∞—Ç–æ—Ä–æ–≤
    gpio_set_level(1, 0);  // Window 1
    gpio_set_level(2, 0);  // Window 2
    gpio_set_level(3, 0);  // Fan
    ledc_set_duty(..., 0); // LED
    
    ESP_LOGE(TAG, "EMERGENCY STOP ACTIVATED!");
}
```

### 3. Overcurrent detection (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç—á–∏–∫ —Ç–æ–∫–∞):
```c
// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–∫–∞ –∞–∫—Ç—É–∞—Ç–æ—Ä–æ–≤
if (current > MAX_CURRENT_MA) {
    ESP_LOGE(TAG, "Overcurrent detected: %d mA", current);
    relay_controller_emergency_stop();
    send_emergency_event("Overcurrent protection");
}
```

---

## üìã CHECKLIST –î–õ–Ø –ò–ò

–ü–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—å:

- [ ] `MESH_MODE_NODE` (–ù–ï ROOT!)
- [ ] Callback `on_mesh_data_received` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] –ö–æ–º–∞–Ω–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (`handle_command`)
- [ ] –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
- [ ] Heartbeat –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
- [ ] Timeout protection –¥–ª—è –∞–∫—Ç—É–∞—Ç–æ—Ä–æ–≤ (45 —Å–µ–∫)
- [ ] Cooldown –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ (5 —Å–µ–∫)
- [ ] Emergency stop —Ñ—É–Ω–∫—Ü–∏—è
- [ ] PWM –¥–ª—è LED —Å–≤–µ—Ç–∞ (0-100%)
- [ ] –ù–ï–¢ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π –ª–æ–≥–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥—ã!)
- [ ] –ù–ï–¢ –¥–∞—Ç—á–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏!)

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

**NODE Relay —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –µ—Å–ª–∏:**

1. ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ ROOT –∫–∞–∫ NODE (layer 2)
2. ‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç ROOT/Server
3. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
4. ‚úÖ –ê–∫—Ç—É–∞—Ç–æ—Ä—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ 45 —Å–µ–∫ (timeout)
5. ‚úÖ –ö–æ–Ω—Ü–µ–≤–∏–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –∞–∫—Ç—É–∞—Ç–æ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
6. ‚úÖ –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è PWM (0-100%)
7. ‚úÖ LED —Å–≤–µ—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è PWM (0-100%)
8. ‚úÖ Emergency stop —Ä–∞–±–æ—Ç–∞–µ—Ç
9. ‚úÖ –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–π —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ

---

**–ì–û–¢–û–í–û! Relay NODE - –¢–û–õ–¨–ö–û –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨, –ë–ï–ó –õ–û–ì–ò–ö–ò!** ‚öôÔ∏èüîå

