# üîó –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–ª–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           –ü–û–õ–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –°–û–ë–´–¢–ò–ô –ù–ê–°–û–°–û–í                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   NODE pH   ‚îÇ    ‚îÇ   NODE EC   ‚îÇ    ‚îÇ NODE ph_ec  ‚îÇ
‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ
‚îÇ pump_events ‚îÇ    ‚îÇ pump_events ‚îÇ    ‚îÇ pump_events ‚îÇ
‚îÇ PH_UP/DOWN  ‚îÇ    ‚îÇ EC_A/B/C    ‚îÇ    ‚îÇ ALL PUMPS   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                  ‚îÇ                  ‚îÇ
       ‚îÇ mesh_manager_send_to_root()         ‚îÇ
       ‚îÇ                  ‚îÇ                  ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ ROOT NODE   ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ data_router ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ mesh ‚Üí MQTT ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ MQTT Broker ‚îÇ
                    ‚îÇ (Mosquitto) ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ Topic:      ‚îÇ
                    ‚îÇ hydro/event ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   SERVER    ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ MqttService ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ Event::create‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ PostgreSQL  ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ events table‚îÇ
                    ‚îÇ JSONB data  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ WebSocket   ‚îÇ
                    ‚îÇ (Reverb)    ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ Broadcasting‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  FRONTEND   ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ Vue.js      ‚îÇ
                    ‚îÇ             ‚îÇ
                    ‚îÇ Events.vue  ‚îÇ
                    ‚îÇ Real-time   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîÑ –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### **1. –ù–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ:**
```c
// –í pump_events.c
pump_events_send_start_event(
    PUMP_PH_UP,
    duration_ms,
    dose_ml,
    &pid_data,
    current_ph,
    ph_target,
    emergency_mode,
    autonomous_mode,
    rssi
);
```

### **2. ROOT –Ω–æ–¥–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç:**
```c
// –í data_router.c
data_router_handle_mesh_data() {
    // –ü–∞—Ä—Å–∏–Ω–≥ JSON
    mesh_protocol_parse(data, &msg);
    
    // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ MQTT
    mqtt_client_manager_publish(topic, data);
}
```

### **3. MQTT Broker –ø–æ–ª—É—á–∞–µ—Ç:**
```
Topic: hydro/event/ph_001
Payload: {
  "type": "event",
  "node_id": "ph_001",
  "node_type": "ph",
  "data": {
    "event_type": "pump_start",
    "pump_id": 0,
    "dose_ml": 1.5,
    "pid_data": { ... }
  }
}
```

### **4. –°–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
```php
// –í MqttService.php
public function handleEvent($topic, $payload) {
    $data = json_decode($payload, true);
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Å–æ—Å–æ–≤
    if (strpos($data['data']['event_type'], 'pump_') === 0) {
        $message = $this->translatePumpEventMessage($data['data']);
        $level = $this->getPumpEventLevel($data['data']);
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    $event = Event::create([
        'node_id' => $data['node_id'],
        'level' => $level,
        'message' => $message,
        'data' => $data['data']
    ]);
    
    // Broadcast —á–µ—Ä–µ–∑ WebSocket
    event(new EventCreated($event));
}
```

### **5. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:**
```sql
INSERT INTO events (
    node_id, level, message, data
) VALUES (
    'ph_001',
    'info',
    'üö∞ –ù–∞—Å–æ—Å pH UP –∑–∞–ø—É—â–µ–Ω: 1.5 –º–ª (3000 –º—Å)',
    '{"event_type": "pump_start", "pump_id": 0, ...}'
);
```

### **6. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç:**
```javascript
// –í events store
onMounted(() => {
    // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    this.socket.on('event.created', (event) => {
        this.events.push(event);
        this.updateStats();
    });
});
```

## üìä –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤

| –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | –£—Ä–æ–≤–µ–Ω—å | –°–æ–æ–±—â–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------------|---------|-----------|----------|
| `pump_start` | INFO | üö∞ –ù–∞—Å–æ—Å {name} –∑–∞–ø—É—â–µ–Ω: {dose} –º–ª | –ù–∞—Å–æ—Å –≤–∫–ª—é—á–µ–Ω |
| `pump_stop` | INFO | üõë –ù–∞—Å–æ—Å {name} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {dose} –º–ª | –ù–∞—Å–æ—Å –≤—ã–∫–ª—é—á–µ–Ω |
| `pump_emergency_stop` | CRITICAL | üö® –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ {name} | –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ |
| `pump_timeout` | WARNING | ‚è∞ –¢–∞–π–º–∞—É—Ç –Ω–∞—Å–æ—Å–∞ {name} | –¢–∞–π–º–∞—É—Ç —Ä–∞–±–æ—Ç—ã |
| `pump_calibration_start` | INFO | üîß –ù–∞—á–∞–ª–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –Ω–∞—Å–æ—Å–∞ {name} | –ù–∞—á–∞–ª–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ |
| `pump_calibration_end` | INFO | ‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ {name} –∑–∞–≤–µ—Ä—à–µ–Ω–∞ | –ö–æ–Ω–µ—Ü –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ |

## üéØ –ù–∞–∑–≤–∞–Ω–∏—è –Ω–∞—Å–æ—Å–æ–≤ –ø–æ —Ç–∏–ø–∞–º –Ω–æ–¥

### **pH –Ω–æ–¥–∞:**
- Pump ID 0 ‚Üí "pH UP"
- Pump ID 1 ‚Üí "pH DOWN"

### **EC –Ω–æ–¥–∞:**
- Pump ID 0 ‚Üí "EC A"
- Pump ID 1 ‚Üí "EC B"  
- Pump ID 2 ‚Üí "EC C"

### **ph_ec –Ω–æ–¥–∞:**
- Pump ID 0 ‚Üí "pH UP"
- Pump ID 1 ‚Üí "pH DOWN"
- Pump ID 2 ‚Üí "EC A"
- Pump ID 3 ‚Üí "EC B"
- Pump ID 4 ‚Üí "EC C"

## üîß –î–∞–Ω–Ω—ã–µ PID –≤ —Å–æ–±—ã—Ç–∏—è—Ö

```json
{
  "pid_data": {
    "kp": 1.5,           // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    "ki": 0.2,           // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç  
    "kd": 0.8,           // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    "setpoint": 6.5,     // –ó–∞–¥–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    "current_value": 6.0, // –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    "error": 0.5,        // –û—à–∏–±–∫–∞ (setpoint - current)
    "output": 1.5,       // –í—ã—Ö–æ–¥ PID
    "integral": 0.0,     // –ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è
    "derivative": 0.0,    // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è
    "enabled": true      // –í–∫–ª—é—á–µ–Ω –ª–∏ PID
  }
}
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å–æ—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

1. **–ù–æ–¥—ã** –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–±—ã—Ç–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ PID
2. **ROOT –Ω–æ–¥–∞** –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ MQTT
3. **–°–µ—Ä–≤–µ—Ä** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
4. **–ë–î** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å JSONB –¥–∞–Ω–Ω—ã–º–∏
5. **–§—Ä–æ–Ω—Ç–µ–Ω–¥** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ**
