# üîç –ê–Ω–∞–ª–∏–∑: –ü—É—Ç–∞–Ω–∏—Ü–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ —É–∑–ª–æ–≤

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–í —Å–∏—Å—Ç–µ–º–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ **–Ω–µ—Å–∫–æ–ª—å–∫–æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Å—Ç–∞—Ç—É—Å–æ–≤** –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞ —É–∑–ª–æ–≤, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –ø—É—Ç–∞–Ω–∏—Ü—É:

### **–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**

1. **`online`** - –ø–æ–ª–µ –≤ –ë–î (boolean)
2. **`is_online`** - –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ (boolean) 
3. **`isOnline`** - –º–µ—Ç–æ–¥ –≤ –º–æ–¥–µ–ª–∏ (boolean)
4. **`isPumpRunning`** - —Å—Ç–∞—Ç—É—Å –Ω–∞—Å–æ—Å–æ–≤ (boolean)
5. **`last_seen_at`** - timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### **1. –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (Node.php):**
```php
// –ü–æ–ª–µ –≤ –ë–î
'online' => 'boolean',

// –ú–µ—Ç–æ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
public function isOnline(): bool
{
    if (!$this->last_seen_at) {
        return false;
    }
    
    $timeout = config('hydro.node_offline_timeout', 20); // —Å–µ–∫—É–Ω–¥
    return $this->last_seen_at->diffInSeconds(now()) < $timeout;
}
```

### **2. –í API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ (NodeController.php):**
```php
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π
$nodes->each(function ($node) {
    $node->is_online = $node->isOnline();  // ‚Üê –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!
    $node->status_color = $node->status_color;
    $node->icon = $node->icon;
});
```

### **3. –í–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (nodes.js):**
```javascript
// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ is_online, –ø–æ—Ç–æ–º online
onlineNodes: (state) => {
  return state.nodes.filter(node => {
    return node.is_online !== undefined ? node.is_online : node.online
  })
}
```

### **4. –í MQTT —Å–µ—Ä–≤–∏—Å–µ (MqttService.php):**
```php
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ online —Å—Ç–∞—Ç—É—Å–∞
$wasOnline = $node->online;
$isOnline = $node->isOnline();

if ($wasOnline !== $isOnline) {
    $node->update(['online' => $isOnline]);
}
```

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

### **1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏:**
- `online` (–ë–î) –∏ `is_online` (–≤—ã—á–∏—Å–ª—è–µ–º–æ–µ) —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- `isOnline()` –º–µ—Ç–æ–¥ –¥—É–±–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

### **2. –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
- `online` –ø–æ–ª–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º
- `is_online` –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É, –Ω–æ –º–æ–∂–µ—Ç –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –≤ –ë–î
- `isPumpRunning` - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–æ–º

### **3. –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ –∫–æ–¥–µ:**
- –†–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è
- –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### **–£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã:**

1. **–û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `isOnline()` –º–µ—Ç–æ–¥** - –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
2. **–£–±—Ä–∞—Ç—å `is_online` –ø–æ–ª–µ** –∏–∑ API –æ—Ç–≤–µ—Ç–æ–≤
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `online` —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è** –≤ –ë–î
4. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—è

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

```php
// –í –º–æ–¥–µ–ª–∏ Node.php
public function isOnline(): bool
{
    if (!$this->last_seen_at) {
        return false;
    }
    
    $timeout = config('hydro.node_offline_timeout', 20);
    return $this->last_seen_at->diffInSeconds(now()) < $timeout;
}

// –í API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ - –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å is_online
$nodes->each(function ($node) {
    $node->status_color = $node->status_color;
    $node->icon = $node->icon;
    // is_online —É–±–∏—Ä–∞–µ–º!
});
```

```javascript
// –í–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ online
onlineNodes: (state) => {
  return state.nodes.filter(node => node.online)
}
```

## üîß –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **–®–∞–≥ 1: –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ API**
- –£–¥–∞–ª–∏—Ç—å `$node->is_online = $node->isOnline()` –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
- –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `online` –ø–æ–ª–µ –∏–∑ –ë–î

### **–®–∞–≥ 2: –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥**
- –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_online !== undefined ? node.is_online : node.online`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `node.online`

### **–®–∞–≥ 3: –£–ª—É—á—à–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é**
- –û–±–Ω–æ–≤–ª—è—Ç—å `online` –ø–æ–ª–µ –≤ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `last_seen_at`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `isOnline()` —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –Ω–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è

### **–®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å `isPumpRunning`**
- –≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–æ–º
- –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ —á–µ—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–∑–ª–∞

```json
{
  "isOnline": false,           // ‚Üê –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
  "isPumpRunning": false,      // ‚Üê –û—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å (–û–ö)
  "last_seen_at": "2025-10-20T19:19:54.000000Z",
  "online": false,             // ‚Üê –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ  
  "is_online": false,          // ‚Üê –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
  "node_id": "ph_ec_3cfd01",
  "node_type": "ph_ec"
}
```

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```json
{
  "online": false,             // ‚Üê –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
  "isPumpRunning": false,      // ‚Üê –û—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞—Å–æ—Å–æ–≤
  "last_seen_at": "2025-10-20T19:19:54.000000Z",
  "node_id": "ph_ec_3cfd01",
  "node_type": "ph_ec"
}
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞** - –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
2. **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—É—Ç–∞–Ω–∏—Ü—ã** - –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
3. **–õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–µ–Ω—å—à–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
4. **–õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å** - –º–µ–Ω—å—à–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
5. **–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ** - –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å vs —Å—Ç–∞—Ç—É—Å –Ω–∞—Å–æ—Å–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã! üîß**
