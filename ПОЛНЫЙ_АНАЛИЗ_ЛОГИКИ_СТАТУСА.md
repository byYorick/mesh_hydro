# üìä –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –õ–û–ì–ò–ö–ò –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê

**–î–∞—Ç–∞:** 20 –æ–∫—Ç—è–±—Ä—è 2025, 22:50  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω—ã–π audit –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–∏

---

## üîç –¶–ï–ü–û–ß–ö–ê #1: –£–°–¢–†–û–ô–°–¢–í–û –ü–û–î–ö–õ–Æ–ß–ê–ï–¢–°–Ø (online)

### –®–∞–≥ 1: ESP32 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ

```c
// ESP32 –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é/heartbeat –ø–æ MQTT
mqtt_publish("hydro/telemetry/ph_ec_3cfd01", json_data)
mqtt_publish("hydro/heartbeat/ph_ec_3cfd01", heartbeat_data)
```

**–í—Ä–µ–º—è:** T=0s

---

### –®–∞–≥ 2: MQTT Listener –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

**–§–∞–π–ª:** `MqttService.php` (—Å—Ç—Ä–æ–∫–∏ 149-231)

```php
// handleTelemetry() –∏–ª–∏ handleHeartbeat()
$node = Node::updateOrCreate(
    ['node_id' => $data['node_id']],
    [
        'online' => true,          // ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç online = true
        'last_seen_at' => now(),   // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è
    ]
);

// –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí broadcast
if ($wasOnline !== true) {
    event(new NodeStatusChanged($node, $wasOnline, true));
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–î: `online = true`, `last_seen_at = now()`
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ WebSocket —Å–æ–±—ã—Ç–∏–µ (–µ—Å–ª–∏ –±—ã–ª offline)

**–í—Ä–µ–º—è:** T=0.1s (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ)

---

### –®–∞–≥ 3: WebSocket/Fallback –æ–±–Ω–æ–≤–ª—è–µ—Ç Frontend

**A) –ß–µ—Ä–µ–∑ WebSocket (–µ—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç):**
```javascript
// App.vue —Å–ª—É—à–∞–µ—Ç
channel.listen('.node.status.changed', (data) => {
  nodesStore.updateNodeRealtime({
    node_id: data.node_id,
    online: data.online,  // true
  })
})
```

**–í—Ä–µ–º—è:** T=0.1s (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ) ‚ö°

**B) –ß–µ—Ä–µ–∑ Fallback Polling (—Ç–µ–∫—É—â–∏–π):**
```javascript
// echo.js –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
setInterval(async () => {
  const nodes = await api.getNodes()  // –ü–æ–ª—É—á–∞–µ—Ç online=true
  window.dispatchEvent('echo:fallback', { data: nodes })
}, 5000)

// App.vue –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
window.addEventListener('echo:fallback', (event) => {
  data.forEach(node => {
    nodesStore.updateNodeRealtime(node)  // online=true
  })
})
```

**–í—Ä–µ–º—è:** T=0-5s (–≤ —Å—Ä–µ–¥–Ω–µ–º 2.5 —Å–µ–∫) ‚úÖ

---

### –ò–¢–û–ì–û –ü–†–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ò:

```
ESP32 –≤–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí MQTT –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
    ‚Üì (0.1s)
Backend: online=true, last_seen=now()
    ‚Üì (0-5s fallback polling)
Frontend: –æ–±–Ω–æ–≤–ª—è–µ—Ç store
    ‚Üì (0ms)
Dashboard: üü¢ ONLINE

–ò–¢–û–ì–û: 0.1-5 —Å–µ–∫—É–Ω–¥ ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û!
```

---

## üîç –¶–ï–ü–û–ß–ö–ê #2: –£–°–¢–†–û–ô–°–¢–í–û –û–¢–ö–õ–Æ–ß–ê–ï–¢–°–Ø (offline)

### –®–∞–≥ 1: ESP32 –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ

```
ESP32 –≤—ã–∫–ª—é—á–µ–Ω/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω
‚Üí –ù–µ—Ç –±–æ–ª—å—à–µ MQTT —Å–æ–æ–±—â–µ–Ω–∏–π
‚Üí last_seen_at –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–º
```

**–í—Ä–µ–º—è:** T=0s

---

### –®–∞–≥ 2: Backend –∂–¥–µ—Ç —Ç–∞–π–º–∞—É—Ç

```php
// Node.php - –º–µ—Ç–æ–¥ isOnline()
public function isOnline(): bool
{
    $timeout = config('hydro.node_offline_timeout', 30);  // 30 —Å–µ–∫
    return $this->last_seen_at->diffInSeconds(now()) < $timeout;
}
```

**–õ–æ–≥–∏–∫–∞:**
- T=0-29s: `isOnline() = true` (< 30 —Å–µ–∫)
- T=30s+: `isOnline() = false` (‚â• 30 —Å–µ–∫)

**–í—Ä–µ–º—è:** T=30s (–æ–∂–∏–¥–∞–Ω–∏–µ)

---

### –®–∞–≥ 3: Scheduler –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å

**–§–∞–π–ª:** `CheckNodesStatusCommand.php` (—Å—Ç—Ä–æ–∫–∏ 37-47)

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (`everyThirtySeconds()`)

```php
foreach ($nodes as $node) {
    $wasOnline = $node->online;  // –ò–∑ –ë–î
    $isOnline = $node->isOnline();  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ last_seen_at
    
    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
    if ($node->online !== $isOnline) {
        $node->update(['online' => $isOnline]);  // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
        
        // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º WebSocket —Å–æ–±—ã—Ç–∏–µ
        event(new NodeStatusChanged($node, $wasOnline, $isOnline));
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞ –∑–¥–µ—Å—å!** ‚ö†Ô∏è

Scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥**, –Ω–æ –Ω–µ –≤ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è!

–ù–∞–ø—Ä–∏–º–µ—Ä:
- 19:00:00 - –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
- 19:00:30 - –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
- 19:01:00 - –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è

–ï—Å–ª–∏ —É–∑–µ–ª –æ—Ç–∫–ª—é—á–∏–ª—Å—è –≤ 19:00:01, —Ç–æ:
- 19:00:30 - –ø—Ä–æ—à–ª–æ 29 —Å–µ–∫ ‚Üí `isOnline() = true` ‚úÖ
- 19:01:00 - –ø—Ä–æ—à–ª–æ 59 —Å–µ–∫ ‚Üí `isOnline() = false` ‚úÖ (–æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ)

**–•—É–¥—à–∏–π —Å–ª—É—á–∞–π:** 59 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è!

**–í—Ä–µ–º—è:** T=30-60s (–≤ —Å—Ä–µ–¥–Ω–µ–º 45 —Å–µ–∫) ‚ö†Ô∏è

---

### –®–∞–≥ 4: WebSocket/Fallback –æ–±–Ω–æ–≤–ª—è–µ—Ç Frontend

**A) –ß–µ—Ä–µ–∑ WebSocket:**
```javascript
channel.listen('.node.status.changed', (data) => {
  nodesStore.updateNodeRealtime({
    online: data.online  // false
  })
})
```

**–í—Ä–µ–º—è:** –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ ‚ö°

**B) –ß–µ—Ä–µ–∑ Fallback Polling:**
```javascript
setInterval(async () => {
  const nodes = await api.getNodes()  // online=false
  // –û–±–Ω–æ–≤–ª—è–µ—Ç store
}, 5000)
```

**–í—Ä–µ–º—è:** 0-5s (–≤ —Å—Ä–µ–¥–Ω–µ–º 2.5 —Å–µ–∫)

---

### –ò–¢–û–ì–û –ü–†–ò –û–¢–ö–õ–Æ–ß–ï–ù–ò–ò:

```
ESP32 –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
    ‚Üì (30 —Å–µ–∫—É–Ω–¥ - timeout)
Backend: isOnline() = false
    ‚Üì (0-30 —Å–µ–∫—É–Ω–¥ - –æ–∂–∏–¥–∞–Ω–∏–µ scheduler)
Scheduler: –æ–±–Ω–æ–≤–ª—è–µ—Ç online=false, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket
    ‚Üì (0-5 —Å–µ–∫—É–Ω–¥ - fallback polling)
Frontend: –æ–±–Ω–æ–≤–ª—è–µ—Ç store
    ‚Üì (0ms)
Dashboard: üî¥ OFFLINE

–ò–¢–û–ì–û: 30-65 —Å–µ–∫—É–Ω–¥ (–≤ —Å—Ä–µ–¥–Ω–µ–º ~47 —Å–µ–∫) ‚ö†Ô∏è
```

---

## üéØ –ü–†–û–ë–õ–ï–ú–´ –í –¢–ï–ö–£–©–ï–ô –õ–û–ì–ò–ö–ï

### –ü—Ä–æ–±–ª–µ–º–∞ #1: Scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** –ï—Å–ª–∏ —É–∑–µ–ª –æ—Ç–∫–ª—é—á–∏–ª—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å –µ—â–µ 30 —Å–µ–∫—É–Ω–¥!

**–ü—Ä–∏–º–µ—Ä:**
```
19:00:00 - Scheduler –ø—Ä–æ–≤–µ—Ä–∏–ª (—É–∑–µ–ª online)
19:00:01 - –£–∑–µ–ª –æ—Ç–∫–ª—é—á–∏–ª—Å—è
19:00:31 - –£–∑–µ–ª —Å—Ç–∞–ª offline (last_seen = 30 —Å–µ–∫ –Ω–∞–∑–∞–¥)
19:00:30 - Scheduler –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å–Ω–æ–≤–∞ ‚Üê –ï–©–ï –ù–ï–¢!
19:01:00 - Scheduler –ø—Ä–æ–≤–µ—Ä–∏—Ç ‚Üê –û–ë–ù–ê–†–£–ñ–ò–¢ offline (—á–µ—Ä–µ–∑ 59 —Å–µ–∫!)
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –î–≤–æ–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (timeout + scheduler)

```
30 —Å–µ–∫ (offline timeout) + 0-30 —Å–µ–∫ (scheduler) = 30-60 —Å–µ–∫ –ò–¢–û–ì–û
```

---

## ‚úÖ –†–ï–®–ï–ù–ò–Ø

### –†–µ—à–µ–Ω–∏–µ #1: –£—Å–∫–æ—Ä–∏—Ç—å scheduler –¥–æ 15 —Å–µ–∫—É–Ω–¥ ‚≠ê –†–ï–ö–û–ú–ï–ù–î–£–Æ

**–§–∞–π–ª:** `routes/console.php`

```php
// –ë—ã–ª–æ:
->everyThirtySeconds()  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫

// –°—Ç–∞–Ω–µ—Ç:
->everyFifteenSeconds()  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –¢–∞–π–º–∞—É—Ç: 30 —Å–µ–∫
- Scheduler: 0-15 —Å–µ–∫
- **–ò–¢–û–ì–û: 30-45 —Å–µ–∫ (–≤ —Å—Ä–µ–¥–Ω–µ–º ~37 —Å–µ–∫)** ‚úÖ

---

### –†–µ—à–µ–Ω–∏–µ #2: –£–º–µ–Ω—å—à–∏—Ç—å timeout –¥–æ 20 —Å–µ–∫—É–Ω–¥

**–§–∞–π–ª:** `config/hydro.php`

```php
'node_offline_timeout' => env('NODE_OFFLINE_TIMEOUT', 20),
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –¢–∞–π–º–∞—É—Ç: 20 —Å–µ–∫
- Scheduler: 0-30 —Å–µ–∫
- **–ò–¢–û–ì–û: 20-50 —Å–µ–∫ (–≤ —Å—Ä–µ–¥–Ω–µ–º ~35 —Å–µ–∫)** ‚úÖ

---

### –†–µ—à–µ–Ω–∏–µ #3: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è (–õ–£–ß–®–ï –í–°–ï–ì–û!) üéØ

```php
// config/hydro.php
'node_offline_timeout' => 20  // –û—Ñ–ª–∞–π–Ω —á–µ—Ä–µ–∑ 20 —Å–µ–∫

// routes/console.php
->everyFifteenSeconds()  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –¢–∞–π–º–∞—É—Ç: 20 —Å–µ–∫
- Scheduler: 0-15 —Å–µ–∫
- **–ò–¢–û–ì–û: 20-35 —Å–µ–∫ (–≤ —Å—Ä–µ–¥–Ω–µ–º ~27 —Å–µ–∫)** ‚úÖ –ò–î–ï–ê–õ–¨–ù–û!

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –í–ê–†–ò–ê–ù–¢–û–í

| –í–∞—Ä–∏–∞–Ω—Ç | Timeout | Scheduler | –ú–∏–Ω. | –ú–∞–∫—Å. | –°—Ä–µ–¥–Ω. |
|---------|---------|-----------|------|-------|--------|
| **–¢–µ–∫—É—â–∏–π** | 30s | 30s | 30s | 60s | 45s |
| **–†–µ—à–µ–Ω–∏–µ #1** | 30s | 15s | 30s | 45s | 37s ‚úÖ |
| **–†–µ—à–µ–Ω–∏–µ #2** | 20s | 30s | 20s | 50s | 35s ‚úÖ |
| **–†–µ—à–µ–Ω–∏–µ #3** | 20s | 15s | 20s | 35s | 27s ‚≠ê |

---

## üí° –ú–û–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

### –†–µ—à–µ–Ω–∏–µ #3: Timeout 20s + Scheduler 15s

**–ü–æ—á–µ–º—É:**
1. ‚ö° **–ë—ã—Å—Ç—Ä–æ:** –≤ —Å—Ä–µ–¥–Ω–µ–º ~30 —Å–µ–∫—É–Ω–¥
2. üéØ **–¢–æ—á–Ω–æ:** –º–∞–∫—Å–∏–º—É–º 35 —Å–µ–∫—É–Ω–¥
3. üí™ **–ù–∞–¥–µ–∂–Ω–æ:** –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ (20 —Å–µ–∫ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
4. ‚öôÔ∏è **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ:** scheduler –Ω–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É (240 –ø—Ä–æ–≤–µ—Ä–æ–∫/—á–∞—Å)

**–ß—Ç–æ –ø–æ–º–µ–Ω—è—Ç—å:**

```php
// config/hydro.php - —Å—Ç—Ä–æ–∫–∞ 23
'node_offline_timeout' => env('NODE_OFFLINE_TIMEOUT', 20),

// routes/console.php - —Å—Ç—Ä–æ–∫–∞ 23
->everyFifteenSeconds()
```

---

## üéØ –•–û–ß–ï–®–¨ –ü–†–ò–ú–ï–ù–ò–¢–¨ –†–ï–®–ï–ù–ò–ï #3?

–°–∫–∞–∂–∏ **"–¥–∞"** –∏ —è:
1. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª—é timeout 20 —Å–µ–∫—É–Ω–¥
2. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª—é scheduler –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
3. ‚úÖ –ü–µ—Ä–µ—Å–æ–±–µ—Ä—É backend –∏ scheduler
4. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—â—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

**–¢–æ–≥–¥–∞ offline –±—É–¥–µ—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ 20-35 —Å–µ–∫—É–Ω–¥!** ‚ö°

---

**–ê–≤—Ç–æ—Ä:** AI Assistant (Claude Sonnet 4.5)  
**–î–∞—Ç–∞:** 20.10.2025 22:50  
**–í–µ—Ä—Å–∏—è:** Full Logic Analysis v1.0

