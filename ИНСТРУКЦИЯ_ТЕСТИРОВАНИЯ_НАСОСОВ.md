# üß™ –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ù–ê–°–û–°–ê–ú–ò

## üìã –ü–û–î–ì–û–¢–û–í–ö–ê

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Backend
```bash
cd server/backend

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
php artisan migrate

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–ª–∞—Å—å
php artisan tinker
>>> \App\Models\PumpCalibration::count()
0

# –ó–∞–ø—É—Å—Ç–∏—Ç—å MQTT Listener
php artisan mqtt:listen
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker
```bash
cd server
docker-compose up -d
```

### 3. –ü—Ä–æ—à–∏—Ç—å –Ω–æ–¥—ã
```bash
# pH –Ω–æ–¥–∞
cd node_ph
idf.py build flash monitor

# EC –Ω–æ–¥–∞ (–≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
cd node_ec
idf.py build flash monitor
```

---

## üß™ –¢–ï–°–¢ 1: –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –Ω–∞—Å–æ—Å–∞

### –®–∞–≥–∏:
1. –û—Ç–∫—Ä—ã—Ç—å Frontend: `http://localhost:3000`
2. –ù–∞–π—Ç–∏ pH –Ω–æ–¥—É –≤ —Å–ø–∏—Å–∫–µ
3. –û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–æ–¥—ã
4. –í —Å–µ–∫—Ü–∏–∏ "Manual Pump Control" –≤—ã–±—Ä–∞—Ç—å:
   - Pump: `pH UP`
   - Duration: `5.0` —Å–µ–∫—É–Ω–¥
5. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "‚ñ∂ Run 5s"

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**Frontend:**
- Toast: "pH UP started for 5s"

**Backend –ª–æ–≥ (MQTT Listener):**
```
üìä [COMMAND] hydro/command/ph_001
Pump run command sent: ph_001, pump_id=0, duration_sec=5.0
```

**ROOT –ª–æ–≥ (idf.py monitor):**
```
MQTT data received: hydro/command/ph_001
Forwarding command to ph_001
‚úì Command sent to ph_001
```

**pH –Ω–æ–¥–∞ –ª–æ–≥:**
```
Command received: run_pump_manual
Manual pump run: PUMP_UP for 5.0 sec
Pump controller: Running pump 0 for 5000 ms
‚úì Pump started
```

---

## üß™ –¢–ï–°–¢ 2: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:
- –ú–µ—Ä–Ω—ã–π —Ü–∏–ª–∏–Ω–¥—Ä
- –ï–º–∫–æ—Å—Ç—å –¥–ª—è –≤–æ–¥—ã
- –°–µ–∫—É–Ω–¥–æ–º–µ—Ä (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–π–º–µ—Ä –Ω–∞ –Ω–æ–¥–µ)

### –®–∞–≥–∏:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å –≤—Ä—É—á–Ω—É—é –Ω–∞ **10 —Å–µ–∫—É–Ω–¥**
2. –ò–∑–º–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, **12.5 –º–ª**)
3. –û—Ç–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏—é "Pump Calibration"
4. –í–≤–µ—Å—Ç–∏:
   - Duration: `10.0`
   - Volume: `12.5`
5. –ù–∞–∂–∞—Ç—å "üìè Calibrate"

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**Frontend:**
- Toast: "pH UP calibrated: 1.25 ml/s"
- –†—è–¥–æ–º —Å –Ω–∞—Å–æ—Å–æ–º: "‚úÖ 1.25 ml/s"

**Backend –ª–æ–≥:**
```
Pump calibration saved and sent: ph_001, pump_id=0, ml_per_second=1.25
```

**pH –Ω–æ–¥–∞ –ª–æ–≥:**
```
Command received: calibrate_pump
Pump 0 calibrated: 1.25 ml/sec (12.5 ml in 10.0 sec)
Config saved to NVS: ESP_OK
```

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
```sql
SELECT * FROM pump_calibrations WHERE node_id = 'ph_001';

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- id | node_id | pump_id | ml_per_second | calibration_volume_ml | is_calibrated | calibrated_at
-- 1  | ph_001  | 0       | 1.25          | 12.5                  | 1             | 2025-10-21...
```

---

## üß™ –¢–ï–°–¢ 3: –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –®–∞–≥–∏:
1. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üîÑ Refresh Config from Node"

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**Frontend:**
- Toast: "Config request sent. Check WebSocket for response."

**Backend –ª–æ–≥ (MQTT Listener):**
```
üìä [COMMAND] hydro/command/ph_001
Config request sent to node: ph_001

...—á–µ—Ä–µ–∑ 1-2 —Å–µ–∫—É–Ω–¥—ã...

üìã [CONFIG_RESPONSE] hydro/config_response/ph_001
Config response received: ph_001
Pump calibrations saved: 2 pumps
Config response processed successfully
```

**ROOT –ª–æ–≥:**
```
MQTT data received: hydro/command/ph_001
Forwarding command to ph_001

üì• Mesh data received: 458 bytes from XX:XX:XX:XX:XX:XX
Response from ph_001 ‚Üí MQTT
‚úì Config response published to hydro/config_response/ph_001
```

**pH –Ω–æ–¥–∞ –ª–æ–≥:**
```
Command received: get_config
Config sent to ROOT (458 bytes)
```

**Frontend (WebSocket):**
```
–ü–æ–ª—É—á–µ–Ω event: node.config.updated
{
  node_id: "ph_001",
  config: {
    ph_target: 6.5,
    pumps_calibration: [...]
  }
}
```

---

## üß™ –¢–ï–°–¢ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ NVS —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

### –®–∞–≥–∏:
1. –û—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –Ω–∞—Å–æ—Å (—Å–º. –¢–ï–°–¢ 2)
2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–¥—É (–∫–Ω–æ–ø–∫–∞ RESET)
3. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (—Å–º. –¢–ï–°–¢ 3)

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**pH –Ω–æ–¥–∞ –ª–æ–≥ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:**
```
Loading config from NVS...
Config loaded successfully
Pump calibration[0]: 1.25 ml/s (calibrated)
Pump calibration[1]: 1.00 ml/s (not calibrated)
```

**Frontend:**
–ü–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ `1.25 ml/s`.

---

## üß™ –¢–ï–°–¢ 5: WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –®–∞–≥–∏:
1. –û—Ç–∫—Ä—ã—Ç—å Frontend –≤ –¥–≤—É—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö
2. –í –æ–¥–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –Ω–∞—Å–æ—Å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Ç–æ—Ä–æ–π –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**–û–±–∞ –±—Ä–∞—É–∑–µ—Ä–∞:**
- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
- –ë–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ß–µ—Ä–µ–∑ WebSocket event `node.config.updated`

---

## üß™ –¢–ï–°–¢ 6: Offline —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –®–∞–≥–∏:
1. –í—ã–∫–ª—é—á–∏—Ç—å pH –Ω–æ–¥—É
2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**Frontend:**
- –ö–Ω–æ–ø–∫–∏ disabled (—Å–µ—Ä—ã–µ)
- Toast: "Node is offline"

**Backend –ª–æ–≥:**
```
Error: Node is offline
```

---

## üß™ –¢–ï–°–¢ 7: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –®–∞–≥–∏:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å #0 –Ω–∞ 10 —Å–µ–∫
2. –°—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å #1 –Ω–∞ 5 —Å–µ–∫
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**pH –Ω–æ–¥–∞ –ª–æ–≥:**
```
Manual pump run: PUMP_UP for 10.0 sec
Pump controller: Running pump 0 for 10000 ms
Manual pump run: PUMP_DOWN for 5.0 sec
Pump controller: Running pump 1 for 5000 ms
```

–û–±–∞ –Ω–∞—Å–æ—Å–∞ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

---

## üß™ –¢–ï–°–¢ 8: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –¢–µ—Å—Ç 8.1: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```bash
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å –Ω–∞ 100 —Å–µ–∫—É–Ω–¥
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Frontend –≤–∞–ª–∏–¥–∞—Ü–∏—è: `max="30"`
- Backend –æ—à–∏–±–∫–∞: "Invalid duration"
- –ù–æ–¥–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç –Ω–∞—Å–æ—Å

### –¢–µ—Å—Ç 8.2: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π pump_id
```bash
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å #5 (–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Backend –æ—à–∏–±–∫–∞: "Invalid pump_id"
- –ù–æ–¥–∞ –ª–æ–≥–∏—Ä—É–µ—Ç: "Invalid pump_id: 5"

---

## üìä –ß–ï–ö–õ–ò–°–¢ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

- [ ] –¢–µ—Å—Ç 1: –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –Ω–∞—Å–æ—Å–∞ ‚úì
- [ ] –¢–µ—Å—Ç 2: –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞ ‚úì
- [ ] –¢–µ—Å—Ç 3: –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ‚úì
- [ ] –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ NVS —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚úì
- [ ] –¢–µ—Å—Ç 5: WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚úì
- [ ] –¢–µ—Å—Ç 6: Offline —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚úì
- [ ] –¢–µ—Å—Ç 7: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ‚úì
- [ ] –¢–µ—Å—Ç 8: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚úì

---

## üîß –û–¢–õ–ê–î–ö–ê

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:

**Backend:**
```bash
tail -f server/backend/storage/logs/laravel.log
```

**MQTT Listener:**
```bash
php artisan mqtt:listen
```

**ROOT —É–∑–µ–ª:**
```bash
cd root_node
idf.py monitor
```

**pH/EC –Ω–æ–¥–∞:**
```bash
cd node_ph  # –∏–ª–∏ node_ec
idf.py monitor
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:
```bash
php artisan tinker
>>> \App\Models\PumpCalibration::all()
>>> \App\Models\Node::where('node_id', 'ph_001')->first()->config
```

---

## ‚úÖ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

–ü–æ—Å–ª–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:
- ‚úÖ –ù–∞—Å–æ—Å—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–æ –∫–æ–º–∞–Ω–¥–µ
- ‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ NVS –∏ –ë–î
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- ‚úÖ WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Offline –∑–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

**–î–∞—Ç–∞:** 21 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

