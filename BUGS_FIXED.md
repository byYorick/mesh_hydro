# –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏ ‚úÖ

**–î–∞—Ç–∞:** 21.10.2025  
**–°—Ç–∞—Ç—É—Å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üêõ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)

### 1. ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ CMakeLists.txt**

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í `node_ph/main/CMakeLists.txt` –∏ `node_ec/main/CMakeLists.txt` –Ω–µ –±—ã–ª–∏ —É–∫–∞–∑–∞–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**  
- –ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
- –û—à–∏–±–∫–∏ –ª–∏–Ω–∫–æ–≤–∫–∏
- "Undefined reference" –æ—à–∏–±–∫–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**

`node_ph/main/CMakeLists.txt`:
```cmake
REQUIRES 
    freertos
    esp_wifi
    nvs_flash
    driver
    mesh_manager
    mesh_protocol
    node_config
    mesh_config
    ph_sensor         # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    pump_controller   # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    pid_controller    # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    ph_manager        # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
```

`node_ec/main/CMakeLists.txt`:
```cmake
REQUIRES 
    freertos
    esp_wifi
    nvs_flash
    driver
    mesh_manager
    mesh_protocol
    node_config
    mesh_config
    ec_sensor         # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    pump_controller   # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    pid_controller    # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    ec_manager        # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
```

---

### 2. ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç #include <math.h>**

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `fabs()` –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è `<math.h>`.

**–§–∞–π–ª—ã:**
- `node_ph/components/ph_manager/ph_manager.c`
- `node_ec/components/ec_manager/ec_manager.c`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**  
- –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: "implicit declaration of function 'fabs'"

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```c
#include <math.h>  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
```

---

### 3. ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç #include "cJSON.h"**

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–∏ cJSON –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.

**–§–∞–π–ª—ã:**
- `node_ph/components/ph_manager/ph_manager.c`
- `node_ec/components/ec_manager/ec_manager.c`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**  
- –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: "implicit declaration" –¥–ª—è –≤—Å–µ—Ö cJSON —Ñ—É–Ω–∫—Ü–∏–π

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```c
#include "cJSON.h"  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
```

---

### 4. ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ EC manager (3 –Ω–∞—Å–æ—Å–∞)**

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í `ec_manager.c` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –ª–æ–≥–∏–∫–∞ –¥–ª—è 2 –Ω–∞—Å–æ—Å–æ–≤ (UP/DOWN) –≤–º–µ—Å—Ç–æ 3 (A/B/C).

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**  
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –¥–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ
- –¢–æ–ª—å–∫–æ 1 –Ω–∞—Å–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–º–µ—Å—Ç–æ 3
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏–π

**–ë—ã–ª–æ:**
```c
static pid_controller_t s_pid_EC_up;
static pid_controller_t s_pid_EC_down;

// ... –≤ control_EC:
if (s_current_ec < target) {
    pump_controller_run_dose(PUMP_EC_UP, output);  // –¢–æ–ª—å–∫–æ 1 –Ω–∞—Å–æ—Å!
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```c
static pid_controller_t s_pid_ec;  // –û–¥–∏–Ω PID –¥–ª—è –≤—Å–µ—Ö

// ... –≤ control_ec:
if (s_current_ec < s_config->ec_target) {
    float output = pid_compute(&s_pid_ec, s_current_ec, 10.0f);
    
    if (output > 0.1f) {
        // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ 3 –Ω–∞—Å–æ—Å–∞–º:
        float dose_a = output * 0.5f;  // 50%
        float dose_b = output * 0.4f;  // 40%
        float dose_c = output * 0.1f;  // 10%
        
        // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö 3 –Ω–∞—Å–æ—Å–æ–≤
        pump_controller_run_dose(PUMP_EC_A, dose_a);
        vTaskDelay(pdMS_TO_TICKS(100));
        pump_controller_run_dose(PUMP_EC_B, dose_b);
        vTaskDelay(pdMS_TO_TICKS(100));
        pump_controller_run_dose(PUMP_EC_C, dose_c);
    }
}
```

---

### 5. ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (case-sensitivity)**

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í `ec_manager.c` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∏–º–µ–Ω–∞ —Å –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏ `EC_target`, `EC_min` –≤–º–µ—Å—Ç–æ `ec_target`, `ec_min`.

**–§–∞–π–ª:**  
- `node_ec/components/ec_manager/ec_manager.c`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**  
- –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: "structure has no member named 'EC_target'"

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**  
–ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö:
- `EC_target` ‚Üí `ec_target`
- `EC_min` ‚Üí `ec_min`
- `EC_max` ‚Üí `ec_max`
- `EC_cal_offset` ‚Üí `ec_cal_offset`
- `PUMP_EC_UP` ‚Üí `PUMP_EC_A`
- `PUMP_EC_DOWN` ‚Üí `PUMP_EC_B`

---

### 6. ‚ùå **–î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ EC = 7.0 (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)**

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ EC –±—ã–ª–æ 7.0 (–∫–∞–∫ pH), –Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 2.0.

**–ë—ã–ª–æ:**
```c
static float s_current_ec = 7.0f;  // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```c
static float s_current_ec = 2.0f;  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è EC
```

---

### 7. ‚ö†Ô∏è **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TAG (—Å—Ç–∏–ª—å –∫–æ–¥–∞)**

**–ü—Ä–æ–±–ª–µ–º–∞:**  
TAG –≤ ec_manager –±—ã–ª "EC_mgr" –≤–º–µ—Å—Ç–æ "ec_mgr" (–Ω–∞—Ä—É—à–µ–Ω–∏–µ —Å—Ç–∏–ª—è).

**–ë—ã–ª–æ:**
```c
static const char *TAG = "EC_mgr";
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```c
static const char *TAG = "ec_mgr";
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (OK)

### node_ph:
- ‚úÖ `ph_sensor` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- ‚úÖ `pump_controller` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π (2 –Ω–∞—Å–æ—Å–∞)
- ‚úÖ `pid_controller` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- ‚úÖ `ph_manager` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã includes
- ‚úÖ `app_main.c` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

### node_ec:
- ‚úÖ `ec_sensor` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- ‚úÖ `pump_controller` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π (3 –Ω–∞—Å–æ—Å–∞)
- ‚úÖ `pid_controller` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- ‚úÖ `ec_manager` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏ includes
- ‚úÖ `app_main.c` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

### common:
- ‚úÖ `node_config.h` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∏–ø—ã
- ‚úÖ `mesh_manager` - OK
- ‚úÖ `mesh_protocol` - OK

---

## üîç –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ)

### 1. ‚ö†Ô∏è WiFi credentials –≤ sdkconfig.defaults

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è "your_wifi_ssid" –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π.

**–†–µ—à–µ–Ω–∏–µ:**  
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `sdkconfig.defaults` –ø–µ—Ä–µ–¥ –ø—Ä–æ—à–∏–≤–∫–æ–π.

**–§–∞–π–ª—ã:**
- `node_ph/sdkconfig.defaults`
- `node_ec/sdkconfig.defaults`

---

### 2. ‚ö†Ô∏è I2C –∞–¥—Ä–µ—Å–∞ –¥–∞—Ç—á–∏–∫–æ–≤

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**  
–ê–¥—Ä–µ—Å–∞ I2C –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ –¥–∞—Ç—á–∏–∫–æ–≤ Trema.

**–¢–µ–∫—É—â–∏–µ:**
- pH: 0x4D
- EC: 0x64

**–†–µ—à–µ–Ω–∏–µ:**  
–ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∞—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥—Ä–µ—Å–∞ —Å –ø–æ–º–æ—â—å—é I2C —Å–∫–∞–Ω–µ—Ä–∞.

---

### 3. ‚ö†Ô∏è –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–æ–≤

**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**  
–î–µ—Ñ–æ–ª—Ç–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å–æ—Å–æ–≤: 2.0 –º–ª/—Å–µ–∫

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–ü—Ä–æ–≤–µ—Å—Ç–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –Ω–∞—Å–æ—Å–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –¥–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è:
```c
pump_controller_set_calibration(PUMP_PH_UP, actual_ml_per_sec);
```

---

### 4. ‚ö†Ô∏è ESP32-C3 GPIO –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**  
ESP32-C3 –∏–º–µ–µ—Ç –º–µ–Ω—å—à–µ GPIO —á–µ–º ESP32-S3.

**–¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- **node_ph**: GPIO 2,3,4,5,8,9 (6 –ø–∏–Ω–æ–≤) ‚úÖ
- **node_ec**: GPIO 2,3,4,5,6,8,9 (7 –ø–∏–Ω–æ–≤) ‚úÖ

–í—Å–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π ESP32-C3. ‚úÖ

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ |
|-----------|-----------|
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ | 5 |
| –°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ | 2 |
| –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã | 4 |
| **–í—Å–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** | **7** |

---

## ‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–±–Ω—É—é —Å–±–æ—Ä–∫—É:

```bash
# node_ph
cd node_ph
idf.py set-target esp32c3
idf.py build

# node_ec
cd node_ec
idf.py set-target esp32c3
idf.py build
```

–û–∂–∏–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫.

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã  
‚úÖ –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏  
‚úÖ –õ–æ–≥–∏–∫–∞ PID –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞  
‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–≤ EC –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ  
‚úÖ Includes –¥–æ–±–∞–≤–ª–µ–Ω—ã  
‚úÖ CMakeLists –æ–±–Ω–æ–≤–ª–µ–Ω—ã  

**–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Å–±–æ—Ä–∫–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

