# üî• –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Windows Firewall –¥–ª—è MQTT

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

ESP32 ROOT —É–∑–µ–ª –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MQTT –±—Ä–æ–∫–µ—Ä—É:
```
E (12471) esp-tls: [sock=54] select() timeout
E (12472) transport_base: Failed to open a new connection
```

**–ü—Ä–∏—á–∏–Ω–∞:** Windows Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç 1883

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: PowerShell (–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

–û—Ç–∫—Ä–æ–π—Ç–µ **PowerShell –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```powershell
New-NetFirewallRule -DisplayName "MQTT Broker 1883" -Direction Inbound -Protocol TCP -LocalPort 1883 -Action Allow
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

–û—Ç–∫—Ä–æ–π—Ç–µ **cmd –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```cmd
netsh advfirewall firewall add rule name="MQTT Broker 1883" dir=in action=allow protocol=TCP localport=1883
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

1. –û—Ç–∫—Ä–æ–π—Ç–µ **–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** ‚Üí **–°–∏—Å—Ç–µ–º–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Üí **–ë—Ä–∞–Ω–¥–º–∞—É—ç—Ä Windows**
2. –ù–∞–∂–º–∏—Ç–µ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (—Å–ª–µ–≤–∞)
3. –í—ã–±–µ—Ä–∏—Ç–µ **–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π**
4. –ù–∞–∂–º–∏—Ç–µ **–°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ** (—Å–ø—Ä–∞–≤–∞)
5. –í—ã–±–µ—Ä–∏—Ç–µ **–î–ª—è –ø–æ—Ä—Ç–∞** ‚Üí **–î–∞–ª–µ–µ**
6. –í—ã–±–µ—Ä–∏—Ç–µ **TCP** –∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ—Ä—Ç **1883** ‚Üí **–î–∞–ª–µ–µ**
7. –í—ã–±–µ—Ä–∏—Ç–µ **–†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** ‚Üí **–î–∞–ª–µ–µ**
8. –û—Å—Ç–∞–≤—å—Ç–µ –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º–∏ ‚Üí **–î–∞–ª–µ–µ**
9. –ò–º—è: `MQTT Broker 1883` ‚Üí **–ì–æ—Ç–æ–≤–æ**

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Ñ–∞–π—Ä–≤–æ–ª–ª–∞:
```powershell
Get-NetFirewallRule -DisplayName "MQTT*" | Format-Table DisplayName, Enabled, Direction, Action
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞:
```powershell
Test-NetConnection -ComputerName 192.168.0.167 -Port 1883
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `TcpTestSucceeded : True`

### 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ESP32:
```bash
# –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É RESET –Ω–∞ –ø–ª–∞—Ç–µ –∏–ª–∏:
idf.py monitor
# –ù–∞–∂–º–∏—Ç–µ Ctrl+]
# –ù–∞–∂–º–∏—Ç–µ EN –∫–Ω–æ–ø–∫—É –Ω–∞ ESP32
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –≤ –ª–æ–≥–∞—Ö ESP32 –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:

```
I (2467) mqtt_manager: Connecting to broker: mqtt://192.168.0.167:1883
I (2500) mqtt_manager: ‚úÖ MQTT connected to broker
I (2505) mqtt_manager: ‚úÖ Subscribed to hydro/command/#
I (2510) mqtt_manager: ‚úÖ Subscribed to hydro/config/#
```

---

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ MQTT –±—Ä–æ–∫–µ—Ä–∞:
```bash
docker logs hydro_mosquitto --tail 20 -f
```

–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ESP32 –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏:
```
New connection from 192.168.0.104:XXXXX on port 1883
New client connected from 192.168.0.104 as root_001
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ MQTT Listener:
```bash
docker logs hydro_mqtt_listener -f
```

–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
üì° New message from hydro/discovery
‚úÖ Node registered: root_001
```

---

## ‚ö†Ô∏è –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç–µ–≤—É—é —Å–≤—è–∑–Ω–æ—Å—Ç—å:
–ù–∞ ESP32 –¥–æ–±–∞–≤—å—Ç–µ ping —Ç–µ—Å—Ç–∞ –∫ —Ö–æ—Å—Ç—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Docker –º–∞–ø–ø–∏–Ω–≥ –ø–æ—Ä—Ç–æ–≤:
```bash
docker port hydro_mosquitto
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
1883/tcp -> 0.0.0.0:1883
```

### 3. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∞–π—Ä–≤–æ–ª–ª (–¥–ª—è —Ç–µ—Å—Ç–∞):
```powershell
# –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ! –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∞!
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ:
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
```

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Ñ–∞–π—Ä–≤–æ–ª–ª–∞ ESP32 –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è - –ø—Ä–æ–±–ª–µ–º–∞ —Ç–æ—á–Ω–æ –≤ —Ñ–∞–π—Ä–≤–æ–ª–ª–µ.

---

## üìù –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Ä—Ç 1883 –ø–æ–ª–Ω–æ—Å—Ç—å—é, –º–æ–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏:

```powershell
New-NetFirewallRule -DisplayName "MQTT Local Network" `
    -Direction Inbound `
    -Protocol TCP `
    -LocalPort 1883 `
    -Action Allow `
    -RemoteAddress 192.168.0.0/24
```

–≠—Ç–æ —Ä–∞–∑—Ä–µ—à–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–∑ —Å–µ—Ç–∏ `192.168.0.*`

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Ñ–∞–π—Ä–≤–æ–ª–ª–∞ –¥–ª—è –ø–æ—Ä—Ç–∞ 1883
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ —Å —Ö–æ—Å—Ç–∞
- [ ] –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ESP32 ROOT —É–∑–µ–ª
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏–µ —É–∑–ª–∞ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

---

**–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ESP32 –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MQTT –±—Ä–æ–∫–µ—Ä—É! üéâ

