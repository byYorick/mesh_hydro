# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–î–∞—Ç–∞:** 22 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** ROOT —É–∑–µ–ª –Ω–µ –º–æ–≥ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MQTT –±—Ä–æ–∫–µ—Ä—É

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã:
```
E (12479) esp-tls: [sock=54] select() timeout
E (12480) transport_base: Failed to open a new connection: 32774
E (12480) mqtt_client: Error transport connect
W (12494) mqtt_manager: MQTT disconnected from broker
```

### –ü—Ä–∏—á–∏–Ω–∞:
ROOT —É–∑–µ–ª –ø—ã—Ç–∞–ª—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ **—Å—Ç–∞—Ä–æ–º—É IP –∞–¥—Ä–µ—Å—É** MQTT –±—Ä–æ–∫–µ—Ä–∞:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| ‚ùå –°—Ç–∞—Ä—ã–π –∞–¥—Ä–µ—Å | `192.168.1.100:1883` |
| ‚úÖ –¢–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å | `192.168.0.167:1883` |
| üì° ROOT —É–∑–µ–ª IP | `192.168.0.104` |

### –õ–æ–≥–∏ –ø–æ–∫–∞–∑–∞–ª–∏:
```
I (2467) mqtt_manager: Connecting to broker: mqtt://192.168.1.100:1883  ‚ùå
I (2554) ROOT: MQTT Broker: mqtt://192.168.0.167:1883                   ‚úÖ
```

**–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** –í —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Ä–∞–∑–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞!

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ù–∞–π–¥–µ–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã
–§–∞–π–ª: `root_node/components/mqtt_client/mqtt_client_manager.c`

**–ë—ã–ª–æ:**
```c
// MQTT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (TODO: –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ sdkconfig)
#define MQTT_BROKER_URI         "mqtt://192.168.1.100:1883"  // ‚ùå –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω —Å—Ç–∞—Ä—ã–π IP
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
**–°—Ç–∞–ª–æ:**
```c
#include "mesh_config.h"  // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω include

// MQTT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ mesh_config.h
// MQTT_BROKER_URI —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ mesh_config.h: "mqtt://192.168.0.167:1883"
// (—É–¥–∞–ª—ë–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π define)
```

### 3. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–§–∞–π–ª: `common/mesh_config/mesh_config.h`

```c
/**
 * @brief IP –∞–¥—Ä–µ—Å –∏–ª–∏ hostname MQTT –±—Ä–æ–∫–µ—Ä–∞
 */
#define MQTT_BROKER_HOST        "192.168.0.167"

/**
 * @brief –ü–æ—Ä—Ç MQTT –±—Ä–æ–∫–µ—Ä–∞
 */
#define MQTT_BROKER_PORT        1883

/**
 * @brief –ü–æ–ª–Ω—ã–π URI MQTT –±—Ä–æ–∫–µ—Ä–∞
 */
#define MQTT_BROKER_URI         "mqtt://192.168.0.167:1883"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –í—Å–µ —É–∑–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∞–¥—Ä–µ—Å
- ‚úÖ –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö —É–∑–ª–æ–≤ —Å—Ä–∞–∑—É

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- `root_node/README.md` - –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ `192.168.0.167`
- –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ mosquitto_sub/mosquitto_pub

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MQTT –±—Ä–æ–∫–µ—Ä–∞:
```yaml
# server/mosquitto/config/mosquitto.conf
listener 1883 0.0.0.0        ‚úÖ –°–ª—É—à–∞–µ—Ç –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
allow_anonymous true          ‚úÖ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
```powershell
Test-NetConnection -ComputerName 192.168.0.167 -Port 1883
# TcpTestSucceeded: True ‚úÖ
```

---

## üöÄ –î–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏
```bash
cd root_node
idf.py build
```

### 2. –ü—Ä–æ—à–∏–≤–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
```bash
idf.py flash monitor
```

### 3. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```
I (2467) mqtt_manager: Connecting to broker: mqtt://192.168.0.167:1883
I (2500) mqtt_manager: ‚úÖ MQTT connected to broker
I (2505) mqtt_manager: ‚úÖ Subscribed to hydro/command/#
I (2510) mqtt_manager: ‚úÖ Subscribed to hydro/config/#
```

---

## üìä –¢–µ–∫—É—â–∞—è —Å–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ | IP –∞–¥—Ä–µ—Å | –†–æ–ª—å |
|------------|----------|------|
| –•–æ—Å—Ç (Docker) | `192.168.0.167` | MQTT Broker, Backend, Frontend |
| ROOT —É–∑–µ–ª | `192.168.0.104` | ESP32-S3 ROOT —É–∑–µ–ª |
| Gateway | `192.168.0.1` | –†–æ—É—Ç–µ—Ä |
| Subnet | `255.255.255.0` | –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å |

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
```
MQTT Broker:  mqtt://192.168.0.167:1883  ‚úÖ
Backend API:  http://192.168.0.167:8000  ‚úÖ
Frontend:     http://192.168.0.167:3000  ‚úÖ
WebSocket:    ws://192.168.0.167:8080    ‚úÖ
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –Ω–∞ –±—É–¥—É—â–µ–µ

### –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ IP –∞–¥—Ä–µ—Å–∞ —Ö–æ—Å—Ç–∞:

**1. –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª:**
```c
// common/mesh_config/mesh_config.h
#define MQTT_BROKER_HOST        "–ù–û–í–´–ô_IP"
#define MQTT_BROKER_URI         "mqtt://–ù–û–í–´–ô_IP:1883"
```

**2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –í–°–ï —É–∑–ª—ã:**
```bash
cd root_node && idf.py build
cd node_climate && idf.py build
cd node_ph_ec && idf.py build
# –∏ —Ç.–¥.
```

**3. –ü—Ä–æ—à–∏—Ç—å –≤—Å–µ —É–∑–ª—ã:**
```bash
idf.py flash
```

### –ù–ï –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–∏–≤–∞—Ç—å IP –∞–¥—Ä–µ—Å–∞ –≤ –∫–æ–¥–µ!
‚ùå **–ü–ª–æ—Ö–æ:**
```c
#define MQTT_BROKER_URI "mqtt://192.168.1.100:1883"  // –í –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```c
#include "mesh_config.h"  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MQTT_BROKER_URI –∏–∑ –æ–±—â–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
```

---

## üîç –ö–∞–∫ –Ω–∞–π—Ç–∏ IP –∞–¥—Ä–µ—Å —Ö–æ—Å—Ç–∞

### Windows:
```bash
ipconfig | findstr IPv4
```

### Linux/Mac:
```bash
ifconfig | grep "inet "
hostname -I
```

### –í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:
```bash
docker exec hydro_backend hostname -I
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ ROOT —É–∑–ª–∞:
```bash
idf.py monitor
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
‚úÖ MQTT connected to broker
‚úÖ Subscribed to hydro/command/#
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ MQTT –±—Ä–æ–∫–µ—Ä–∞:
```bash
docker logs hydro_mqtt_listener -f
```

–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
üì° New message from hydro/discovery
‚úÖ Node registered: root_001
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:
```
http://192.168.0.167:3000
```

–£–∑–µ–ª –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ –∏ –±—ã—Ç—å **Online** ‚úÖ

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**  
**–ü—Ä–æ—à–∏–≤–∫–∞:** üîÑ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...

