# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∞–π–º–∏–Ω–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã Mesh Hydro

## üìä –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### pH Node (`node_ph`)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –§–∞–π–ª | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|----------|------|-------------|
| **–ß—Ç–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞** | 10 —Å–µ–∫ | `ph_manager.c:175` | –ß—Ç–µ–Ω–∏–µ pH –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |
| **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏** | 30 —Å–µ–∫ | `ph_manager.c:187` | ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∂–∏–∑–Ω–∏ |
| **Heartbeat** | 15 —Å–µ–∫ | `ph_manager.c:201` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å 60‚Üí15 —Å–µ–∫ |
| **Main loop delay** | 1 —Å–µ–∫ | `ph_manager.c:192` | CPU –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω |

### Root Node

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –§–∞–π–ª | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|----------|------|-------------|
| **Node timeout** | 40 —Å–µ–∫ | `node_registry.h:22` | ‚úÖ –ë–æ–ª—å—à–µ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ |
| **Check interval** | ~5 —Å–µ–∫ | `node_registry.c` | –ü—Ä–æ–≤–µ—Ä–∫–∞ offline —É–∑–ª–æ–≤ |

### Backend (`server/backend`)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –§–∞–π–ª | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|----------|------|-------------|
| **Node offline timeout** | 45 —Å–µ–∫ | `config/hydro.php` | ‚úÖ –ë–æ–ª—å—à–µ root timeout |

---

## üîÑ –¶–µ–ø–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

```
pH Node         Root Node       Backend
   |               |               |
   |-- Telemetry --|               |
   |    (30 —Å–µ–∫)   |               |
   |               |               |
   |-- Heartbeat --|               |
   |    (15 —Å–µ–∫)   |               |
   |               |               |
   |               |-- MQTT ------->|
   |               |    (instant)  |
   |               |               |
   |               |-- Check ------|
   |               | (–µ—Å–ª–∏ >40 —Å–µ–∫)|
   |               | ‚Üí OFFLINE     |
   |               |               |
   |               |               |-- Check ---|
   |               |               | (–µ—Å–ª–∏ >45 —Å–µ–∫)
   |               |               | ‚Üí OFFLINE
```

---

## ‚è±Ô∏è –†–∞—Å—á–µ—Ç —Ç–∞–π–º–∏–Ω–≥–æ–≤

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã:

**–ß—Ç–æ–±—ã —É–∑–µ–ª –Ω–µ —É—Ö–æ–¥–∏–ª –≤ offline, –Ω—É–∂–Ω–æ:**

```
heartbeat_interval < node_timeout < backend_timeout
```

### –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–ò–°–ü–†–ê–í–õ–ï–ù–û):

```
15 —Å–µ–∫ < 40 —Å–µ–∫ < 45 —Å–µ–∫  ‚úÖ
```

**Margin of safety:**
- Root node: **40 - 15 = 25 —Å–µ–∫—É–Ω–¥** –∑–∞–ø–∞—Å–∞
- Backend: **45 - 40 = 5 —Å–µ–∫—É–Ω–¥** –∑–∞–ø–∞—Å–∞

### –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–ü–†–û–ë–õ–ï–ú–ê):

```
60 —Å–µ–∫ > 40 —Å–µ–∫  ‚ùå TIMEOUT!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Heartbeat –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è —Ä–∞–∑ –≤ **60 —Å–µ–∫—É–Ω–¥**, –∞ Root –∂–¥–∞–ª —Ç–æ–ª—å–∫–æ **40 —Å–µ–∫—É–Ω–¥**.

---

## üö® –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ TIMEOUT

### –ï—Å–ª–∏ —É–∑–µ–ª —É—Ö–æ–¥–∏—Ç –≤ OFFLINE:

**1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ pH –Ω–æ–¥—ã:**
```
I (XXX) ph_manager: ‚úÖ Telemetry sent: pH=7.00, autonomous=1
I (XXX) ph_manager: üíì Heartbeat sent
```

**2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Root –Ω–æ–¥—ã:**
```
I (XXX) data_router: üìä Telemetry from ph_3f0c00 ‚Üí MQTT
I (XXX) node_registry: Node ph_3f0c00 is now ONLINE
```

**3. –ï—Å–ª–∏ Root –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç TIMEOUT:**
```
W (XXX) node_registry: Node ph_3f0c00 TIMEOUT -> OFFLINE (elapsed: 23667 ms)
```

**–ü—Ä–∏—á–∏–Ω—ã:**
- ‚ùå pH –Ω–æ–¥–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ mesh
- ‚ùå pH –Ω–æ–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat/telemetry
- ‚ùå Root –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–ø—Ä–æ–±–ª–µ–º–∞ mesh)
- ‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª heartbeat > node_timeout

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã:

| –£–∑–µ–ª | Heartbeat | Telemetry | Timeout |
|------|-----------|-----------|---------|
| **pH node** | **15 —Å–µ–∫** | **30 —Å–µ–∫** | - |
| **EC node** | **15 —Å–µ–∫** | **30 —Å–µ–∫** | - |
| **Climate node** | **15 —Å–µ–∫** | **30 —Å–µ–∫** | - |
| **Water node** | **15 —Å–µ–∫** | **30 —Å–µ–∫** | - |
| **Root node** | - | - | **40 —Å–µ–∫** |
| **Backend** | - | - | **45 —Å–µ–∫** |

### –ü—Ä–∞–≤–∏–ª–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```
heartbeat_interval = node_timeout / 2.5
```

**–ü—Ä–∏–º–µ—Ä:**
- Node timeout = 40 —Å–µ–∫
- Heartbeat = 40 / 2.5 = **16 —Å–µ–∫** ‚âà **15 —Å–µ–∫** ‚úÖ

**–ü–æ—á–µ–º—É –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 2.5?**
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç **–º–∏–Ω–∏–º—É–º 2 –ø–æ–ø—ã—Ç–∫–∏** –æ—Ç–ø—Ä–∞–≤–∫–∏ heartbeat –¥–æ timeout
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ mesh —Å–µ—Ç–∏
- –ó–∞–ø–∞—Å –Ω–∞ –¥–∂–∏—Ç—Ç–µ—Ä –∏ –ø–æ—Ç–µ—Ä–∏ –ø–∞–∫–µ—Ç–æ–≤

---

## üìà –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É

### –î–ª—è production:

**–ï—Å–ª–∏ mesh —Å—Ç–∞–±–∏–ª—å–Ω–∞:**
```
Heartbeat: 20 —Å–µ–∫
Telemetry: 30 —Å–µ–∫
Timeout: 50 —Å–µ–∫
Backend: 60 —Å–µ–∫
```

**–ï—Å–ª–∏ mesh –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞:**
```
Heartbeat: 10 —Å–µ–∫  ‚Üê –±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
Telemetry: 20 —Å–µ–∫
Timeout: 30 —Å–µ–∫
Backend: 35 —Å–µ–∫
```

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å:**
- ‚Üì –ò–Ω—Ç–µ—Ä–≤–∞–ª heartbeat = ‚Üë –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –Ω–æ ‚Üë –¢—Ä–∞—Ñ–∏–∫ mesh
- ‚Üë –ò–Ω—Ç–µ—Ä–≤–∞–ª heartbeat = ‚Üì –¢—Ä–∞—Ñ–∏–∫, –Ω–æ ‚Üì –°–∫–æ—Ä–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è offline

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º–∏–Ω–≥–æ–≤

### –¢–µ—Å—Ç 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ pH –Ω–æ–¥—É
2. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ Root:
```
I (XXX) node_registry: Node ph_3f0c00 is now ONLINE
```
3. –ñ–¥–∏—Ç–µ 20 —Å–µ–∫—É–Ω–¥
4. –î–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ heartbeat:
```
I (XXX) data_router: üíì Heartbeat from ph_3f0c00 ‚Üí MQTT
```
5. ‚úÖ –£–∑–µ–ª –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è ONLINE

---

### –¢–µ—Å—Ç 2: –ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ pH –Ω–æ–¥—É
2. –û—Ç–∫–ª—é—á–∏—Ç–µ –µ—ë (–≤—ã–¥–µ—Ä–Ω–∏—Ç–µ USB)
3. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ Root:
```
W (XXX) node_registry: Node ph_3f0c00 TIMEOUT -> OFFLINE (elapsed: 40XXX ms)
```
4. ‚úÖ Timeout –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —á–µ—Ä–µ–∑ **~40-45 —Å–µ–∫—É–Ω–¥**

---

### –¢–µ—Å—Ç 3: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏

1. –ü–æ—Å–ª–µ –¢–µ—Å—Ç–∞ 2
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ pH –Ω–æ–¥—É –æ–±—Ä–∞—Ç–Ω–æ
3. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ Root:
```
I (XXX) node_registry: Node ph_3f0c00 is now ONLINE
```
4. ‚úÖ –£–∑–µ–ª –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ ONLINE —á–µ—Ä–µ–∑ **~15-30 —Å–µ–∫—É–Ω–¥**

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2025-10-28: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ heartbeat –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
W (196065370) node_registry: Node ph_3f0c00 TIMEOUT -> OFFLINE (elapsed: 23667 ms)
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- Heartbeat –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è —Ä–∞–∑ –≤ **60 —Å–µ–∫—É–Ω–¥**
- Root timeout –±—ã–ª **40 —Å–µ–∫—É–Ω–¥**
- **60 > 40** ‚Üí TIMEOUT!

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –ò–∑–º–µ–Ω–∏–ª heartbeat —Å **60 —Å–µ–∫ ‚Üí 15 —Å–µ–∫**
- ‚úÖ –¢–µ–ø–µ—Ä—å **15 < 40** ‚Üí –†–∞–±–æ—Ç–∞–µ—Ç!

**–§–∞–π–ª—ã:**
- `node_ph/components/ph_manager/ph_manager.c:201`

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –≤—Å–µ—Ö –Ω–æ–¥:

1. **Heartbeat –∏–Ω—Ç–µ—Ä–≤–∞–ª:** **15 —Å–µ–∫—É–Ω–¥** (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
2. **Telemetry –∏–Ω—Ç–µ—Ä–≤–∞–ª:** **30 —Å–µ–∫—É–Ω–¥** (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
3. **Root node timeout:** **40 —Å–µ–∫—É–Ω–¥** (–ø—Ä–æ–≤–µ—Ä–∫–∞ offline)
4. **Backend timeout:** **45 —Å–µ–∫—É–Ω–¥** (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏:
- –í—Ä–µ–º—è –º–µ–∂–¥—É heartbeat'–∞–º–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö heartbeat'–æ–≤
- –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ mesh —Å–µ—Ç–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ false-positive offline

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [ ] Heartbeat interval < Node timeout
- [ ] Node timeout < Backend timeout
- [ ] –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–ø–∞—Å–∞ ‚â• 2.0
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ offline detection
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ recovery
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ heartbeat'—ã
- [ ] –£–∑–ª—ã –Ω–µ —É—Ö–æ–¥—è—Ç –≤ OFFLINE –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `node_ph/components/ph_manager/ph_manager.c` - —Ç–∞–π–º–µ—Ä—ã pH –Ω–æ–¥—ã
- `root_node/components/node_registry/node_registry.h` - timeout root
- `server/backend/config/hydro.php` - timeout backend
- `TROUBLESHOOTING_CONFIG.md` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º


