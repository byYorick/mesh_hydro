# üéÆ –†–£–ß–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–°–û–°–ê–ú–ò –ò –ö–ê–õ–ò–ë–†–û–í–ö–ê

## ‚úÖ –ß–¢–û –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

### 1. **–°—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** ‚úÖ
- `pump_calibration_t` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –Ω–∞—Å–æ—Å–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `ph_node_config_t` (2 –Ω–∞—Å–æ—Å–∞)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `ec_node_config_t` (3 –Ω–∞—Å–æ—Å–∞)

```c
typedef struct {
    float ml_per_second;           // –ú–∏–ª–ª–∏–ª–∏—Ç—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
    uint32_t calibration_time_ms;  // –í—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ (–º—Å)
    float calibration_volume_ml;   // –û–±—ä–µ–º –ø—Ä–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ (–º–ª)
    uint64_t last_calibrated;      // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
    bool is_calibrated;            // –§–ª–∞–≥ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
} pump_calibration_t;
```

### 2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** ‚úÖ
- `node_ph/main/app_main.c` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 2 –Ω–∞—Å–æ—Å–æ–≤ (1 –º–ª/—Å–µ–∫)
- `node_ec/main/app_main.c` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 3 –Ω–∞—Å–æ—Å–æ–≤ (1 –º–ª/—Å–µ–∫)

### 3. **–ö–æ–º–∞–Ω–¥—ã –≤ pH –Ω–æ–¥–µ** ‚úÖ

#### `run_pump_manual` - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –Ω–∞—Å–æ—Å–∞
```json
{
  "type": "command",
  "node_id": "ph_001",
  "command": "run_pump_manual",
  "params": {
    "pump_id": 0,          // 0 = UP, 1 = DOWN
    "duration_sec": 5.0    // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (0.1-30.0)
  }
}
```

#### `calibrate_pump` - –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞
```json
{
  "type": "command",
  "node_id": "ph_001",
  "command": "calibrate_pump",
  "params": {
    "pump_id": 0,           // 0 = UP, 1 = DOWN
    "duration_sec": 10.0,   // –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞
    "volume_ml": 12.5       // –°–∫–æ–ª—å–∫–æ –º–ª –≤—ã—à–ª–æ
  }
}
```

**–ü—Ä–æ—Ü–µ—Å—Å –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–∞—Å–æ—Å –Ω–∞ N —Å–µ–∫—É–Ω–¥
2. –ò–∑–º–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º (–º–ª) —Å –ø–æ–º–æ—â—å—é –º–µ—Ä–Ω–æ–≥–æ —Ü–∏–ª–∏–Ω–¥—Ä–∞
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `calibrate_pump` —Å —ç—Ç–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
4. –ù–æ–¥–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç `ml_per_second = volume_ml / duration_sec`
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ NVS

#### `get_config` - –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```json
{
  "type": "command",
  "node_id": "ph_001",
  "command": "get_config",
  "params": {}
}
```

**–û—Ç–≤–µ—Ç –æ—Ç –Ω–æ–¥—ã:**
```json
{
  "type": "config_response",
  "node_id": "ph_001",
  "config": {
    "node_id": "ph_001",
    "node_type": "ph",
    "zone": "Auto-discovered",
    "ph_target": 6.5,
    "ph_min": 5.5,
    "ph_max": 7.5,
    "ph_cal_offset": 0.0,
    "pumps_calibration": [
      {
        "pump_id": 0,
        "ml_per_second": 1.25,
        "calibration_volume_ml": 12.5,
        "calibration_time_ms": 10000,
        "is_calibrated": true,
        "last_calibrated": 1729500000
      },
      {
        "pump_id": 1,
        "ml_per_second": 1.0,
        "calibration_volume_ml": 10.0,
        "calibration_time_ms": 10000,
        "is_calibrated": false,
        "last_calibrated": 0
      }
    ],
    "pumps_pid": [
      {
        "pump_id": 0,
        "kp": 1.0,
        "ki": 0.05,
        "kd": 0.3,
        "enabled": true
      },
      {
        "pump_id": 1,
        "kp": 1.0,
        "ki": 0.05,
        "kd": 0.3,
        "enabled": true
      }
    ],
    "max_pump_time_ms": 5000,
    "cooldown_ms": 10000,
    "autonomous_enabled": true
  }
}
```

---

## üöß –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨

### 1. **EC –Ω–æ–¥–∞** ‚è≥
–î–æ–±–∞–≤–∏—Ç—å —Ç–µ –∂–µ 3 –∫–æ–º–∞–Ω–¥—ã –≤ `ec_manager.c`:
- `run_pump_manual` (3 –Ω–∞—Å–æ—Å–∞: A=0, B=1, C=2)
- `calibrate_pump`
- `get_config`

### 2. **Backend (Laravel)** ‚è≥
- –û–±–Ω–æ–≤–∏—Ç—å `NodeController` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥:
  - `POST /api/nodes/{nodeId}/pump/run`
  - `POST /api/nodes/{nodeId}/pump/calibrate`
  - `GET /api/nodes/{nodeId}/config`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `pump_calibrations`)

### 3. **Frontend (Vue.js)** ‚è≥
–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `PhNode.vue` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ pH –Ω–æ–¥–æ–π
- `EcNode.vue` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ EC –Ω–æ–¥–æ–π

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª UI:**
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π pH/EC
- –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–∞–º–∏ (–≤—ã–±–æ—Ä –Ω–∞—Å–æ—Å–∞ + –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–æ–≤ (–∑–∞–ø—É—Å–∫ + –≤–≤–æ–¥ –æ–±—ä–µ–º–∞)
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PID –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### 4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚è≥
–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è `pump_calibrations`:
```sql
CREATE TABLE pump_calibrations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    node_id VARCHAR(32),
    pump_id INT,
    ml_per_second FLOAT,
    calibration_volume_ml FLOAT,
    calibration_time_ms INT,
    is_calibrated BOOLEAN,
    calibrated_at TIMESTAMP,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

---

## üìä –¶–ï–ü–û–ß–ö–ê –î–ê–ù–ù–´–•

### **–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–º:**
```
Frontend (UI –∫–Ω–æ–ø–∫–∞ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å–æ—Å 5 —Å–µ–∫")
   ‚Üì
Backend API POST /api/nodes/ph_001/pump/run
   {pump_id: 0, duration_sec: 5.0}
   ‚Üì
MQTT hydro/command/ph_001
   {type: "command", command: "run_pump_manual", params: {...}}
   ‚Üì
ROOT (data_router) ‚Üí –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ Mesh
   ‚Üì
NODE pH (ph_manager_handle_command)
   ‚Üí pump_controller_run(PUMP_PH_UP, 5000ms)
   ‚Üí –ù–∞—Å–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç 5 —Å–µ–∫—É–Ω–¥
```

### **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞:**
```
1. Frontend: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–∞—Å–æ—Å –Ω–∞ 10 —Å–µ–∫
2. Frontend: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ—Ä—è–µ—Ç –æ–±—ä–µ–º = 12.5 –º–ª
3. Frontend: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST /api/nodes/ph_001/pump/calibrate
   {pump_id: 0, duration_sec: 10.0, volume_ml: 12.5}
4. Backend ‚Üí MQTT ‚Üí ROOT ‚Üí NODE
5. NODE: –í—ã—á–∏—Å–ª—è–µ—Ç ml_per_second = 12.5 / 10 = 1.25 –º–ª/—Å–µ–∫
6. NODE: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ NVS
7. Backend: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
8. Frontend: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–û—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–æ"
```

### **–ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```
Frontend: –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
   ‚Üì
Backend: POST /api/nodes/ph_001/config/request
   ‚Üì
MQTT: hydro/command/ph_001
   {type: "command", command: "get_config"}
   ‚Üì
NODE: –°–æ–∑–¥–∞–µ—Ç JSON —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏–∑ NVS
   ‚Üì
NODE: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç config_response ‚Üí ROOT
   ‚Üì
ROOT: –ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –≤ MQTT hydro/config_response/ph_001
   ‚Üì
Backend: MqttService –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç config_response
   ‚Üì
Backend: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫—ç—à/–ë–î
   ‚Üì
Frontend: –ü–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ API
   ‚Üì
Frontend: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤ UI
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ `common/node_config/node_config.h` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `pump_calibration_t`
2. ‚úÖ `node_ph/main/app_main.c` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
3. ‚úÖ `node_ec/main/app_main.c` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
4. ‚úÖ `node_ph/components/ph_manager/ph_manager.c` - –¥–æ–±–∞–≤–ª–µ–Ω—ã 3 –∫–æ–º–∞–Ω–¥—ã
5. ‚è≥ `node_ec/components/ec_manager/ec_manager.c` - –¥–æ–±–∞–≤–∏—Ç—å 3 –∫–æ–º–∞–Ω–¥—ã
6. ‚è≥ Backend - —Å–æ–∑–¥–∞—Ç—å API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
7. ‚è≥ Backend - —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è `pump_calibrations`
8. ‚è≥ Frontend - —Å–æ–∑–¥–∞—Ç—å `PhNode.vue`
9. ‚è≥ Frontend - —Å–æ–∑–¥–∞—Ç—å `EcNode.vue`
10. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∂–µ–ª–µ–∑–µ

---

**–î–∞—Ç–∞:** 21 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ (50% –≥–æ—Ç–æ–≤–æ)

