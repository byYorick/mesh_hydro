# ๐ฏ ะะดะฐะฟัะธะฒะฝัะน PID ะะพะฝััะพะปะปะตั

**ะัะพัะตััะธะพะฝะฐะปัะฝะฐั ัะตะฐะปะธะทะฐัะธั PID ะบะพะฝััะพะปะปะตัะฐ ั ะฐะฒัะพะฟะพะดัััะพะนะบะพะน, ะทะพะฝะธัะพะฒะฐะฝะธะตะผ ะธ safety ะผะตัะฐะฝะธะทะผะฐะผะธ**

---

## ๐ ะัะพะฑะตะฝะฝะพััะธ

### โ ะะตะฐะปะธะทะพะฒะฐะฝะพ:

1. **ะะพะฝะธัะพะฒะฐะฝะธะต (3 ะทะพะฝั ัะฐะฑะพัั)**
   - **DEAD** - ะผัััะฒะฐั ะทะพะฝะฐ (ยฑ0.1-0.2 ะพั target) - ะฝะต ะบะพััะตะบัะธััะตะผ
   - **CLOSE** - ะฑะปะธะทะบะฐั ะทะพะฝะฐ (ยฑ0.3-0.5 ะพั target) - ะบะพะฝัะตัะฒะฐัะธะฒะฝะฐั ะบะพััะตะบัะธั
   - **FAR** - ะดะฐะปัะฝัั ะทะพะฝะฐ (> 0.5 ะพั target) - ะฐะณัะตััะธะฒะฝะฐั ะบะพััะตะบัะธั

2. **ะะดะฐะฟัะธะฒะฝัะต ะบะพัััะธัะธะตะฝัั**
   - ะะฐะทะฝัะต Kp, Ki, Kd ะดะปั ะบะฐะถะดะพะน ะทะพะฝั
   - ะะฒัะพะฟะพะดัััะพะนะบะฐ ะฝะฐ ะพัะฝะพะฒะต ััะตะฝะดะฐ ะพัะธะฑะบะธ
   - ะกะบะพัะพััั ะฐะดะฐะฟัะฐัะธะธ ะฝะฐัััะฐะธะฒะฐะตะผะฐั (0.01-0.2)

3. **Anti-windup**
   - ะฃะผะฝะพะต ะพะณัะฐะฝะธัะตะฝะธะต ะธะฝัะตะณัะฐะปะฐ
   - ะัะตะดะพัะฒัะฐัะตะฝะธะต ะฟะตัะตะฟะพะปะฝะตะฝะธั I-ัะพััะฐะฒะปัััะตะน

4. **Safety ะผะตัะฐะฝะธะทะผั**
   - ะะฐะบัะธะผะฐะปัะฝะฐั ะดะพะทะฐ ะทะฐ ัะฐะท (ะฝะฐะฟัะธะผะตั 5 ะผะป)
   - ะะธะฝะธะผะฐะปัะฝัะน ะธะฝัะตัะฒะฐะป ะผะตะถะดั ะดะพะทะฐะผะธ (ะฝะฐะฟัะธะผะตั 60 ัะตะบ)
   - Emergency stop ัะตะถะธะผ

5. **ะกัะฐัะธััะธะบะฐ**
   - ะะพะปะธัะตััะฒะพ ะบะพััะตะบัะธะน
   - ะกัะผะผะฐัะฝัะน ะฒััะพะด
   - ะะฐะบัะธะผะฐะปัะฝะฐั/ััะตะดะฝัั ะพัะธะฑะบะฐ
   - ะัะตะผั ะฒ ะบะฐะถะดะพะน ะทะพะฝะต

---

## ๐ ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั?

### ะะพะฝั ัะฐะฑะพัั:

```
pH = 7.0 (target)

โโโ DEAD ZONE โโโ
โโโโโโโโโโโโโโโโโค
6.9 โ โ 7.1     (ยฑ0.1)  โ ะะต ะบะพััะตะบัะธััะตะผ

โโโ CLOSE ZONE โโโ
โโโโโโโโโโโโโโโโโโค
6.7 โ โ 7.3      (ยฑ0.3)  ๐ก ะะพะฝัะตัะฒะฐัะธะฒะฝะพ: Kp=0.5, Ki=0.01, Kd=0.1

โโโ FAR ZONE โโโ
โโโโโโโโโโโโโโโโค
<6.7 ะธะปะธ >7.3    (ยฑ1.0+)  ๐ด ะะณัะตััะธะฒะฝะพ: Kp=1.0, Ki=0.015, Kd=0.05
```

### ะัะธะผะตั ะบะพััะตะบัะธะธ:

```c
// pH = 6.5 (target = 7.0, error = -0.5)
// ะะพะฝะฐ: FAR (ัะฐะบ ะบะฐะบ error > 0.3)

// ะัะฟะพะปัะทััััั ะฐะณัะตััะธะฒะฝัะต ะบะพัััะธัะธะตะฝัั:
Kp = 1.0, Ki = 0.015, Kd = 0.05

// PID ัะฐััะตั:
P_term = 1.0 * (-0.5) = -0.5
I_term = 0.015 * integral = 0.02
D_term = 0.05 * derivative = 0.03

Output = -0.5 + 0.02 + 0.03 = -0.45 ml  (ะพััะธัะฐัะตะปัะฝะพ = pH DOWN ะฝะต ะฝัะถะตะฝ)

// ะะปั pH UP:
Output_UP = 0.45 ml  (ะธะฝะฒะตััะธััะตะผ ะดะปั pH UP)

// ะัะพะฒะตัะบะฐ safety:
- Output_UP < max_dose (5.0 ml) โ
- Interval > min_interval (60 ัะตะบ) โ

// ะะฐะฟััะบ ะฝะฐัะพัะฐ:
pump_controller_run_dose(PUMP_PH_UP, 0.45);
```

---

## ๐ง ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### 1. ะะฝะธัะธะฐะปะธะทะฐัะธั:

```c
#include "adaptive_pid.h"

adaptive_pid_t pid_ph_up;

// ะะฝะธัะธะฐะปะธะทะฐัะธั ั ะฑะฐะทะพะฒัะผะธ ะบะพัััะธัะธะตะฝัะฐะผะธ (ะดะปั CLOSE ะทะพะฝั)
adaptive_pid_init(&pid_ph_up, 
                 7.0f,      // setpoint (target)
                 0.5f,      // Kp
                 0.01f,     // Ki
                 0.1f);     // Kd

// ะะฐัััะพะนะบะฐ ะทะพะฝ (ะดะปั pH)
adaptive_pid_set_zones(&pid_ph_up, 
                      0.1f,   // dead_zone
                      0.3f,   // close_zone
                      1.0f);  // far_zone

// Safety ะฟะฐัะฐะผะตััั
adaptive_pid_set_safety(&pid_ph_up, 
                       5.0f,    // max_dose_ml
                       60000);  // min_interval_ms (1 ะผะธะฝััะฐ)

// ะะธะผะธัั ะฒััะพะดะฐ
adaptive_pid_set_output_limits(&pid_ph_up, 0.0f, 5.0f);
```

### 2. ะะฐัััะพะนะบะฐ ะบะพัััะธัะธะตะฝัะพะฒ ะดะปั ะทะพะฝ:

```c
// FAR ะทะพะฝะฐ - ะฐะณัะตััะธะฒะฝัะต ะบะพัััะธัะธะตะฝัั
adaptive_pid_set_zone_coeffs(&pid_ph_up, ZONE_FAR,
                             1.0f,    // Kp (x2 ะพั CLOSE)
                             0.015f,  // Ki (x1.5 ะพั CLOSE)
                             0.05f);  // Kd (x0.5 ะพั CLOSE)

// CLOSE ะทะพะฝะฐ ัะถะต ัััะฐะฝะพะฒะปะตะฝะฐ ะฟัะธ init()

// DEAD ะทะพะฝะฐ - ะฝัะปะตะฒัะต ะบะพัััะธัะธะตะฝัั (ะฝะต ะบะพััะตะบัะธััะตะผ)
adaptive_pid_set_zone_coeffs(&pid_ph_up, ZONE_DEAD,
                             0.0f, 0.0f, 0.0f);
```

### 3. ะะฐััะตั PID (ะบะฐะถะดัะต 10 ัะตะบัะฝะด):

```c
float current_ph = 6.5f;  // ะขะตะบััะตะต ะทะฝะฐัะตะฝะธะต ั ะดะฐััะธะบะฐ
float output_ml = 0.0f;

esp_err_t err = adaptive_pid_compute(&pid_ph_up, 
                                    current_ph,  // ะขะตะบััะตะต ะทะฝะฐัะตะฝะธะต
                                    10.0f,       // dt (ัะตะบัะฝะดั)
                                    &output_ml); // ะััะพะด (ะผะป)

if (err == ESP_OK && output_ml > 0.0f) {
    // ะะพะปััะตะฝะธะต ัะตะบััะตะน ะทะพะฝั ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั
    pid_zone_t zone = adaptive_pid_get_zone(&pid_ph_up);
    
    ESP_LOGI(TAG, "pH UP: %.2f ml [%s zone]", 
             output_ml, adaptive_pid_zone_to_str(zone));
    
    // ะะฐะฟััะบ ะฝะฐัะพัะฐ
    pump_controller_run_dose(PUMP_PH_UP, output_ml);
}
```

### 4. ะะฒัะพะฟะพะดัััะพะนะบะฐ:

```c
// ะะบะปััะตะฝะธะต auto-tuning
adaptive_pid_set_auto_tune(&pid_ph_up, 
                          true,    // enable
                          0.05f);  // adaptation_rate (5% ะทะฐ ะธัะตัะฐัะธั)

// ะะพัััะธัะธะตะฝัั ะฑัะดัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฐะดะฐะฟัะธัะพะฒะฐัััั:
// - ะัะปะธ ะพัะธะฑะบะฐ ัะฐัััั โ ัะฒะตะปะธัะธะฒะฐะตะผ Kp, ัะผะตะฝััะฐะตะผ Ki
// - ะัะปะธ ะพัะธะฑะบะฐ ัะผะตะฝััะฐะตััั โ ัะผะตะฝััะฐะตะผ Kp, ัะฒะตะปะธัะธะฒะฐะตะผ Ki
```

### 5. ะกัะฐัะธััะธะบะฐ:

```c
const pid_stats_t* stats = adaptive_pid_get_stats(&pid_ph_up);

ESP_LOGI(TAG, "PID Stats:");
ESP_LOGI(TAG, "  Corrections: %lu", stats->corrections_count);
ESP_LOGI(TAG, "  Total output: %.2f ml", stats->total_output);
ESP_LOGI(TAG, "  Max error: %.3f", stats->max_error);
ESP_LOGI(TAG, "  Avg error: %.3f", stats->avg_error);
ESP_LOGI(TAG, "  Time in DEAD: %lu ms", stats->time_in_dead_zone_ms);
ESP_LOGI(TAG, "  Time in CLOSE: %lu ms", stats->time_in_close_zone_ms);
ESP_LOGI(TAG, "  Time in FAR: %lu ms", stats->time_in_far_zone_ms);

// ะกะฑัะพั ััะฐัะธััะธะบะธ
adaptive_pid_reset_stats(&pid_ph_up);
```

### 6. Emergency ัะตะถะธะผ:

```c
// ะะฒะฐัะธะนะฝะฐั ะพััะฐะฝะพะฒะบะฐ
adaptive_pid_emergency_stop(&pid_ph_up);
// ะัะต ะฝะฐัะพัั ะพััะฐะฝะฐะฒะปะธะฒะฐัััั, ะธะฝัะตะณัะฐะป ัะฑัะฐััะฒะฐะตััั

// ะะพะทะพะฑะฝะพะฒะปะตะฝะธะต ัะฐะฑะพัั
adaptive_pid_resume(&pid_ph_up);
```

---

## ๐๏ธ ะะฐัััะพะนะบะฐ ะฟะฐัะฐะผะตััะพะฒ

### ะะปั pH ัะทะปะฐ:

```c
// pH target: 6.0-7.0
// ะะพะฝั:
dead_zone  = 0.1   // ยฑ0.1 (pH 6.9-7.1)
close_zone = 0.3   // ยฑ0.3 (pH 6.7-7.3)
far_zone   = 1.0   // > 0.3

// ะะพัััะธัะธะตะฝัั CLOSE:
Kp = 0.5, Ki = 0.01, Kd = 0.1

// ะะพัััะธัะธะตะฝัั FAR:
Kp = 1.0, Ki = 0.015, Kd = 0.05

// Safety:
max_dose = 5.0 ml
min_interval = 60000 ms (1 ะผะธะฝััะฐ)
```

### ะะปั EC ัะทะปะฐ:

```c
// EC target: 1.5-2.5 mS/cm
// ะะพะฝั:
dead_zone  = 0.2   // ยฑ0.2
close_zone = 0.5   // ยฑ0.5
far_zone   = 1.5   // > 0.5

// ะะพัััะธัะธะตะฝัั CLOSE:
Kp = 0.8, Ki = 0.02, Kd = 0.2

// ะะพัััะธัะธะตะฝัั FAR:
Kp = 1.5, Ki = 0.03, Kd = 0.1

// Safety:
max_dose = 10.0 ml (ัะฐัะฟัะตะดะตะปัะตััั ะฝะฐ 3 ะฝะฐัะพัะฐ)
min_interval = 60000 ms (1 ะผะธะฝััะฐ)
```

---

## ๐ ะัะตะธะผััะตััะฒะฐ ะฝะฐะด ะฟัะพัััะผ PID

| ะคัะฝะบัะธั | ะัะพััะพะน PID | ะะดะฐะฟัะธะฒะฝัะน PID |
|---------|-------------|----------------|
| **ะะพะฝะธัะพะฒะฐะฝะธะต** | โ ะะตั | โ 3 ะทะพะฝั |
| **ะัััะฒะฐั ะทะพะฝะฐ** | โ ะัััะบะพ ะทะฐะดะฐะฝะฝะฐั | โ ะะฐัััะฐะธะฒะฐะตะผะฐั |
| **ะะพัััะธัะธะตะฝัั** | โ๏ธ ะะดะฝะธ ะดะปั ะฒัะตั | โ ะะฐะทะฝัะต ะดะปั ะทะพะฝ |
| **ะะฒัะพะฟะพะดัััะพะนะบะฐ** | โ ะะตั | โ ะััั |
| **Anti-windup** | โ๏ธ ะัะพััะพะน | โ ะฃะผะฝัะน |
| **Safety** | โ ะะตั | โ ะััั |
| **ะกัะฐัะธััะธะบะฐ** | โ ะะตั | โ ะะพะปะฝะฐั |
| **Emergency stop** | โ ะะตั | โ ะััั |

---

## ๐ฌ ะขะตััะธัะพะฒะฐะฝะธะต

### ะขะตัั 1: Dead Zone

```c
// pH = 7.05 (target = 7.0, error = 0.05)
// ะะถะธะดะฐะตััั: output = 0.0 (ะฒ ะผัััะฒะพะน ะทะพะฝะต)

float output = 0.0f;
adaptive_pid_compute(&pid, 7.05f, 10.0f, &output);

assert(output == 0.0f);
assert(adaptive_pid_get_zone(&pid) == ZONE_DEAD);
```

### ะขะตัั 2: Close Zone

```c
// pH = 7.25 (target = 7.0, error = 0.25)
// ะะถะธะดะฐะตััั: output > 0, zone = CLOSE

float output = 0.0f;
adaptive_pid_compute(&pid, 7.25f, 10.0f, &output);

assert(output > 0.0f && output < 1.0f);
assert(adaptive_pid_get_zone(&pid) == ZONE_CLOSE);
```

### ะขะตัั 3: Far Zone

```c
// pH = 7.8 (target = 7.0, error = 0.8)
// ะะถะธะดะฐะตััั: output > 1.0, zone = FAR

float output = 0.0f;
adaptive_pid_compute(&pid, 7.8f, 10.0f, &output);

assert(output > 1.0f);
assert(adaptive_pid_get_zone(&pid) == ZONE_FAR);
```

### ะขะตัั 4: Safety Interval

```c
// ะะฒะต ะดะพะทั ะฟะพะดััะด < min_interval
// ะะถะธะดะฐะตััั: ะฒัะพัะฐั ะดะพะทะฐ ะะ ะฒัะดะฐะฝะฐ

float output1 = 0.0f, output2 = 0.0f;

adaptive_pid_compute(&pid, 6.5f, 10.0f, &output1);
assert(output1 > 0.0f);  // ะะตัะฒะฐั ะดะพะทะฐ ะฒัะดะฐะฝะฐ

vTaskDelay(pdMS_TO_TICKS(1000));  // 1 ัะตะบัะฝะดะฐ (< 60 ัะตะบ)

adaptive_pid_compute(&pid, 6.5f, 10.0f, &output2);
assert(output2 == 0.0f);  // ะัะพัะฐั ะดะพะทะฐ ะะ ะฒัะดะฐะฝะฐ (safety interval)
```

---

## ๐ ะัะธะผะตัะฐะฝะธั

1. **dt (ะฒัะตะผะตะฝะฝะพะน ัะฐะณ)** ะดะพะปะถะตะฝ ะฑััั ะฟะพััะพัะฝะฝัะผ ะดะปั ะบะพััะตะบัะฝะพะน ัะฐะฑะพัั PID
2. **ะะพัััะธัะธะตะฝัั** ะฟะพะดะฑะธัะฐัััั ัะผะฟะธัะธัะตัะบะธ ะดะปั ะบะฐะถะดะพะน ัะธััะตะผั
3. **Auto-tuning** ะผะพะถะตั ะทะฐะฝััั ะฝะตัะบะพะปัะบะพ ัะฐัะพะฒ ะดะปั ััะฐะฑะธะปะธะทะฐัะธะธ
4. **Safety ะธะฝัะตัะฒะฐะป** ะบัะธัะธัะฝะพ ะฒะฐะถะตะฝ ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั overdose
5. **ะกัะฐัะธััะธะบั** ัะตะบะพะผะตะฝะดัะตััั ะปะพะณะธัะพะฒะฐัั ัะฐะท ะฒ ัะฐั ะดะปั ะฐะฝะฐะปะธะทะฐ

---

## ๐ ะะฝัะตะณัะฐัะธั ะฒ node_ph ะธ node_ec

ะะดะฐะฟัะธะฒะฝัะน PID ัะถะต ะธะฝัะตะณัะธัะพะฒะฐะฝ ะฒ:
- โ `node_ph/components/ph_manager/`
- โ `node_ec/components/ec_manager/`

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:** ะะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธ ะทะฐะฟััะบะต ะฝะพะด!

---

**ะะตััะธั:** 1.0  
**ะะฐัะฐ:** 21.10.2025  
**ะะฒัะพั:** Mesh Hydro Team

