# üêõ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò –ù–ê–ô–î–ï–ù–´ –ò –ò–°–ü–†–ê–í–õ–ï–ù–´

## ‚ùå –ë–ê–ì #1: –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ get_config (–ö–†–ò–¢–ò–ß–ù–û!)

### –ü—Ä–æ–±–ª–µ–º–∞:
–í `ph_manager.c` –∏ `ec_manager.c` –≤ –∫–æ–º–∞–Ω–¥–µ `get_config`:

```c
if (mesh_manager_is_connected()) {
    cJSON *root = cJSON_CreateObject();
    cJSON_AddStringToObject(root, "type", "config_response");
    cJSON_AddStringToObject(root, "node_id", s_config->base.node_id);
    cJSON_AddItemToObject(root, "config", config);
    
    char *json_str = cJSON_PrintUnformatted(root);
    if (json_str) {
        mesh_manager_send_to_root((uint8_t *)json_str, strlen(json_str));
        ESP_LOGI(TAG, "Config sent to ROOT (%d bytes)", strlen(json_str));
        free(json_str);
    }
    cJSON_Delete(root);  // ‚úÖ –£–¥–∞–ª—è–µ—Ç—Å—è
} else {
    cJSON_Delete(config);  // ‚ùå root –ù–ï —Å–æ–∑–¥–∞–≤–∞–ª—Å—è, –Ω–æ config –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã!
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ mesh –ù–ï –ø–æ–¥–∫–ª—é—á–µ–Ω, —Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `config`, –Ω–æ –º–∞—Å—Å–∏–≤—ã `pumps_cal` –∏ `pumps_pid` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `config` –∏ –¥–æ–ª–∂–Ω—ã —É–¥–∞–ª–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ `cJSON_Delete(config)`. –ù–æ –µ—Å–ª–∏ `cJSON_CreateObject()` –∏–ª–∏ `cJSON_CreateArray()` –Ω–µ —É–¥–∞–ª–∏—Å—å, –±—É–¥–µ—Ç —É—Ç–µ—á–∫–∞.

**–ï—â–µ —Ö—É–∂–µ:** –ï—Å–ª–∏ `mesh_manager_is_connected()` –≤–µ—Ä–Ω–µ—Ç false, –Ω–æ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º –±—ã–ª–æ –≤—ã–¥–µ–ª–µ–Ω–æ –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏ –ø–æ–¥ JSON, –æ–Ω–∞ –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

### –†–µ—à–µ–Ω–∏–µ:
–í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å `root` –∏ –≤—Å–µ–≥–¥–∞ –µ–≥–æ —É–¥–∞–ª—è—Ç—å –≤ –∫–æ–Ω—Ü–µ.

---

## ‚ùå –ë–ê–ì #2: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ NULL –ø–æ—Å–ª–µ cJSON_CreateObject/Array

–í –æ–±–æ–∏—Ö —Ñ–∞–π–ª–∞—Ö –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫:
```c
cJSON *pumps_cal = cJSON_CreateArray();  // ‚ùå –ß—Ç–æ –µ—Å–ª–∏ –≤–µ—Ä–Ω–µ—Ç NULL?
for (int i = 0; i < 2; i++) {
    cJSON *pump = cJSON_CreateObject();  // ‚ùå –ß—Ç–æ –µ—Å–ª–∏ –≤–µ—Ä–Ω–µ—Ç NULL?
    // ...
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –ø–∞–º—è—Ç—å –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å, `cJSON_CreateObject()` –≤–µ—Ä–Ω–µ—Ç `NULL`, –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –≤—ã–∑–æ–≤—ã –ø—Ä–∏–≤–µ–¥—É—Ç –∫ –∫—Ä–∞—Ö—É.

---

## ‚ùå –ë–ê–ì #3: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ calibrate_pump

```c
s_config->pump_calibration[pump].calibration_time_ms = (uint32_t)(duration * 1000.0f);
```

–ï—Å–ª–∏ `duration_sec = 30.0`, —Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç `30000`, —á—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ù–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥–∞—Å—Ç `duration_sec = 4294967`, —Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç `uint32_t`.

**–•–æ—Ç—è:** –í –∫–æ–¥–µ –µ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—è `duration > 30.0`, –Ω–æ –ª—É—á—à–µ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É.

---

## ‚ùå –ë–ê–ì #4: Race condition –≤ pump calibration

–ï—Å–ª–∏ –¥–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∑–æ–≤—É—Ç `calibrate_pump`, —Ç–æ –≤ –ë–î –±—É–¥–µ—Ç `updateOrCreate`, –Ω–æ –≤ NVS –Ω–∞ –Ω–æ–¥–µ –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –∏ –æ–Ω–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏–ª–∏ –æ—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥.

---

## ‚ùå –ë–ê–ì #5: Backend –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ Node

–í `NodeController::runPump()`:
```php
$node = Node::where('node_id', $nodeId)->firstOrFail();
```

–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ù–æ –µ—Å–ª–∏ —É–∑–µ–ª —É–¥–∞–ª–µ–Ω –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–æ–º–∞–Ω–¥—ã, –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞. –•–æ—Ç—è —ç—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ.

---

## ‚ùå –ë–ê–ì #6: Frontend –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏

–í `PhNode.vue`:
```js
const runPump = async (pumpId) => {
  loading.value = true
  try {
    const response = await axios.post(...)
  } catch (error) {
    toast.error(error.response?.data?.error || 'Failed to start pump')
  } finally {
    loading.value = false
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `error.response` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Ç—å –æ–±–æ—Ä–≤–∞–ª–∞—Å—å), —Ç–æ `error.response?.data?.error` –≤–µ—Ä–Ω–µ—Ç `undefined`, –∏ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ 'Failed to start pump', —á—Ç–æ –û–ö.

–ù–æ –ª—É—á—à–µ –ø–æ–∫–∞–∑–∞—Ç—å `error.message` –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

---

## ‚ùå –ë–ê–ì #7: MqttService –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ JSON –≤ config_response

```php
$data = json_decode($payload, true);

if (!$data || !isset($data['node_id'], $data['config'])) {
    Log::warning("Invalid config_response data", [...]);
    return;
}
```

–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ù–æ –µ—Å–ª–∏ `$data['config']` –Ω–µ –º–∞—Å—Å–∏–≤, –¥–∞–ª—å—à–µ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_array($config)`.

---

## ‚ùå –ë–ê–ì #8: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å

–í Backend:
```php
$mlPerSecond = $validated['volume_ml'] / $validated['duration_sec'];
```

–í–∞–ª–∏–¥–∞—Ü–∏—è –µ—Å—Ç—å (`min:0.1`), —Ç–∞–∫ —á—Ç–æ `duration_sec` –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å 0. ‚úÖ

–ù–æ –≤ Firmware:
```c
s_config->pump_calibration[pump].ml_per_second = volume / duration;
```

–ï—Å–ª–∏ `duration` –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º —Å—Ç–∞–Ω–µ—Ç 0 (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –±–∞–≥–∞ –≤ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON), –±—É–¥–µ—Ç –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `if (duration <= 0.0f) return;` –ø–µ—Ä–µ–¥ –¥–µ–ª–µ–Ω–∏–µ–º.

---

## ‚ùå –ë–ê–ì #9: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç timestamp –≤ config_response JSON

–í firmware –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `config`, –Ω–æ –Ω–µ—Ç `timestamp`:
```c
cJSON_AddStringToObject(root, "type", "config_response");
cJSON_AddStringToObject(root, "node_id", s_config->base.node_id);
cJSON_AddItemToObject(root, "config", config);
// ‚ùå –ù–µ—Ç timestamp!
```

Backend –æ–∂–∏–¥–∞–µ—Ç timestamp –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏.

---

## ‚ùå –ë–ê–ì #10: Frontend –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç node.is_online –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–æ–∫

–í `onMounted()`:
```js
onMounted(() => {
  loadCalibrations()  // ‚ùå –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–æ–¥–∞ offline
})
```

–≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ª—É—á—à–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å.

---

## üõ†Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

–°–µ–π—á–∞—Å –∏—Å–ø—Ä–∞–≤–ª—é –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏!

