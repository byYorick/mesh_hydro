# ðŸ› ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ð± Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð±Ð°Ð³Ð°Ñ… Ð² ph_manager.c

## âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð±Ð°Ð³Ð¸

### 1. **Ð‘Ð°Ð³ Ð² Ð»Ð¾Ð³Ð¸ÐºÐµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð½Ð°ÑÐ¾ÑÐ¾Ð²**

#### ðŸ› **ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:**
```c
// Ð‘Ð«Ð›Ðž (Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾):
else if (strcmp(command, "run_pump") == 0 || strcmp(command, "reset_stats") == 0) {
    ph_manager_handle_pump_command(params);
}
```

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹:**
- ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° `reset_stats` Ð½Ðµ Ð½ÑƒÐ¶Ð½Ñ‹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹, Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ð»Ð¸ÑÑŒ `params`
- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ `ph_manager_handle_pump_command` Ð²ÑÐµÐ³Ð´Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»Ð° `reset_stats`, Ð´Ð°Ð¶Ðµ Ð´Ð»Ñ `run_pump`

#### âœ… **Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:**
```c
// Ð¡Ð¢ÐÐ›Ðž (Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾):
else if (strcmp(command, "run_pump") == 0) {
    ph_manager_handle_pump_command(params);
}
else if (strcmp(command, "reset_stats") == 0) {
    ph_manager_handle_reset_stats_command();
}
```

### 2. **Ð‘Ð°Ð³ Ð² Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ `ph_manager_handle_pump_command`**

#### ðŸ› **ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:**
```c
// Ð‘Ð«Ð›Ðž (Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾):
void ph_manager_handle_pump_command(cJSON *params) {
    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° run_pump
    // ...
    
    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° reset_stats - Ð’Ð¡Ð•Ð“Ð”Ð Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»Ð°ÑÑŒ!
    pump_controller_reset_stats(PUMP_PH_UP);
    pump_controller_reset_stats(PUMP_PH_DOWN);
    ESP_LOGI(TAG, "Pump stats reset");
}
```

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:** Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð²ÑÐµÐ³Ð´Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»Ð° `reset_stats`, Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ Ð¾Ñ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹.

#### âœ… **Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:**
```c
// Ð¡Ð¢ÐÐ›Ðž (Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾):
void ph_manager_handle_pump_command(cJSON *params) {
    cJSON *pump_id = cJSON_GetObjectItem(params, "pump_id");
    cJSON *duration = cJSON_GetObjectItem(params, "duration_ms");
    
    if (cJSON_IsNumber(pump_id) && cJSON_IsNumber(duration)) {
        pump_id_t pump = (pump_id_t)pump_id->valueint;
        uint32_t dur = (uint32_t)duration->valueint;
        
        if (pump < PUMP_MAX && dur > 0 && dur <= 10000) {
            ESP_LOGI(TAG, "Manual pump run: %d for %lu ms", pump, dur);
            pump_controller_run(pump, dur);
        }
    }
}
```

### 3. **Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ `reset_stats`**

#### âœ… **ÐÐ¾Ð²Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ:**
```c
void ph_manager_handle_reset_stats_command(void) {
    pump_controller_reset_stats(PUMP_PH_UP);
    pump_controller_reset_stats(PUMP_PH_DOWN);
    ESP_LOGI(TAG, "Pump stats reset");
}
```

### 4. **Ð’Ñ‹Ð´ÐµÐ»ÐµÐ½Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ `run_pump_manual`**

#### ðŸ› **ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:**
ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° `run_pump_manual` Ð±Ñ‹Ð»Ð° Ð¾Ñ‡ÐµÐ½ÑŒ Ð´Ð»Ð¸Ð½Ð½Ð¾Ð¹ (~50 ÑÑ‚Ñ€Ð¾Ðº) Ð¸ ÑÐ¼ÐµÑˆÐ¸Ð²Ð°Ð»Ð°ÑÑŒ Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐ¾Ð¹.

#### âœ… **Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:**
```c
// Ð¡Ð¢ÐÐ›Ðž (Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾):
else if (strcmp(command, "run_pump_manual") == 0) {
    ph_manager_handle_manual_pump_command(params);
}
```

**ÐÐ¾Ð²Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ:**
```c
void ph_manager_handle_manual_pump_command(cJSON *params) {
    ESP_LOGI(TAG, "=== RUN PUMP MANUAL COMMAND ===");
    
    // Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð¾Ðº Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
    if (s_emergency_mode) {
        ESP_LOGW(TAG, "Manual pump blocked: EMERGENCY mode active");
        return;
    }
    // ... Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°
}
```

## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹

### Ð”Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹:
- âŒ ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° `reset_stats` Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ»Ð°ÑÑŒ Ð´Ð»Ñ `run_pump`
- âŒ ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²
- âŒ Ð¡Ð¼ÐµÑˆÐ°Ð½Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
- âŒ Ð”Ð»Ð¸Ð½Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐµ

### ÐŸÐ¾ÑÐ»Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹:
- âœ… ÐšÐ°Ð¶Ð´Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾
- âœ… ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²
- âœ… Ð§ÐµÑ‚ÐºÐ¾Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸
- âœ… ÐšÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ð°Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ

## ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð±Ð°Ð³Ð¸

### âœ… **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ðµ Ð°ÑÐ¿ÐµÐºÑ‚Ñ‹:**
1. **Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²** - Ð²ÑÐµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑŽÑ‚ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
2. **ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° NULL** - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½Ð° NULL ÑƒÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸
3. **Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ** - Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
4. **ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº** - graceful handling Ð¾ÑˆÐ¸Ð±Ð¾Ðº
5. **ÐžÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸** - Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ JSON

### âœ… **Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ Ð² Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»:**
```c
void ph_manager_handle_reset_stats_command(void);
void ph_manager_handle_manual_pump_command(cJSON *params);
```

## ðŸŽ¯ Ð˜Ñ‚Ð¾Ð³

Ð’ÑÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð±Ð°Ð³Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹:
- âœ… Ð›Ð¾Ð³Ð¸ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð°
- âœ… Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ñ‹ Ð¿Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸
- âœ… ÐšÐ¾Ð´ ÑÑ‚Ð°Ð» Ð±Ð¾Ð»ÐµÐµ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ð¼
- âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ

ÐšÐ¾Ð´ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ! ðŸš€
