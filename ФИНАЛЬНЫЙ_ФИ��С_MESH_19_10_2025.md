# üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –§–ò–ö–° MESH –°–ï–¢–ò - 19.10.2025

**–í—Ä–µ–º—è:** 13:15  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –§–ò–ù–ê–õ–¨–ù–û–ú–£ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

---

## üî¥ –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:

### –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ1: NODE –≥–æ–ª–æ—Å—É–µ—Ç –∑–∞ ROOT
**–°–∏–º–ø—Ç–æ–º:**
```
I (5965) mesh: vote myself, router rssi:-46
W (12407) mesh_manager: Node is currently root (voting), cannot send to parent
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- `MESH_NETWORK_CHANNEL = 0` (–∞–≤—Ç–æ–≤—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞)
- NODE –Ω–µ –≤–∏–¥–µ–ª mesh AP –æ—Ç ROOT –Ω–∞ —Ç–æ–º –∂–µ –∫–∞–Ω–∞–ª–µ
- NODE –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è –∫ —Ä–æ—É—Ç–µ—Ä—É –Ω–∞–ø—Ä—è–º—É—é –∏ –Ω–∞—á–∏–Ω–∞–ª –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª: `MESH_NETWORK_CHANNEL = 7`
- ‚úÖ –ö–∞–Ω–∞–ª —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–∞–Ω–∞–ª–æ–º —Ä–æ—É—Ç–µ—Ä–∞ "Yorick"

---

### –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–æ–≤ API
**–°–∏–º–ø—Ç–æ–º:**
```
ESP_ERR_MESH_NOT_ALLOWED at esp_mesh_set_max_layer(6)
ESP_ERR_MESH_ARGUMENT at esp_mesh_set_vote_percentage(0.0f)
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –í—ã–∑–æ–≤—ã `esp_mesh_set_max_layer()` –∏ `esp_mesh_set_vote_percentage()` **–ü–û–°–õ–ï** `esp_mesh_start()`
- ESP-MESH API —Ç—Ä–µ–±—É–µ—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ **–î–û** –∑–∞–ø—É—Å–∫–∞ mesh

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ `mesh_manager_init()` **–î–û** `esp_mesh_start()`
- ‚úÖ –ü–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É –ø—Ä–∏–º–µ—Ä—É ESP-IDF

---

## üìù –í–ù–ï–°–Å–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:

### 1Ô∏è‚É£ `common/mesh_config/mesh_config.h`

**–ë–´–õ–û:**
```c
#define MESH_NETWORK_CHANNEL    0  // –ê–≤—Ç–æ–≤—ã–±–æ—Ä
```

**–°–¢–ê–õ–û:**
```c
#define MESH_NETWORK_CHANNEL    7  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–∫–∞–∫ —É —Ä–æ—É—Ç–µ—Ä–∞)
```

---

### 2Ô∏è‚É£ `common/mesh_manager/mesh_manager.c`

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ A: –ü–µ—Ä–µ–Ω–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ `mesh_manager_init()`

**–ë–´–õ–û:**
```c
esp_err_t mesh_manager_init(const mesh_manager_config_t *config) {
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
    ESP_ERROR_CHECK(esp_mesh_init());
    ESP_ERROR_CHECK(esp_event_handler_register(MESH_EVENT, ...));
    
    ESP_LOGI(TAG, "Mesh manager initialized");
    return ESP_OK;
}
```

**–°–¢–ê–õ–û:**
```c
esp_err_t mesh_manager_init(const mesh_manager_config_t *config) {
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
    ESP_ERROR_CHECK(esp_mesh_init());
    ESP_ERROR_CHECK(esp_event_handler_register(MESH_EVENT, ...));
    
    // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –î–û esp_mesh_start()!
    ESP_ERROR_CHECK(esp_mesh_set_max_layer(6));
    ESP_LOGI(TAG, "Max mesh layers set to 6");
    
    ESP_ERROR_CHECK(esp_mesh_set_vote_percentage(1));
    ESP_ERROR_CHECK(esp_mesh_set_ap_assoc_expire(10));
    
    ESP_LOGI(TAG, "Mesh manager initialized");
    return ESP_OK;
}
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ B: –£–ø—Ä–æ—â–µ–Ω–∏–µ `mesh_manager_start()`

**–ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```c
esp_mesh_start();

// ‚ùå –ü–æ–ø—ã—Ç–∫–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Å–ª–µ start():
if (s_config.mode == MESH_MODE_NODE) {
    esp_mesh_set_vote_percentage(0.0f);     // ‚Üê –û—à–∏–±–∫–∞!
    esp_mesh_set_max_layer(6);              // ‚Üê –û—à–∏–±–∫–∞!
    esp_mesh_set_self_organized(false, *);  // ‚Üê –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–∏—Å–∫ parent!
}
```

**–°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```c
// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
esp_mesh_set_config(&cfg);

// ‚úÖ NODE: –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫!
// ROOT –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ esp_mesh_fix_root(true)
// Self-organizing –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

esp_mesh_start();
```

---

## üîó –ü–û–õ–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò

### üü¢ ROOT NODE:

```
1. mesh_manager_init():
   ‚îú‚îÄ esp_netif_init()
   ‚îú‚îÄ esp_wifi_init() + start()
   ‚îú‚îÄ esp_mesh_init()
   ‚îú‚îÄ esp_mesh_set_max_layer(6)         ‚Üê –î–û start()
   ‚îú‚îÄ esp_mesh_set_vote_percentage(1)   ‚Üê –î–û start()
   ‚îî‚îÄ esp_mesh_set_ap_assoc_expire(10)  ‚Üê –î–û start()

2. mesh_manager_start():
   ‚îú‚îÄ esp_mesh_set_type(MESH_ROOT)      ‚Üê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∏–ø–∞ ROOT
   ‚îú‚îÄ esp_mesh_fix_root(true)           ‚Üê –§–∏–∫—Å–∞—Ü–∏—è ROOT
   ‚îú‚îÄ esp_mesh_set_config(&cfg)         ‚Üê Router + Mesh AP config
   ‚îî‚îÄ esp_mesh_start()                  ‚Üê –ó–ê–ü–£–°–ö

3. Mesh Events:
   ‚îú‚îÄ MESH_EVENT_PARENT_CONNECTED ‚Üí Start DHCP client
   ‚îî‚îÄ IP_EVENT_STA_GOT_IP ‚Üí ROOT –ø–æ–ª—É—á–∏–ª IP –æ—Ç —Ä–æ—É—Ç–µ—Ä–∞

4. app_main.c:
   ‚îú‚îÄ –û–∂–∏–¥–∞–Ω–∏–µ IP (–¥–æ 30 —Å–µ–∫)
   ‚îú‚îÄ MQTT init
   ‚îú‚îÄ Data Router init
   ‚îî‚îÄ Climate Logic init
```

### üîµ NODE CLIMATE:

```
1. mesh_manager_init():
   ‚îú‚îÄ esp_netif_init()
   ‚îú‚îÄ esp_wifi_init() + start()
   ‚îú‚îÄ esp_mesh_init()
   ‚îú‚îÄ esp_mesh_set_max_layer(6)         ‚Üê –î–û start()
   ‚îú‚îÄ esp_mesh_set_vote_percentage(1)   ‚Üê –î–û start() (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ NODE)
   ‚îî‚îÄ esp_mesh_set_ap_assoc_expire(10)  ‚Üê –î–û start()

2. mesh_manager_start():
   ‚îú‚îÄ esp_mesh_set_config(&cfg)         ‚Üê Router + Mesh AP config (–ë–ï–ó set_type!)
   ‚îî‚îÄ esp_mesh_start()                  ‚Üê –ó–ê–ü–£–°–ö

3. Mesh Events:
   ‚îî‚îÄ MESH_EVENT_PARENT_CONNECTED ‚Üí NODE –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ ROOT mesh AP

4. app_main.c:
   ‚îú‚îÄ Climate Controller init
   ‚îî‚îÄ Start sending telemetry
```

---

## ‚úÖ –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –û–§–ò–¶–ò–ê–õ–¨–ù–û–ú–£ –ü–†–ò–ú–ï–†–£

| –ü–∞—Ä–∞–º–µ—Ç—Ä | ESP-IDF Example | –ù–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|----------|-----------------|-----------------|--------|
| **–ü–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–æ–≤** | init ‚Üí –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí config ‚Üí start | ‚úÖ –ò–¥–µ–Ω—Ç–∏—á–Ω–æ | ‚úÖ OK |
| **esp_mesh_set_max_layer()** | –î–û start() | ‚úÖ –î–û start() | ‚úÖ OK |
| **esp_mesh_set_vote_percentage()** | –î–û start() | ‚úÖ –î–û start() | ‚úÖ OK |
| **esp_mesh_set_config()** | –ü–µ—Ä–µ–¥ start() | ‚úÖ –ü–µ—Ä–µ–¥ start() | ‚úÖ OK |
| **Fixed channel** | CONFIG_MESH_CHANNEL | ‚úÖ MESH_NETWORK_CHANNEL=7 | ‚úÖ OK |
| **Router credentials** | –î–ª—è –≤—Å–µ—Ö —É–∑–ª–æ–≤ | ‚úÖ –î–ª—è –≤—Å–µ—Ö —É–∑–ª–æ–≤ | ‚úÖ OK |
| **ROOT —Ñ–∏–∫—Å–∞—Ü–∏—è** | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | ‚úÖ esp_mesh_fix_root(true) | ‚úÖ OK (—É–ª—É—á—à–µ–Ω–∏–µ) |
| **DHCP –¥–ª—è ROOT** | –í PARENT_CONNECTED | ‚úÖ –í PARENT_CONNECTED | ‚úÖ OK |

---

## üöÄ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ!

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. ‚úÖ –ü–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã –æ–±–∞ —É–∑–ª–∞ —Å channel=7
2. ‚è≥ –ü—Ä–æ—à–∏—Ç—å ROOT (COM7) - –ü–ï–†–í–´–ú
3. ‚è≥ –ü–æ–¥–æ–∂–¥–∞—Ç—å 15-20 —Å–µ–∫—É–Ω–¥
4. ‚è≥ –ü—Ä–æ—à–∏—Ç—å NODE (COM10) - –í–¢–û–†–´–ú
5. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ NODE –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ ROOT mesh AP

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –õ–û–ì–ò:

### ROOT (COM7):
```
I (XXX) mesh_manager: Max mesh layers set to 6
I (XXX) mesh_manager: ROOT mode: connecting to router 'Yorick'
I (XXX) mesh_manager: ‚úì ROOT GOT IP: 192.168.1.xxx
I (XXX) mqtt_manager: MQTT connected to broker
I (XXX) ROOT: Mesh nodes: 2 (total), 1 (online)  ‚Üê –í–ò–î–ò–¢ NODE!
```

### NODE (COM10):
```
I (XXX) mesh_manager: Max mesh layers set to 6
I (XXX) mesh_manager: NODE mode: will connect to mesh AP 'HYDRO1'
I (XXX) mesh_manager: ‚úì MESH Parent connected!
I (XXX) mesh_manager:   Layer: 2
I (XXX) climate_ctrl: ‚úì Heartbeat sent successfully
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- ‚ùå "vote myself"
- ‚ùå "connected with Yorick" (NODE –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ —Ä–æ—É—Ç–µ—Ä—É!)
- ‚ùå "Node is currently root (voting)"

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–í–µ—Ä—Å–∏—è:** v2.1 (–§–∏–Ω–∞–ª—å–Ω–∞—è)  
**–°—Ç–∞—Ç—É—Å:** üü¢ –ì–û–¢–û–í–û –ö –ü–†–û–®–ò–í–ö–ï

