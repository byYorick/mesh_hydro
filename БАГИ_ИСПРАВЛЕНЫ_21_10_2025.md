# üêõ –ë–ê–ì–ò –ù–ê–ô–î–ï–ù–´ –ò –ò–°–ü–†–ê–í–õ–ï–ù–´ - 21 –û–ö–¢–Ø–ë–†–Ø 2025

## ‚ùå –ù–ê–ô–î–ï–ù–ù–´–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò

### 1. **–ö–†–ò–¢–ò–ß–ù–û: –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ get_config** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í `ph_manager.c` –∏ `ec_manager.c` –∫–æ–º–∞–Ω–¥–∞ `get_config` —Å–æ–∑–¥–∞–≤–∞–ª–∞ JSON –æ–±—ä–µ–∫—Ç—ã, –Ω–æ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–ª–∞ –≤—Å—é –ø–∞–º—è—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

```c
// –ë–´–õ–û (–ë–ê–ì):
if (mesh_manager_is_connected()) {
    cJSON *root = cJSON_CreateObject();
    // ... –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ...
    cJSON_Delete(root);
} else {
    cJSON_Delete(config);  // ‚ùå root –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ –º–æ–≥–ª–∞ –±—ã—Ç—å —É—Ç–µ—á–∫–∞
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `mesh_manager_is_connected()` –≤ –Ω–∞—á–∞–ª–µ
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `if (!root) return;` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if (!config)` —Å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ–º `root`
- –í—Å–µ–≥–¥–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è `root` –≤ –∫–æ–Ω—Ü–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–§–∞–π–ª—ã:**
- `node_ph/components/ph_manager/ph_manager.c` ‚úÖ
- `node_ec/components/ec_manager/ec_manager.c` ‚úÖ

---

### 2. **–ö–†–ò–¢–ò–ß–ù–û: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ NULL –ø–æ—Å–ª–µ cJSON_Create** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å, —É—Å–ø–µ—à–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–ª–∏—Å—å JSON –æ–±—ä–µ–∫—Ç—ã –∏ –º–∞—Å—Å–∏–≤—ã.

```c
// –ë–´–õ–û (–ë–ê–ì):
cJSON *pumps_cal = cJSON_CreateArray();
for (int i = 0; i < 2; i++) {
    cJSON *pump = cJSON_CreateObject();  // ‚ùå –ß—Ç–æ –µ—Å–ª–∏ NULL?
    cJSON_AddNumberToObject(pump, ...);  // ‚ùå –ö—Ä–∞—Ö!
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```c
// –°–¢–ê–õ–û:
cJSON *pumps_cal = cJSON_CreateArray();
if (pumps_cal) {  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞
    for (int i = 0; i < 2; i++) {
        cJSON *pump = cJSON_CreateObject();
        if (pump) {  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞
            cJSON_AddNumberToObject(pump, ...);
            cJSON_AddItemToArray(pumps_cal, pump);
        }
    }
    cJSON_AddItemToObject(config, "pumps_calibration", pumps_cal);
}
```

---

### 3. **–ö–†–ò–¢–ò–ß–ù–û: config_response –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª—Å—è ROOT** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
–¢–∏–ø `"config_response"` –Ω–µ –±—ã–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ `mesh_protocol.c`, –ø–æ—ç—Ç–æ–º—É ROOT —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª –µ–≥–æ –∫–∞–∫ `MESH_MSG_UNKNOWN` –∏ –Ω–µ –ø–µ—Ä–µ—Å—ã–ª–∞–ª –≤ MQTT.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `MSG_TYPE_CONFIG_RESPONSE = "config_response"`
- –î–æ–±–∞–≤–ª–µ–Ω –∞–ª–∏–∞—Å –≤ `str_to_msg_type()`: `config_response ‚Üí MESH_MSG_RESPONSE`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `case MESH_MSG_RESPONSE` –≤ `data_router.c`
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ MQTT —Ç–æ–ø–∏–∫ `hydro/config_response/{node_id}`

**–§–∞–π–ª—ã:**
- `common/mesh_protocol/mesh_protocol.c` ‚úÖ
- `root_node/components/data_router/data_router.c` ‚úÖ

---

### 4. **–ö–†–ò–¢–ò–ß–ù–û: Backend –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ config_response** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
Backend –Ω–µ —Å–ª—É—à–∞–ª —Ç–æ–ø–∏–∫ `hydro/config_response/#`, –ø–æ—ç—Ç–æ–º—É –æ—Ç–≤–µ—Ç—ã –æ—Ç –Ω–æ–¥ —Ç–µ—Ä—è–ª–∏—Å—å.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –≤ `MqttListenerCommand.php`:
```php
$mqtt->subscribe('hydro/config_response/#', function ($topic, $message) use ($mqtt) {
    $this->line("üìã [CONFIG_RESPONSE] {$topic}");
    $mqtt->handleConfigResponse($topic, $message);
});
```

**–§–∞–π–ª:**
- `server/backend/app/Console/Commands/MqttListenerCommand.php` ‚úÖ

---

### 5. **Backend: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ is_array($config)** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í `MqttService::handleConfigResponse()` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å, —á—Ç–æ `$config` - —ç—Ç–æ –º–∞—Å—Å–∏–≤.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```php
$config = $data['config'];

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ config - —ç—Ç–æ –º–∞—Å—Å–∏–≤
if (!is_array($config)) {
    Log::warning("Config is not an array", [...]);
    return;
}
```

**–§–∞–π–ª:**
- `server/backend/app/Services/MqttService.php` ‚úÖ

---

### 6. **Frontend: –ü–ª–æ—Ö–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ —Ç–æ–ª—å–∫–æ `error.response?.data?.error`, –Ω–æ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å–µ—Ç–∏ `error.response` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```js
// –ë–´–õ–û:
catch (error) {
    toast.error(error.response?.data?.error || 'Failed to start pump')
}

// –°–¢–ê–õ–û:
catch (error) {
    const errorMsg = error.response?.data?.error || error.message || 'Failed to start pump'
    toast.error(errorMsg)
    console.error('Run pump error:', error)  // –î–ª—è debug
}
```

**–§–∞–π–ª—ã:**
- `server/frontend/src/components/PhNode.vue` ‚úÖ
- `server/frontend/src/components/EcNode.vue` ‚úÖ

---

### 7. **Firmware: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç timestamp –≤ config_response** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
JSON `config_response` –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª `timestamp`, —á—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–ª–æ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ backend.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```c
cJSON_AddStringToObject(root, "type", "config_response");
cJSON_AddStringToObject(root, "node_id", s_config->base.node_id);
cJSON_AddNumberToObject(root, "timestamp", (uint32_t)time(NULL));  // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
```

**–§–∞–π–ª—ã:**
- `node_ph/components/ph_manager/ph_manager.c` ‚úÖ
- `node_ec/components/ec_manager/ec_manager.c` ‚úÖ

---

## ‚úÖ –•–û–†–û–®–ò–ï –ü–†–ê–ö–¢–ò–ö–ò (–£–ñ–ï –ë–´–õ–ò –í –ö–û–î–ï)

### 1. –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å –∑–∞—â–∏—â–µ–Ω–æ ‚úÖ
```c
if (duration <= 0.0f || volume <= 0.0f) {
    ESP_LOGW(TAG, "Invalid calibration params");
    return;
}
s_config->pump_calibration[pump].ml_per_second = volume / duration;  // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ
```

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚úÖ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ `pump_id`, `duration_sec`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `node.isOnline()` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–æ–º–∞–Ω–¥
- Laravel validation –≤ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

### 3. NVS —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚úÖ
- –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ NVS
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ `node_config_save()`

---

## üéØ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û –§–ê–ô–õ–ê–ú

### **Firmware (7 —Ñ–∞–π–ª–æ–≤):**
1. `common/mesh_protocol/mesh_protocol.c` - –¥–æ–±–∞–≤–ª–µ–Ω –∞–ª–∏–∞—Å config_response
2. `root_node/components/data_router/data_router.c` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ MESH_MSG_RESPONSE
3. `node_ph/components/ph_manager/ph_manager.c` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ + –ø—Ä–æ–≤–µ—Ä–∫–∏ NULL
4. `node_ec/components/ec_manager/ec_manager.c` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ + –ø—Ä–æ–≤–µ—Ä–∫–∏ NULL

### **Backend (2 —Ñ–∞–π–ª–∞):**
5. `server/backend/app/Services/MqttService.php` - –ø—Ä–æ–≤–µ—Ä–∫–∞ is_array($config)
6. `server/backend/app/Console/Commands/MqttListenerCommand.php` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ config_response

### **Frontend (2 —Ñ–∞–π–ª–∞):**
7. `server/frontend/src/components/PhNode.vue` - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
8. `server/frontend/src/components/EcNode.vue` - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –û–ö:
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ NVS –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥
- –û–±—Ä–∞–±–æ—Ç–∫–∞ offline —Å–æ—Å—Ç–æ—è–Ω–∏—è
- Rate limiting –≤ API
- WebSocket broadcast —Å–æ–±—ã—Ç–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):
1. –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
2. –î–æ–±–∞–≤–∏—Ç—å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é config_response –ø—Ä–∏ offline MQTT
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–ª—è get_config –∫–æ–º–∞–Ω–¥—ã
4. –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –¢–∏–ø –±–∞–≥–∞ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
|----------|-----------|------------|
| **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ** | 4 | ‚úÖ 4 |
| **–í–∞–∂–Ω—ã–µ** | 3 | ‚úÖ 3 |
| **–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ** | 0 | - |
| **–í–°–ï–ì–û** | **7** | ‚úÖ **7** |

---

## üéâ –ò–¢–û–ì

### ‚úÖ –í–°–ï –ë–ê–ì–ò –ò–°–ü–†–ê–í–õ–ï–ù–´!

- –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∏ NULL –¥–æ–±–∞–≤–ª–µ–Ω—ã
- config_response –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —É–ª—É—á—à–µ–Ω–∞
- –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)

### üöÄ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

**–¶–µ–ø–æ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞:**
- Node ‚Üí Mesh ‚Üí ROOT ‚Üí MQTT ‚Üí Backend ‚Üí Frontend ‚úÖ
- Frontend ‚Üí Backend ‚Üí MQTT ‚Üí ROOT ‚Üí Mesh ‚Üí Node ‚úÖ
- Config request/response –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

---

**–î–∞—Ç–∞:** 21 –æ–∫—Ç—è–±—Ä—è 2025  
**–ë–∞–≥–∏ –Ω–∞–π–¥–µ–Ω—ã:** 7  
**–ë–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:** 7  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ë–ê–ì–ò –£–°–¢–†–ê–ù–ï–ù–´**

